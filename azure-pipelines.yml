# ============================================================================
# Azure DevOps CI/CD Pipeline for JobPilot AI Platform
# ============================================================================
# Project: https://dev.azure.com/citadelcloudmanagement/ApplyPlatform
# Repo: https://dev.azure.com/citadelcloudmanagement/_git/ApplyPlatform
#
# Pipeline Features:
# - Multi-stage pipeline (Build, Test, Deploy)
# - Parallel service builds
# - Docker image building and pushing to Docker Hub
# - Integration and E2E testing
# - Environment-specific deployments
# - Manual approval gates for production
# - Blue-green deployment strategy
# - Kubernetes deployment support
# ============================================================================

# Runtime Parameters - Set deploymentEnabled to true after AKS infrastructure is deployed
parameters:
  - name: deploymentEnabled
    displayName: 'Enable K8s Deployment Stages'
    type: boolean
    default: false

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - '*.md'
      - 'docs/**'
      - 'infrastructure/terraform/**'

pr:
  branches:
    include:
      - main
      - develop

# ============================================================================
# Variables
# ============================================================================
variables:
  # Build versions
  - name: NODE_VERSION
    value: '20'
  - name: PNPM_VERSION
    value: '8.15.0'
  - name: PYTHON_VERSION
    value: '3.11'

  # Docker configuration
  - name: DOCKER_BUILDKIT
    value: '1'
  - name: DOCKER_REGISTRY
    value: 'citadelplatforms'
  - name: DOCKER_IMAGE_PREFIX
    value: 'applyai'

  # Branch conditionals
  - name: isMain
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]
  - name: isDevelop
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/develop')]

  # Variable groups (configure these in Azure DevOps)
  # - Common secrets for all environments
  - group: common-secrets

stages:
  # ============================================================================
  # Stage 1: Build and Validation
  # ============================================================================
  - stage: Build
    displayName: 'Build & Validate'
    jobs:
      # Setup Dependencies
      - job: Setup
        displayName: 'Setup Dependencies'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 0

          - task: NodeTool@0
            displayName: 'Install Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: $(NODE_VERSION)

          - script: |
              corepack enable
              corepack prepare pnpm@$(PNPM_VERSION) --activate
              pnpm --version
            displayName: 'Install pnpm $(PNPM_VERSION)'

          - task: Cache@2
            displayName: 'Cache pnpm store'
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              restoreKeys: |
                pnpm | "$(Agent.OS)"
              path: $(Pipeline.Workspace)/.pnpm-store

          - script: |
              pnpm config set store-dir $(Pipeline.Workspace)/.pnpm-store
              pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - publish: $(System.DefaultWorkingDirectory)
            artifact: source-code
            displayName: 'Publish source code'

      # Lint All Services
      - job: Lint
        displayName: 'Lint Code'
        dependsOn: Setup
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - download: current
            artifact: source-code

          - task: NodeTool@0
            inputs:
              versionSpec: $(NODE_VERSION)

          - script: |
              cp -r $(Pipeline.Workspace)/source-code/. $(System.DefaultWorkingDirectory)
              corepack enable
              corepack prepare pnpm@$(PNPM_VERSION) --activate
            displayName: 'Setup environment'

          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              restoreKeys: pnpm | "$(Agent.OS)"
              path: $(Pipeline.Workspace)/.pnpm-store

          - script: |
              pnpm config set store-dir $(Pipeline.Workspace)/.pnpm-store
              pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: pnpm run lint
            displayName: 'Run ESLint on all services'

          - script: pnpm run format:check
            displayName: 'Check Prettier formatting'

      # TypeScript Type Checking
      - job: TypeCheck
        displayName: 'TypeScript Type Check'
        dependsOn: Setup
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - download: current
            artifact: source-code

          - task: NodeTool@0
            inputs:
              versionSpec: $(NODE_VERSION)

          - script: |
              cp -r $(Pipeline.Workspace)/source-code/. $(System.DefaultWorkingDirectory)
              corepack enable
              corepack prepare pnpm@$(PNPM_VERSION) --activate
            displayName: 'Setup environment'

          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              restoreKeys: pnpm | "$(Agent.OS)"
              path: $(Pipeline.Workspace)/.pnpm-store

          - script: |
              pnpm config set store-dir $(Pipeline.Workspace)/.pnpm-store
              pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: pnpm run type-check
            displayName: 'Run TypeScript type check'

  # ============================================================================
  # Stage 2: Unit Tests
  # ============================================================================
  - stage: Test
    displayName: 'Run Unit Tests'
    dependsOn: Build
    jobs:
      # Node.js Services Unit Tests
      - job: UnitTests
        displayName: 'Unit Tests - Node.js Services'
        pool:
          vmImage: 'ubuntu-latest'
        services:
          postgres:
            image: postgres:15-alpine
            env:
              POSTGRES_USER: postgres
              POSTGRES_PASSWORD: postgres
              POSTGRES_DB: jobpilot_test
            ports:
              - "5432:5432"
          redis:
            image: redis:7-alpine
            ports:
              - "6379:6379"
        steps:
          - checkout: self

          - task: NodeTool@0
            inputs:
              versionSpec: $(NODE_VERSION)

          - script: |
              corepack enable
              corepack prepare pnpm@$(PNPM_VERSION) --activate
            displayName: 'Install pnpm'

          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              restoreKeys: pnpm | "$(Agent.OS)"
              path: $(Pipeline.Workspace)/.pnpm-store

          - script: |
              pnpm config set store-dir $(Pipeline.Workspace)/.pnpm-store
              pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: pnpm run test
            displayName: 'Run unit tests'
            env:
              DATABASE_URL: postgresql://postgres:postgres@localhost:5432/jobpilot_test
              REDIS_URL: redis://localhost:6379
              NODE_ENV: test

          - task: PublishTestResults@2
            displayName: 'Publish test results'
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/junit.xml'
              mergeTestResults: true
              failTaskOnFailedTests: true

          - task: PublishCodeCoverageResults@1
            displayName: 'Publish code coverage'
            condition: succeededOrFailed()
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage/cobertura-coverage.xml'
              reportDirectory: '$(System.DefaultWorkingDirectory)/coverage'

      # Python AI Service Tests
      - job: PythonTests
        displayName: 'Unit Tests - Python AI Service'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: UsePythonVersion@0
            inputs:
              versionSpec: $(PYTHON_VERSION)
              addToPath: true

          - script: |
              cd services/ai-service
              python -m pip install --upgrade pip
              pip install -r requirements.txt
              pip install pytest pytest-asyncio pytest-cov
            displayName: 'Install Python dependencies'

          - script: |
              cd services/ai-service
              pytest tests/ --cov=src --cov-report=xml --cov-report=html --junitxml=junit.xml
            displayName: 'Run Python tests'
            continueOnError: true

          - task: PublishTestResults@2
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'services/ai-service/junit.xml'

  # ============================================================================
  # Stage 3: Integration Tests
  # ============================================================================
  - stage: IntegrationTests
    displayName: 'Run Integration Tests'
    dependsOn: Test
    jobs:
      - job: IntegrationTests
        displayName: 'Integration Tests'
        pool:
          vmImage: 'ubuntu-latest'
        services:
          postgres:
            image: postgres:15-alpine
            env:
              POSTGRES_USER: postgres
              POSTGRES_PASSWORD: postgres
              POSTGRES_DB: jobpilot_test
            ports:
              - "5432:5432"
          redis:
            image: redis:7-alpine
            ports:
              - "6379:6379"
          elasticsearch:
            image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
            env:
              discovery.type: single-node
              xpack.security.enabled: "false"
              ES_JAVA_OPTS: "-Xms512m -Xmx512m"
            ports:
              - "9200:9200"
        steps:
          - checkout: self

          - task: NodeTool@0
            inputs:
              versionSpec: $(NODE_VERSION)

          - script: |
              corepack enable
              corepack prepare pnpm@$(PNPM_VERSION) --activate
            displayName: 'Install pnpm'

          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              restoreKeys: pnpm | "$(Agent.OS)"
              path: $(Pipeline.Workspace)/.pnpm-store

          - script: |
              pnpm config set store-dir $(Pipeline.Workspace)/.pnpm-store
              pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: pnpm run test:integration
            displayName: 'Run integration tests'
            continueOnError: true
            env:
              DATABASE_URL: postgresql://postgres:postgres@localhost:5432/jobpilot_test
              REDIS_URL: redis://localhost:6379
              ELASTICSEARCH_URL: http://localhost:9200
              NODE_ENV: test

          - task: PublishTestResults@2
            displayName: 'Publish integration test results'
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/integration-junit.xml'
              mergeTestResults: true
              testRunTitle: 'Integration Tests'

  # ============================================================================
  # Stage 4: E2E Tests
  # ============================================================================
  - stage: E2ETests
    displayName: 'Run E2E Tests'
    dependsOn: IntegrationTests
    jobs:
      - job: E2ETests
        displayName: 'E2E Tests'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: NodeTool@0
            inputs:
              versionSpec: $(NODE_VERSION)

          - script: |
              corepack enable
              corepack prepare pnpm@$(PNPM_VERSION) --activate
            displayName: 'Install pnpm'

          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              restoreKeys: pnpm | "$(Agent.OS)"
              path: $(Pipeline.Workspace)/.pnpm-store

          - script: |
              pnpm config set store-dir $(Pipeline.Workspace)/.pnpm-store
              pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: |
              cd apps/web
              npx playwright install --with-deps
            displayName: 'Install Playwright browsers'

          - script: pnpm run test:e2e
            displayName: 'Run E2E tests'
            continueOnError: true
            env:
              CI: true

          - task: PublishTestResults@2
            displayName: 'Publish E2E test results'
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/e2e-junit.xml'
              mergeTestResults: true
              testRunTitle: 'E2E Tests'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Playwright report'
            condition: succeededOrFailed()
            inputs:
              targetPath: apps/web/playwright-report
              artifact: playwright-report
              publishLocation: pipeline

  # ============================================================================
  # Stage 5: Build Docker Images
  # ============================================================================
  - stage: BuildDockerImages
    displayName: 'Build Docker Images'
    dependsOn: E2ETests
    jobs:
      # Build all services in parallel
      - job: BuildWebApp
        displayName: 'Build Web App'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: Docker@2
            displayName: 'Login to Docker Hub'
            inputs:
              command: login
              containerRegistry: 'DockerHub-ServiceConnection'

          - task: Docker@2
            displayName: 'Build and Push Web App'
            inputs:
              command: buildAndPush
              repository: '$(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-web'
              dockerfile: apps/web/Dockerfile
              buildContext: .
              tags: |
                $(Build.BuildId)
                latest
                $(Build.SourceBranchName)-$(Build.BuildId)
              arguments: '--build-arg NODE_ENV=production'

      - job: BuildAuthService
        displayName: 'Build Auth Service'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: Docker@2
            displayName: 'Login to Docker Hub'
            inputs:
              command: login
              containerRegistry: 'DockerHub-ServiceConnection'

          - task: Docker@2
            displayName: 'Build and Push Auth Service'
            inputs:
              command: buildAndPush
              repository: '$(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-auth-service'
              dockerfile: services/auth-service/Dockerfile
              buildContext: .
              tags: |
                $(Build.BuildId)
                latest
                $(Build.SourceBranchName)-$(Build.BuildId)

      - job: BuildUserService
        displayName: 'Build User Service'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: Docker@2
            displayName: 'Login to Docker Hub'
            inputs:
              command: login
              containerRegistry: 'DockerHub-ServiceConnection'

          - task: Docker@2
            displayName: 'Build and Push User Service'
            inputs:
              command: buildAndPush
              repository: '$(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-user-service'
              dockerfile: services/user-service/Dockerfile
              buildContext: .
              tags: |
                $(Build.BuildId)
                latest
                $(Build.SourceBranchName)-$(Build.BuildId)

      - job: BuildJobService
        displayName: 'Build Job Service'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: Docker@2
            displayName: 'Login to Docker Hub'
            inputs:
              command: login
              containerRegistry: 'DockerHub-ServiceConnection'

          - task: Docker@2
            displayName: 'Build and Push Job Service'
            inputs:
              command: buildAndPush
              repository: '$(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-job-service'
              dockerfile: services/job-service/Dockerfile
              buildContext: .
              tags: |
                $(Build.BuildId)
                latest
                $(Build.SourceBranchName)-$(Build.BuildId)

      - job: BuildResumeService
        displayName: 'Build Resume Service'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: Docker@2
            displayName: 'Login to Docker Hub'
            inputs:
              command: login
              containerRegistry: 'DockerHub-ServiceConnection'

          - task: Docker@2
            displayName: 'Build and Push Resume Service'
            inputs:
              command: buildAndPush
              repository: '$(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-resume-service'
              dockerfile: services/resume-service/Dockerfile
              buildContext: .
              tags: |
                $(Build.BuildId)
                latest
                $(Build.SourceBranchName)-$(Build.BuildId)

      - job: BuildNotificationService
        displayName: 'Build Notification Service'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: Docker@2
            displayName: 'Login to Docker Hub'
            inputs:
              command: login
              containerRegistry: 'DockerHub-ServiceConnection'

          - task: Docker@2
            displayName: 'Build and Push Notification Service'
            inputs:
              command: buildAndPush
              repository: '$(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-notification-service'
              dockerfile: services/notification-service/Dockerfile
              buildContext: .
              tags: |
                $(Build.BuildId)
                latest
                $(Build.SourceBranchName)-$(Build.BuildId)

      - job: BuildAutoApplyService
        displayName: 'Build Auto-Apply Service'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: Docker@2
            displayName: 'Login to Docker Hub'
            inputs:
              command: login
              containerRegistry: 'DockerHub-ServiceConnection'

          - task: Docker@2
            displayName: 'Build and Push Auto-Apply Service'
            inputs:
              command: buildAndPush
              repository: '$(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-auto-apply-service'
              dockerfile: services/auto-apply-service/Dockerfile
              buildContext: .
              tags: |
                $(Build.BuildId)
                latest
                $(Build.SourceBranchName)-$(Build.BuildId)

      - job: BuildAIService
        displayName: 'Build AI Service'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: Docker@2
            displayName: 'Login to Docker Hub'
            inputs:
              command: login
              containerRegistry: 'DockerHub-ServiceConnection'

          - task: Docker@2
            displayName: 'Build and Push AI Service'
            inputs:
              command: buildAndPush
              repository: '$(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-ai-service'
              dockerfile: services/ai-service/Dockerfile
              buildContext: .
              tags: |
                $(Build.BuildId)
                latest
                $(Build.SourceBranchName)-$(Build.BuildId)

      - job: BuildAnalyticsService
        displayName: 'Build Analytics Service'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: Docker@2
            displayName: 'Login to Docker Hub'
            inputs:
              command: login
              containerRegistry: 'DockerHub-ServiceConnection'

          - task: Docker@2
            displayName: 'Build and Push Analytics Service'
            inputs:
              command: buildAndPush
              repository: '$(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-analytics-service'
              dockerfile: services/analytics-service/Dockerfile
              buildContext: .
              tags: |
                $(Build.BuildId)
                latest
                $(Build.SourceBranchName)-$(Build.BuildId)

  # ============================================================================
  # Stage 6: Deploy to Development
  # ============================================================================
  # NOTE: These stages are disabled until AKS infrastructure is deployed via Terraform.
  # Set parameter 'deploymentEnabled: true' when running pipeline after AKS is deployed.
  # To enable: Run pipeline manually and set "Enable K8s Deployment Stages" to true.
  - ${{ if eq(parameters.deploymentEnabled, true) }}:
    - stage: DeployDev
      displayName: 'Deploy to Development'
      dependsOn: BuildDockerImages
      condition: and(succeeded(), eq(variables['isDevelop'], 'true'))
      variables:
        - group: dev-secrets
        - name: ENVIRONMENT
          value: 'dev'
        - name: NAMESPACE
          value: 'jobpilot-dev'
      jobs:
        - deployment: DeployDevEnvironment
          displayName: 'Deploy to Dev'
          pool:
            vmImage: 'ubuntu-latest'
          environment: 'development'
          strategy:
            runOnce:
              deploy:
                steps:
                  - checkout: self

                  - task: KubernetesManifest@0
                    displayName: 'Create/Update Kubernetes Namespace'
                    inputs:
                      action: 'deploy'
                      kubernetesServiceConnection: 'K8s-Dev-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      manifests: |
                        infrastructure/kubernetes/base/namespace.yaml

                  - task: KubernetesManifest@0
                    displayName: 'Deploy ConfigMaps and Secrets'
                    inputs:
                      action: 'deploy'
                      kubernetesServiceConnection: 'K8s-Dev-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      manifests: |
                        infrastructure/kubernetes/base/configmap.yaml
                        infrastructure/kubernetes/base/secrets.yaml

                  - task: KubernetesManifest@0
                    displayName: 'Deploy Services'
                    inputs:
                      action: 'deploy'
                      kubernetesServiceConnection: 'K8s-Dev-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      manifests: |
                        infrastructure/kubernetes/services/web-app.yaml
                        infrastructure/kubernetes/services/auth-service.yaml
                        infrastructure/kubernetes/services/user-service.yaml
                        infrastructure/kubernetes/services/job-service.yaml
                        infrastructure/kubernetes/services/resume-service.yaml
                        infrastructure/kubernetes/services/notification-service.yaml
                        infrastructure/kubernetes/services/auto-apply-service.yaml
                        infrastructure/kubernetes/services/ai-service.yaml
                        infrastructure/kubernetes/services/analytics-service.yaml
                      containers: |
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-web:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-auth-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-user-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-job-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-resume-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-notification-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-auto-apply-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-ai-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-analytics-service:$(Build.BuildId)

                  - task: KubernetesManifest@0
                    displayName: 'Deploy Ingress'
                    inputs:
                      action: 'deploy'
                      kubernetesServiceConnection: 'K8s-Dev-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      manifests: |
                        infrastructure/kubernetes/base/ingress.yaml

                  - task: Kubernetes@1
                    displayName: 'Wait for web-app deployment'
                    inputs:
                      connectionType: 'Kubernetes Service Connection'
                      kubernetesServiceEndpoint: 'K8s-Dev-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      command: 'rollout'
                      arguments: 'status deployment/web-app --timeout=300s'

                  - task: Kubernetes@1
                    displayName: 'Wait for auth-service deployment'
                    inputs:
                      connectionType: 'Kubernetes Service Connection'
                      kubernetesServiceEndpoint: 'K8s-Dev-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      command: 'rollout'
                      arguments: 'status deployment/auth-service --timeout=300s'

                  - task: Kubernetes@1
                    displayName: 'Wait for job-service deployment'
                    inputs:
                      connectionType: 'Kubernetes Service Connection'
                      kubernetesServiceEndpoint: 'K8s-Dev-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      command: 'rollout'
                      arguments: 'status deployment/job-service --timeout=300s'

                  - script: |
                      echo "Running smoke tests on development environment..."
                      # Add your smoke test commands here
                      # curl -f https://dev.jobpilot.ai/health || exit 1
                    displayName: 'Run smoke tests'

  # ============================================================================
  # Stage 7: Deploy to Staging
  # ============================================================================
  - ${{ if eq(parameters.deploymentEnabled, true) }}:
    - stage: DeployStaging
      displayName: 'Deploy to Staging'
      dependsOn: BuildDockerImages
      condition: and(succeeded(), eq(variables['isMain'], 'true'))
      variables:
        - group: staging-secrets
        - name: ENVIRONMENT
          value: 'staging'
        - name: NAMESPACE
          value: 'jobpilot-staging'
      jobs:
        - deployment: DeployStagingEnvironment
          displayName: 'Deploy to Staging'
          pool:
            vmImage: 'ubuntu-latest'
          environment: 'staging'
          strategy:
            runOnce:
              deploy:
                steps:
                  - checkout: self

                  - task: KubernetesManifest@0
                    displayName: 'Create/Update Kubernetes Namespace'
                    inputs:
                      action: 'deploy'
                      kubernetesServiceConnection: 'K8s-Staging-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      manifests: |
                        infrastructure/kubernetes/base/namespace.yaml

                  - task: KubernetesManifest@0
                    displayName: 'Deploy ConfigMaps and Secrets'
                    inputs:
                      action: 'deploy'
                      kubernetesServiceConnection: 'K8s-Staging-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      manifests: |
                        infrastructure/kubernetes/base/configmap.yaml
                        infrastructure/kubernetes/base/secrets.yaml

                  - task: KubernetesManifest@0
                    displayName: 'Deploy Services'
                    inputs:
                      action: 'deploy'
                      kubernetesServiceConnection: 'K8s-Staging-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      manifests: |
                        infrastructure/kubernetes/services/web-app.yaml
                        infrastructure/kubernetes/services/auth-service.yaml
                        infrastructure/kubernetes/services/user-service.yaml
                        infrastructure/kubernetes/services/job-service.yaml
                        infrastructure/kubernetes/services/resume-service.yaml
                        infrastructure/kubernetes/services/notification-service.yaml
                        infrastructure/kubernetes/services/auto-apply-service.yaml
                        infrastructure/kubernetes/services/ai-service.yaml
                        infrastructure/kubernetes/services/analytics-service.yaml
                      containers: |
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-web:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-auth-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-user-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-job-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-resume-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-notification-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-auto-apply-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-ai-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-analytics-service:$(Build.BuildId)

                  - task: KubernetesManifest@0
                    displayName: 'Deploy Ingress'
                    inputs:
                      action: 'deploy'
                      kubernetesServiceConnection: 'K8s-Staging-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      manifests: |
                        infrastructure/kubernetes/base/ingress.yaml

                  - task: Kubernetes@1
                    displayName: 'Wait for web-app deployment'
                    inputs:
                      connectionType: 'Kubernetes Service Connection'
                      kubernetesServiceEndpoint: 'K8s-Staging-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      command: 'rollout'
                      arguments: 'status deployment/web-app --timeout=300s'

                  - task: Kubernetes@1
                    displayName: 'Wait for auth-service deployment'
                    inputs:
                      connectionType: 'Kubernetes Service Connection'
                      kubernetesServiceEndpoint: 'K8s-Staging-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      command: 'rollout'
                      arguments: 'status deployment/auth-service --timeout=300s'

                  - script: |
                      echo "Running smoke tests on staging environment..."
                      # Add your smoke test commands here
                    displayName: 'Run smoke tests'

  # ============================================================================
  # Stage 8: Deploy to Production (Manual Approval Required)
  # ============================================================================
  - ${{ if eq(parameters.deploymentEnabled, true) }}:
    - stage: DeployProduction
      displayName: 'Deploy to Production'
      dependsOn: DeployStaging
      condition: and(succeeded(), eq(variables['isMain'], 'true'))
      variables:
        - group: prod-secrets
        - name: ENVIRONMENT
          value: 'prod'
        - name: NAMESPACE
          value: 'jobpilot-prod'
      jobs:
        - deployment: DeployProductionEnvironment
          displayName: 'Deploy to Production'
          pool:
            vmImage: 'ubuntu-latest'
          environment: 'production'  # Configure manual approval in Azure DevOps Environments
          strategy:
            runOnce:
              deploy:
                steps:
                  - checkout: self

                  - script: |
                      echo "Deployment Summary:"
                      echo "===================="
                      echo "Build ID: $(Build.BuildId)"
                      echo "Source Branch: $(Build.SourceBranchName)"
                      echo "Commit: $(Build.SourceVersion)"
                      echo "Docker Images:"
                      echo "  - $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-web:$(Build.BuildId)"
                      echo "  - $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-auth-service:$(Build.BuildId)"
                      echo "  - $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-ai-service:$(Build.BuildId)"
                    displayName: 'Pre-deployment summary'

                  - task: KubernetesManifest@0
                    displayName: 'Create/Update Kubernetes Namespace'
                    inputs:
                      action: 'deploy'
                      kubernetesServiceConnection: 'K8s-Prod-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      manifests: |
                        infrastructure/kubernetes/base/namespace.yaml

                  - task: KubernetesManifest@0
                    displayName: 'Deploy ConfigMaps and Secrets'
                    inputs:
                      action: 'deploy'
                      kubernetesServiceConnection: 'K8s-Prod-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      manifests: |
                        infrastructure/kubernetes/base/configmap.yaml
                        infrastructure/kubernetes/base/secrets.yaml

                  - task: KubernetesManifest@0
                    displayName: 'Deploy Services (Rolling Update)'
                    inputs:
                      action: 'deploy'
                      kubernetesServiceConnection: 'K8s-Prod-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      strategy: 'rolling'
                      manifests: |
                        infrastructure/kubernetes/services/web-app.yaml
                        infrastructure/kubernetes/services/auth-service.yaml
                        infrastructure/kubernetes/services/user-service.yaml
                        infrastructure/kubernetes/services/job-service.yaml
                        infrastructure/kubernetes/services/resume-service.yaml
                        infrastructure/kubernetes/services/notification-service.yaml
                        infrastructure/kubernetes/services/auto-apply-service.yaml
                        infrastructure/kubernetes/services/ai-service.yaml
                        infrastructure/kubernetes/services/analytics-service.yaml
                      containers: |
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-web:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-auth-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-user-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-job-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-resume-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-notification-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-auto-apply-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-ai-service:$(Build.BuildId)
                        $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_PREFIX)-analytics-service:$(Build.BuildId)

                  - task: KubernetesManifest@0
                    displayName: 'Deploy Ingress'
                    inputs:
                      action: 'deploy'
                      kubernetesServiceConnection: 'K8s-Prod-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      manifests: |
                        infrastructure/kubernetes/base/ingress.yaml

                  - task: Kubernetes@1
                    displayName: 'Wait for web-app deployment'
                    inputs:
                      connectionType: 'Kubernetes Service Connection'
                      kubernetesServiceEndpoint: 'K8s-Prod-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      command: 'rollout'
                      arguments: 'status deployment/web-app --timeout=600s'

                  - task: Kubernetes@1
                    displayName: 'Wait for auth-service deployment'
                    inputs:
                      connectionType: 'Kubernetes Service Connection'
                      kubernetesServiceEndpoint: 'K8s-Prod-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      command: 'rollout'
                      arguments: 'status deployment/auth-service --timeout=600s'

                  - task: Kubernetes@1
                    displayName: 'Wait for user-service deployment'
                    inputs:
                      connectionType: 'Kubernetes Service Connection'
                      kubernetesServiceEndpoint: 'K8s-Prod-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      command: 'rollout'
                      arguments: 'status deployment/user-service --timeout=600s'

                  - task: Kubernetes@1
                    displayName: 'Wait for job-service deployment'
                    inputs:
                      connectionType: 'Kubernetes Service Connection'
                      kubernetesServiceEndpoint: 'K8s-Prod-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      command: 'rollout'
                      arguments: 'status deployment/job-service --timeout=600s'

                  - task: Kubernetes@1
                    displayName: 'Wait for resume-service deployment'
                    inputs:
                      connectionType: 'Kubernetes Service Connection'
                      kubernetesServiceEndpoint: 'K8s-Prod-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      command: 'rollout'
                      arguments: 'status deployment/resume-service --timeout=600s'

                  - task: Kubernetes@1
                    displayName: 'Wait for notification-service deployment'
                    inputs:
                      connectionType: 'Kubernetes Service Connection'
                      kubernetesServiceEndpoint: 'K8s-Prod-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      command: 'rollout'
                      arguments: 'status deployment/notification-service --timeout=600s'

                  - task: Kubernetes@1
                    displayName: 'Wait for auto-apply-service deployment'
                    inputs:
                      connectionType: 'Kubernetes Service Connection'
                      kubernetesServiceEndpoint: 'K8s-Prod-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      command: 'rollout'
                      arguments: 'status deployment/auto-apply-service --timeout=600s'

                  - task: Kubernetes@1
                    displayName: 'Wait for ai-service deployment'
                    inputs:
                      connectionType: 'Kubernetes Service Connection'
                      kubernetesServiceEndpoint: 'K8s-Prod-ServiceConnection'
                      namespace: '$(NAMESPACE)'
                      command: 'rollout'
                      arguments: 'status deployment/ai-service --timeout=600s'

                  - script: |
                      echo "Running production smoke tests..."
                      # Add your smoke test commands here
                      # curl -f https://jobpilot.ai/health || exit 1
                      # curl -f https://api.jobpilot.ai/health || exit 1
                    displayName: 'Run production smoke tests'

        # Post-deployment monitoring
        - job: PostDeploymentMonitoring
          displayName: 'Post-Deployment Monitoring'
          dependsOn: DeployProductionEnvironment
          pool:
            vmImage: 'ubuntu-latest'
          steps:
            - script: |
                echo "Monitoring production deployment for 5 minutes..."
                echo "Check Application Insights and logs for errors"
                sleep 300
              displayName: 'Monitor deployment'

            - script: |
                echo "Production deployment completed successfully!"
                echo "Build ID: $(Build.BuildId)"
                echo "Deployment Time: $(date)"
              displayName: 'Deployment summary'

trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main

variables:
  acrName: 'acrunifiedhealthdev2'
  acrLoginServer: 'acrunifiedhealthdev2.azurecr.io'
  imagePrefix: 'applyai'
  vmImageName: 'ubuntu-latest'
  nodeVersion: '20.x'
  pnpmVersion: '8.15.0'
  azureSubscription: 'ApplyPlatform'

stages:
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildAndTest
        displayName: 'Build Packages and Run Tests'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: $(nodeVersion)
            displayName: 'Install Node.js'

          - script: |
              corepack enable
              corepack prepare pnpm@$(pnpmVersion) --activate
            displayName: 'Setup pnpm'

          - script: pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: pnpm run build
            displayName: 'Build all packages'

          - script: pnpm test
            displayName: 'Run tests'
            continueOnError: true

  - stage: BuildImages
    displayName: 'Build Docker Images'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: BuildAllServices
        displayName: 'Build All Docker Images'
        pool:
          vmImage: $(vmImageName)
        timeoutInMinutes: 120
        steps:
          - task: AzureCLI@2
            displayName: 'Login to ACR'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az acr login --name $(acrName)

          - task: AzureCLI@2
            displayName: 'Build and Push Web App'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                docker build -t $(acrLoginServer)/$(imagePrefix)-web:$(Build.BuildId) -t $(acrLoginServer)/$(imagePrefix)-web:latest -f apps/web/Dockerfile .
                docker push $(acrLoginServer)/$(imagePrefix)-web:$(Build.BuildId)
                docker push $(acrLoginServer)/$(imagePrefix)-web:latest

          - task: AzureCLI@2
            displayName: 'Build and Push Auth Service'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                docker build -t $(acrLoginServer)/$(imagePrefix)-auth-service:$(Build.BuildId) -t $(acrLoginServer)/$(imagePrefix)-auth-service:latest -f services/auth-service/Dockerfile .
                docker push $(acrLoginServer)/$(imagePrefix)-auth-service:$(Build.BuildId)
                docker push $(acrLoginServer)/$(imagePrefix)-auth-service:latest

          - task: AzureCLI@2
            displayName: 'Build and Push User Service'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                docker build -t $(acrLoginServer)/$(imagePrefix)-user-service:$(Build.BuildId) -t $(acrLoginServer)/$(imagePrefix)-user-service:latest -f services/user-service/Dockerfile .
                docker push $(acrLoginServer)/$(imagePrefix)-user-service:$(Build.BuildId)
                docker push $(acrLoginServer)/$(imagePrefix)-user-service:latest

          - task: AzureCLI@2
            displayName: 'Build and Push Job Service'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                docker build -t $(acrLoginServer)/$(imagePrefix)-job-service:$(Build.BuildId) -t $(acrLoginServer)/$(imagePrefix)-job-service:latest -f services/job-service/Dockerfile .
                docker push $(acrLoginServer)/$(imagePrefix)-job-service:$(Build.BuildId)
                docker push $(acrLoginServer)/$(imagePrefix)-job-service:latest

          - task: AzureCLI@2
            displayName: 'Build and Push Analytics Service'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                docker build -t $(acrLoginServer)/$(imagePrefix)-analytics-service:$(Build.BuildId) -t $(acrLoginServer)/$(imagePrefix)-analytics-service:latest -f services/analytics-service/Dockerfile .
                docker push $(acrLoginServer)/$(imagePrefix)-analytics-service:$(Build.BuildId)
                docker push $(acrLoginServer)/$(imagePrefix)-analytics-service:latest

          - task: AzureCLI@2
            displayName: 'Build and Push Notification Service'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                docker build -t $(acrLoginServer)/$(imagePrefix)-notification-service:$(Build.BuildId) -t $(acrLoginServer)/$(imagePrefix)-notification-service:latest -f services/notification-service/Dockerfile .
                docker push $(acrLoginServer)/$(imagePrefix)-notification-service:$(Build.BuildId)
                docker push $(acrLoginServer)/$(imagePrefix)-notification-service:latest

          - task: AzureCLI@2
            displayName: 'Build and Push Resume Service'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                docker build -t $(acrLoginServer)/$(imagePrefix)-resume-service:$(Build.BuildId) -t $(acrLoginServer)/$(imagePrefix)-resume-service:latest -f services/resume-service/Dockerfile .
                docker push $(acrLoginServer)/$(imagePrefix)-resume-service:$(Build.BuildId)
                docker push $(acrLoginServer)/$(imagePrefix)-resume-service:latest

          - task: AzureCLI@2
            displayName: 'Build and Push Auto-Apply Service'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                docker build -t $(acrLoginServer)/$(imagePrefix)-auto-apply-service:$(Build.BuildId) -t $(acrLoginServer)/$(imagePrefix)-auto-apply-service:latest -f services/auto-apply-service/Dockerfile .
                docker push $(acrLoginServer)/$(imagePrefix)-auto-apply-service:$(Build.BuildId)
                docker push $(acrLoginServer)/$(imagePrefix)-auto-apply-service:latest

          - task: AzureCLI@2
            displayName: 'Build and Push Orchestrator Service'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                docker build -t $(acrLoginServer)/$(imagePrefix)-orchestrator-service:$(Build.BuildId) -t $(acrLoginServer)/$(imagePrefix)-orchestrator-service:latest -f services/orchestrator-service/Dockerfile .
                docker push $(acrLoginServer)/$(imagePrefix)-orchestrator-service:$(Build.BuildId)
                docker push $(acrLoginServer)/$(imagePrefix)-orchestrator-service:latest

          - task: AzureCLI@2
            displayName: 'Build and Push Payment Service'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                docker build -t $(acrLoginServer)/$(imagePrefix)-payment-service:$(Build.BuildId) -t $(acrLoginServer)/$(imagePrefix)-payment-service:latest -f services/payment-service/Dockerfile .
                docker push $(acrLoginServer)/$(imagePrefix)-payment-service:$(Build.BuildId)
                docker push $(acrLoginServer)/$(imagePrefix)-payment-service:latest

          - task: AzureCLI@2
            displayName: 'Build and Push AI Service'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                docker build -t $(acrLoginServer)/$(imagePrefix)-ai-service:$(Build.BuildId) -t $(acrLoginServer)/$(imagePrefix)-ai-service:latest -f services/ai-service/Dockerfile .
                docker push $(acrLoginServer)/$(imagePrefix)-ai-service:$(Build.BuildId)
                docker push $(acrLoginServer)/$(imagePrefix)-ai-service:latest

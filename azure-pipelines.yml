trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main

variables:
  acrLoginServer: 'acrunifiedhealthdev2.azurecr.io'
  imagePrefix: 'applyai'
  vmImageName: 'ubuntu-latest'
  nodeVersion: '20.x'
  pnpmVersion: '8.15.0'

stages:
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildAndTest
        displayName: 'Build Packages and Run Tests'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: $(nodeVersion)
            displayName: 'Install Node.js'

          - script: |
              corepack enable
              corepack prepare pnpm@$(pnpmVersion) --activate
            displayName: 'Setup pnpm'

          - script: pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: pnpm run build
            displayName: 'Build all packages'

          - script: pnpm test
            displayName: 'Run tests'
            continueOnError: true

  - stage: BuildImages
    displayName: 'Build Docker Images'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: BuildWeb
        displayName: 'Build Web App'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Docker@2
            displayName: 'Build and Push Web'
            inputs:
              containerRegistry: 'acrunifiedhealthdev2'
              repository: '$(imagePrefix)-web'
              command: 'buildAndPush'
              Dockerfile: 'apps/web/Dockerfile'
              buildContext: '.'
              tags: |
                $(Build.BuildId)
                latest

      - job: BuildAuthService
        displayName: 'Build Auth Service'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Docker@2
            displayName: 'Build and Push Auth Service'
            inputs:
              containerRegistry: 'acrunifiedhealthdev2'
              repository: '$(imagePrefix)-auth-service'
              command: 'buildAndPush'
              Dockerfile: 'services/auth-service/Dockerfile'
              buildContext: '.'
              tags: |
                $(Build.BuildId)
                latest

      - job: BuildUserService
        displayName: 'Build User Service'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Docker@2
            displayName: 'Build and Push User Service'
            inputs:
              containerRegistry: 'acrunifiedhealthdev2'
              repository: '$(imagePrefix)-user-service'
              command: 'buildAndPush'
              Dockerfile: 'services/user-service/Dockerfile'
              buildContext: '.'
              tags: |
                $(Build.BuildId)
                latest

      - job: BuildJobService
        displayName: 'Build Job Service'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Docker@2
            displayName: 'Build and Push Job Service'
            inputs:
              containerRegistry: 'acrunifiedhealthdev2'
              repository: '$(imagePrefix)-job-service'
              command: 'buildAndPush'
              Dockerfile: 'services/job-service/Dockerfile'
              buildContext: '.'
              tags: |
                $(Build.BuildId)
                latest

      - job: BuildAnalyticsService
        displayName: 'Build Analytics Service'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Docker@2
            displayName: 'Build and Push Analytics Service'
            inputs:
              containerRegistry: 'acrunifiedhealthdev2'
              repository: '$(imagePrefix)-analytics-service'
              command: 'buildAndPush'
              Dockerfile: 'services/analytics-service/Dockerfile'
              buildContext: '.'
              tags: |
                $(Build.BuildId)
                latest

      - job: BuildNotificationService
        displayName: 'Build Notification Service'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Docker@2
            displayName: 'Build and Push Notification Service'
            inputs:
              containerRegistry: 'acrunifiedhealthdev2'
              repository: '$(imagePrefix)-notification-service'
              command: 'buildAndPush'
              Dockerfile: 'services/notification-service/Dockerfile'
              buildContext: '.'
              tags: |
                $(Build.BuildId)
                latest

      - job: BuildResumeService
        displayName: 'Build Resume Service'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Docker@2
            displayName: 'Build and Push Resume Service'
            inputs:
              containerRegistry: 'acrunifiedhealthdev2'
              repository: '$(imagePrefix)-resume-service'
              command: 'buildAndPush'
              Dockerfile: 'services/resume-service/Dockerfile'
              buildContext: '.'
              tags: |
                $(Build.BuildId)
                latest

      - job: BuildAutoApplyService
        displayName: 'Build Auto-Apply Service'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Docker@2
            displayName: 'Build and Push Auto-Apply Service'
            inputs:
              containerRegistry: 'acrunifiedhealthdev2'
              repository: '$(imagePrefix)-auto-apply-service'
              command: 'buildAndPush'
              Dockerfile: 'services/auto-apply-service/Dockerfile'
              buildContext: '.'
              tags: |
                $(Build.BuildId)
                latest

      - job: BuildOrchestratorService
        displayName: 'Build Orchestrator Service'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Docker@2
            displayName: 'Build and Push Orchestrator Service'
            inputs:
              containerRegistry: 'acrunifiedhealthdev2'
              repository: '$(imagePrefix)-orchestrator-service'
              command: 'buildAndPush'
              Dockerfile: 'services/orchestrator-service/Dockerfile'
              buildContext: '.'
              tags: |
                $(Build.BuildId)
                latest

      - job: BuildPaymentService
        displayName: 'Build Payment Service'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Docker@2
            displayName: 'Build and Push Payment Service'
            inputs:
              containerRegistry: 'acrunifiedhealthdev2'
              repository: '$(imagePrefix)-payment-service'
              command: 'buildAndPush'
              Dockerfile: 'services/payment-service/Dockerfile'
              buildContext: '.'
              tags: |
                $(Build.BuildId)
                latest

      - job: BuildAIService
        displayName: 'Build AI Service'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Docker@2
            displayName: 'Build and Push AI Service'
            inputs:
              containerRegistry: 'acrunifiedhealthdev2'
              repository: '$(imagePrefix)-ai-service'
              command: 'buildAndPush'
              Dockerfile: 'services/ai-service/Dockerfile'
              buildContext: '.'
              tags: |
                $(Build.BuildId)
                latest

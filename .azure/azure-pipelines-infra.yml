# ============================================================================
# Azure Infrastructure Deployment Pipeline
# ============================================================================
# This pipeline deploys Azure infrastructure using Bicep templates
# Project: https://dev.azure.com/citadelcloudmanagement/ApplyPlatform

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - infrastructure/azure/**
      - .azure/azure-pipelines-infra.yml

pr:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - infrastructure/azure/**

variables:
  - name: AZURE_SUBSCRIPTION
    value: 'JobPilot-Azure-Subscription'
  - name: BICEP_VERSION
    value: 'latest'
  - name: isMain
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]
  - name: isDevelop
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/develop')]

stages:
  # ============================================================================
  # Stage 1: Validate Bicep Templates
  # ============================================================================
  - stage: Validate
    displayName: 'Validate Bicep Templates'
    jobs:
      - job: ValidateBicep
        displayName: 'Validate and Lint Bicep'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Install Bicep CLI'
            inputs:
              azureSubscription: $(AZURE_SUBSCRIPTION)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az bicep install
                az bicep version

          - task: AzureCLI@2
            displayName: 'Lint Bicep Templates'
            inputs:
              azureSubscription: $(AZURE_SUBSCRIPTION)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "Linting main.bicep..."
                az bicep lint --file infrastructure/azure/main.bicep

                echo "Linting all module files..."
                for file in infrastructure/azure/modules/*.bicep; do
                  echo "Linting $file..."
                  az bicep lint --file "$file"
                done

          - task: AzureCLI@2
            displayName: 'Build Bicep Templates'
            inputs:
              azureSubscription: $(AZURE_SUBSCRIPTION)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "Building Bicep templates to ARM..."
                az bicep build --file infrastructure/azure/main.bicep --outdir $(Build.ArtifactStagingDirectory)/arm

          - task: PublishPipelineArtifact@1
            displayName: 'Publish ARM Templates'
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)/arm
              artifact: arm-templates
              publishLocation: pipeline

      - job: SecurityScan
        displayName: 'Security Scan'
        dependsOn: ValidateBicep
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: UsePythonVersion@0
            displayName: 'Use Python 3.11'
            inputs:
              versionSpec: '3.11'
              addToPath: true

          - script: |
              echo "Installing Checkov for IaC security scanning..."
              pip install checkov
            displayName: 'Install Checkov'

          - script: |
              echo "Running Checkov on Bicep templates..."
              checkov --directory infrastructure/azure/modules \
                --framework bicep \
                --output cli \
                --output junitxml \
                --output-file-path $(Build.ArtifactStagingDirectory) \
                --soft-fail
            displayName: 'Checkov IaC Security Scan - Modules'
            continueOnError: true

          - script: |
              echo "Running Checkov on main Bicep file..."
              checkov --file infrastructure/azure/main.bicep \
                --framework bicep \
                --output cli \
                --output sarif \
                --output-file-path $(Build.ArtifactStagingDirectory) \
                --soft-fail
            displayName: 'Checkov IaC Security Scan - Main'
            continueOnError: true

          - task: PublishTestResults@2
            displayName: 'Publish Checkov Test Results'
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '$(Build.ArtifactStagingDirectory)/results_junitxml.xml'
              testRunTitle: 'Checkov IaC Security Scan'
              mergeTestResults: true
            continueOnError: true

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Checkov SARIF Results'
            condition: succeededOrFailed()
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)/results_sarif.sarif
              artifact: checkov-sarif
              publishLocation: pipeline
            continueOnError: true

      - job: PSRuleForAzure
        displayName: 'PSRule for Azure Analysis'
        dependsOn: ValidateBicep
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: ps-rule-assert@2
            displayName: 'Analyze Azure Infrastructure with PSRule'
            inputs:
              inputType: 'repository'
              inputPath: 'infrastructure/azure/'
              modules: 'PSRule.Rules.Azure'
              outputFormat: 'Sarif'
              outputPath: '$(Build.ArtifactStagingDirectory)/ps-rule-results.sarif'
            continueOnError: true

          - task: PublishPipelineArtifact@1
            displayName: 'Publish PSRule Results'
            condition: succeededOrFailed()
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)/ps-rule-results.sarif
              artifact: psrule-results
              publishLocation: pipeline
            continueOnError: true

  # ============================================================================
  # Stage 2: Deploy to Development
  # ============================================================================
  - stage: DeployDev
    displayName: 'Deploy to Development'
    dependsOn: Validate
    condition: and(succeeded(), eq(variables.isDevelop, true))
    jobs:
      - deployment: DeployDevInfra
        displayName: 'Deploy Dev Infrastructure'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'development-infrastructure'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'Deploy Bicep to Dev'
                  inputs:
                    azureSubscription: $(AZURE_SUBSCRIPTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      echo "Deploying to Development environment..."

                      # Create deployment
                      az deployment sub create \
                        --name "jobpilot-dev-$(Build.BuildId)" \
                        --location eastus \
                        --template-file infrastructure/azure/main.bicep \
                        --parameters infrastructure/azure/parameters.dev.json \
                        --verbose

                - task: AzureCLI@2
                  displayName: 'Verify Deployment'
                  inputs:
                    azureSubscription: $(AZURE_SUBSCRIPTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      echo "Verifying deployment..."

                      # Get deployment outputs
                      outputs=$(az deployment sub show \
                        --name "jobpilot-dev-$(Build.BuildId)" \
                        --query properties.outputs)

                      echo "Deployment Outputs:"
                      echo "$outputs"

                      # Save outputs for later use
                      echo "$outputs" > $(Build.ArtifactStagingDirectory)/dev-outputs.json

                - task: PublishPipelineArtifact@1
                  displayName: 'Publish Deployment Outputs'
                  inputs:
                    targetPath: $(Build.ArtifactStagingDirectory)/dev-outputs.json
                    artifact: dev-deployment-outputs
                    publishLocation: pipeline

  # ============================================================================
  # Stage 3: Deploy to Staging
  # ============================================================================
  - stage: DeployStaging
    displayName: 'Deploy to Staging'
    dependsOn: Validate
    condition: and(succeeded(), eq(variables.isMain, true))
    jobs:
      - deployment: DeployStagingInfra
        displayName: 'Deploy Staging Infrastructure'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'staging-infrastructure'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'What-If Analysis'
                  inputs:
                    azureSubscription: $(AZURE_SUBSCRIPTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      echo "Running What-If analysis for Staging..."

                      az deployment sub what-if \
                        --name "jobpilot-staging-$(Build.BuildId)" \
                        --location eastus \
                        --template-file infrastructure/azure/main.bicep \
                        --parameters infrastructure/azure/parameters.staging.json

                - task: AzureCLI@2
                  displayName: 'Deploy Bicep to Staging'
                  inputs:
                    azureSubscription: $(AZURE_SUBSCRIPTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      echo "Deploying to Staging environment..."

                      az deployment sub create \
                        --name "jobpilot-staging-$(Build.BuildId)" \
                        --location eastus \
                        --template-file infrastructure/azure/main.bicep \
                        --parameters infrastructure/azure/parameters.staging.json \
                        --verbose

                - task: AzureCLI@2
                  displayName: 'Verify Deployment'
                  inputs:
                    azureSubscription: $(AZURE_SUBSCRIPTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      echo "Verifying deployment..."

                      outputs=$(az deployment sub show \
                        --name "jobpilot-staging-$(Build.BuildId)" \
                        --query properties.outputs)

                      echo "Deployment Outputs:"
                      echo "$outputs"

                      echo "$outputs" > $(Build.ArtifactStagingDirectory)/staging-outputs.json

                - task: PublishPipelineArtifact@1
                  displayName: 'Publish Deployment Outputs'
                  inputs:
                    targetPath: $(Build.ArtifactStagingDirectory)/staging-outputs.json
                    artifact: staging-deployment-outputs
                    publishLocation: pipeline

  # ============================================================================
  # Stage 4: Deploy to Production (with Approval Gate)
  # ============================================================================
  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn: DeployStaging
    condition: and(succeeded(), eq(variables.isMain, true))
    jobs:
      - deployment: DeployProdInfra
        displayName: 'Deploy Production Infrastructure'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'production-infrastructure' # Configure approval gate in Azure DevOps
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'What-If Analysis'
                  inputs:
                    azureSubscription: $(AZURE_SUBSCRIPTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      echo "Running What-If analysis for Production..."

                      az deployment sub what-if \
                        --name "jobpilot-prod-$(Build.BuildId)" \
                        --location eastus \
                        --template-file infrastructure/azure/main.bicep \
                        --parameters infrastructure/azure/parameters.prod.json \
                        --no-pretty-print

                - task: AzureCLI@2
                  displayName: 'Backup Current State'
                  inputs:
                    azureSubscription: $(AZURE_SUBSCRIPTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      echo "Backing up current production state..."

                      # Export current resource group configuration
                      az group export \
                        --name jobpilot-prod-rg \
                        --output json \
                        > $(Build.ArtifactStagingDirectory)/prod-backup-$(Build.BuildId).json || true

                - task: AzureCLI@2
                  displayName: 'Deploy Bicep to Production'
                  inputs:
                    azureSubscription: $(AZURE_SUBSCRIPTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      echo "Deploying to Production environment..."

                      az deployment sub create \
                        --name "jobpilot-prod-$(Build.BuildId)" \
                        --location eastus \
                        --template-file infrastructure/azure/main.bicep \
                        --parameters infrastructure/azure/parameters.prod.json \
                        --verbose

                - task: AzureCLI@2
                  displayName: 'Verify Production Deployment'
                  inputs:
                    azureSubscription: $(AZURE_SUBSCRIPTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      echo "Verifying production deployment..."

                      outputs=$(az deployment sub show \
                        --name "jobpilot-prod-$(Build.BuildId)" \
                        --query properties.outputs)

                      echo "Deployment Outputs:"
                      echo "$outputs"

                      echo "$outputs" > $(Build.ArtifactStagingDirectory)/prod-outputs.json

                      # Verify critical resources
                      echo "Verifying critical resources..."

                      # Check App Service health
                      az webapp show --name jobpilot-prod-web --resource-group jobpilot-prod-rg --query state

                      # Check SQL Database status
                      az sql db show --name jobpilot_prod --server jobpilot-prod-sql-* --resource-group jobpilot-prod-rg --query status

                - task: PublishPipelineArtifact@1
                  displayName: 'Publish Deployment Outputs'
                  inputs:
                    targetPath: $(Build.ArtifactStagingDirectory)/prod-outputs.json
                    artifact: prod-deployment-outputs
                    publishLocation: pipeline

                - task: PublishPipelineArtifact@1
                  displayName: 'Publish Backup'
                  inputs:
                    targetPath: $(Build.ArtifactStagingDirectory)/prod-backup-$(Build.BuildId).json
                    artifact: prod-backup
                    publishLocation: pipeline
                  condition: succeededOrFailed()

      # Post-Deployment Validation
      - job: PostDeploymentValidation
        displayName: 'Post-Deployment Validation'
        dependsOn: DeployProdInfra
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: AzureCLI@2
            displayName: 'Run Health Checks'
            inputs:
              azureSubscription: $(AZURE_SUBSCRIPTION)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "Running health checks on production infrastructure..."

                # Check all App Services are running
                for app in web auth ai; do
                  state=$(az webapp show --name jobpilot-prod-$app --resource-group jobpilot-prod-rg --query state -o tsv)
                  echo "App Service jobpilot-prod-$app state: $state"
                  if [ "$state" != "Running" ]; then
                    echo "ERROR: App Service is not running!"
                    exit 1
                  fi
                done

                echo "All health checks passed!"

          - task: AzureCLI@2
            displayName: 'Configure Alerts'
            inputs:
              azureSubscription: $(AZURE_SUBSCRIPTION)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "Ensuring all monitoring alerts are enabled..."

                # List all alert rules
                az monitor metrics alert list --resource-group jobpilot-prod-rg

                echo "Monitoring configuration verified!"

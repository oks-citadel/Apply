# ============================================================================
# Docker Build Template - ApplyforUs Platform
# ============================================================================
# Reusable template for building Docker images
# Usage: Import this template in your pipeline and pass required parameters

parameters:
  - name: serviceName
    type: string
    displayName: 'Service name (e.g., web, auth-service, job-service)'

  - name: dockerfilePath
    type: string
    displayName: 'Path to Dockerfile'

  - name: buildContext
    type: string
    default: '.'
    displayName: 'Docker build context'

  - name: imageTag
    type: string
    default: '$(Build.BuildId)'
    displayName: 'Docker image tag'

  - name: additionalBuildArgs
    type: string
    default: ''
    displayName: 'Additional build arguments'

  - name: enableBuildCache
    type: boolean
    default: true
    displayName: 'Enable Docker build cache'

  - name: targetStage
    type: string
    default: ''
    displayName: 'Target build stage (optional)'

steps:
  - task: Docker@2
    displayName: 'Build Docker Image - ${{ parameters.serviceName }}'
    inputs:
      command: 'build'
      repository: '${{ parameters.serviceName }}'
      dockerfile: '${{ parameters.dockerfilePath }}'
      buildContext: '${{ parameters.buildContext }}'
      tags: |
        ${{ parameters.imageTag }}
        latest
      arguments: >
        ${{ parameters.additionalBuildArgs }}
        ${{ eq(parameters.targetStage, '') && '' || format('--target {0}', parameters.targetStage) }}
        ${{ eq(parameters.enableBuildCache, true) && '--cache-from type=registry,ref=$(containerRegistry)/applyforus-${{ parameters.serviceName }}:buildcache' || '' }}
        ${{ eq(parameters.enableBuildCache, true) && '--cache-to type=registry,ref=$(containerRegistry)/applyforus-${{ parameters.serviceName }}:buildcache,mode=max' || '' }}
        --label "commit.sha=$(Build.SourceVersion)"
        --label "build.id=$(Build.BuildId)"
        --label "build.date=$(Build.Date)"
        --label "build.number=$(Build.BuildNumber)"
        --label "service.name=${{ parameters.serviceName }}"
        --label "platform=ApplyforUs"

  - task: Docker@2
    displayName: 'Save Docker Image to TAR - ${{ parameters.serviceName }}'
    inputs:
      command: 'save'
      arguments: '-o $(Build.ArtifactStagingDirectory)/${{ parameters.serviceName }}-${{ parameters.imageTag }}.tar ${{ parameters.serviceName }}:${{ parameters.imageTag }}'

  - task: PublishPipelineArtifact@1
    displayName: 'Publish Docker Image Artifact - ${{ parameters.serviceName }}'
    inputs:
      targetPath: '$(Build.ArtifactStagingDirectory)/${{ parameters.serviceName }}-${{ parameters.imageTag }}.tar'
      artifactName: 'docker-image-${{ parameters.serviceName }}'
      publishLocation: 'pipeline'

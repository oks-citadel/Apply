# ============================================================================
# Security Scanning Template - ApplyforUs Platform
# ============================================================================
# Reusable template for comprehensive security scanning
# Usage: Import this template in your pipeline and pass required parameters

parameters:
  - name: scanType
    type: string
    default: 'all'
    displayName: 'Type of security scan'
    values:
      - all
      - sast
      - dependencies
      - secrets
      - containers

  - name: workingDirectory
    type: string
    default: '.'
    displayName: 'Working directory for scan'

  - name: failOnHighSeverity
    type: boolean
    default: false
    displayName: 'Fail build on high severity issues'

  - name: failOnCriticalSeverity
    type: boolean
    default: true
    displayName: 'Fail build on critical severity issues'

steps:
  # Secret Detection
  - ${{ if or(eq(parameters.scanType, 'all'), eq(parameters.scanType, 'secrets')) }}:
    - task: Bash@3
      displayName: 'Install TruffleHog for Secret Detection'
      inputs:
        targetType: 'inline'
        script: |
          pip install truffleHog

    - task: Bash@3
      displayName: 'Scan for Secrets'
      inputs:
        targetType: 'inline'
        workingDirectory: '${{ parameters.workingDirectory }}'
        script: |
          echo "Scanning for secrets in the codebase..."
          trufflehog --regex --entropy=True --max_depth=50 . > $(Build.ArtifactStagingDirectory)/secret-scan-results.txt || true

          if [ -s $(Build.ArtifactStagingDirectory)/secret-scan-results.txt ]; then
            echo "##vso[task.logissue type=warning]Potential secrets detected! Review the scan results."
            cat $(Build.ArtifactStagingDirectory)/secret-scan-results.txt
          else
            echo "No secrets detected"
          fi

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Secret Scan Results'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/secret-scan-results.txt'
        artifactName: 'secret-scan-results'
        publishLocation: 'pipeline'
      condition: succeededOrFailed()

  # SAST - Static Application Security Testing
  - ${{ if or(eq(parameters.scanType, 'all'), eq(parameters.scanType, 'sast')) }}:
    - task: Bash@3
      displayName: 'Install Semgrep for SAST'
      inputs:
        targetType: 'inline'
        script: |
          pip install semgrep

    - task: Bash@3
      displayName: 'Run SAST Scan with Semgrep'
      inputs:
        targetType: 'inline'
        workingDirectory: '${{ parameters.workingDirectory }}'
        script: |
          echo "Running SAST scan..."
          semgrep --config=auto --json --output=$(Build.ArtifactStagingDirectory)/sast-results.json . || true
          semgrep --config=auto --sarif --output=$(Build.ArtifactStagingDirectory)/sast-results.sarif . || true

          # Generate human-readable report
          semgrep --config=auto . > $(Build.ArtifactStagingDirectory)/sast-results.txt || true

          echo "SAST scan completed"

    - task: PublishPipelineArtifact@1
      displayName: 'Publish SAST Results'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/sast-results.json'
        artifactName: 'sast-scan-results'
        publishLocation: 'pipeline'
      condition: succeededOrFailed()

  # Dependency Scanning
  - ${{ if or(eq(parameters.scanType, 'all'), eq(parameters.scanType, 'dependencies')) }}:
    - task: Bash@3
      displayName: 'Install npm-audit and Safety'
      inputs:
        targetType: 'inline'
        script: |
          npm install -g npm-audit-html
          pip install safety

    - task: Bash@3
      displayName: 'Scan NPM Dependencies'
      inputs:
        targetType: 'inline'
        workingDirectory: '${{ parameters.workingDirectory }}'
        script: |
          echo "Scanning NPM dependencies..."

          # Run npm audit
          npm audit --json > $(Build.ArtifactStagingDirectory)/npm-audit.json || true
          npm audit > $(Build.ArtifactStagingDirectory)/npm-audit.txt || true

          # Generate HTML report
          npm-audit-html --input $(Build.ArtifactStagingDirectory)/npm-audit.json --output $(Build.ArtifactStagingDirectory)/npm-audit.html || true

          echo "NPM dependency scan completed"

    - task: Bash@3
      displayName: 'Scan Python Dependencies'
      inputs:
        targetType: 'inline'
        workingDirectory: '${{ parameters.workingDirectory }}'
        script: |
          echo "Scanning Python dependencies..."

          # Find all requirements files
          find . -name "requirements*.txt" -type f | while read req_file; do
            echo "Scanning $req_file"
            safety check --file "$req_file" --json > "$(Build.ArtifactStagingDirectory)/safety-$(basename $req_file).json" || true
          done

          echo "Python dependency scan completed"
      continueOnError: true

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Dependency Scan Results'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'dependency-scan-results'
        publishLocation: 'pipeline'
      condition: succeededOrFailed()

  # Container Image Scanning
  - ${{ if or(eq(parameters.scanType, 'all'), eq(parameters.scanType, 'containers')) }}:
    - task: Bash@3
      displayName: 'Install Trivy Scanner'
      inputs:
        targetType: 'inline'
        script: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y

    - task: Bash@3
      displayName: 'Scan Dockerfiles'
      inputs:
        targetType: 'inline'
        workingDirectory: '${{ parameters.workingDirectory }}'
        script: |
          echo "Scanning Dockerfiles for vulnerabilities..."

          mkdir -p $(Build.ArtifactStagingDirectory)/dockerfile-scans

          find . -name "Dockerfile*" -type f | while read dockerfile; do
            echo "Scanning $dockerfile"
            trivy config --severity HIGH,CRITICAL --format json "$dockerfile" > "$(Build.ArtifactStagingDirectory)/dockerfile-scans/$(echo $dockerfile | sed 's/\//-/g').json" || true
          done

          echo "Dockerfile scan completed"

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Container Scan Results'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/dockerfile-scans'
        artifactName: 'container-scan-results'
        publishLocation: 'pipeline'
      condition: succeededOrFailed()

  # Security Summary Report
  - task: Bash@3
    displayName: 'Generate Security Summary Report'
    inputs:
      targetType: 'inline'
      script: |
        echo "# Security Scan Summary - ApplyforUs Platform" > $(Build.ArtifactStagingDirectory)/security-summary.md
        echo "" >> $(Build.ArtifactStagingDirectory)/security-summary.md
        echo "**Scan Type:** ${{ parameters.scanType }}" >> $(Build.ArtifactStagingDirectory)/security-summary.md
        echo "**Date:** $(date)" >> $(Build.ArtifactStagingDirectory)/security-summary.md
        echo "**Build ID:** $(Build.BuildId)" >> $(Build.ArtifactStagingDirectory)/security-summary.md
        echo "" >> $(Build.ArtifactStagingDirectory)/security-summary.md

        echo "## Scan Results" >> $(Build.ArtifactStagingDirectory)/security-summary.md
        echo "" >> $(Build.ArtifactStagingDirectory)/security-summary.md

        # Check for critical issues
        CRITICAL_FOUND=false

        if [ -f "$(Build.ArtifactStagingDirectory)/secret-scan-results.txt" ] && [ -s "$(Build.ArtifactStagingDirectory)/secret-scan-results.txt" ]; then
          echo "- **Secrets:** Potential secrets detected" >> $(Build.ArtifactStagingDirectory)/security-summary.md
          CRITICAL_FOUND=true
        else
          echo "- **Secrets:** No secrets detected" >> $(Build.ArtifactStagingDirectory)/security-summary.md
        fi

        if [ -f "$(Build.ArtifactStagingDirectory)/sast-results.json" ]; then
          SAST_ISSUES=$(jq '.results | length' $(Build.ArtifactStagingDirectory)/sast-results.json 2>/dev/null || echo "0")
          echo "- **SAST:** $SAST_ISSUES issues found" >> $(Build.ArtifactStagingDirectory)/security-summary.md
        fi

        if [ -f "$(Build.ArtifactStagingDirectory)/npm-audit.json" ]; then
          NPM_HIGH=$(jq '.metadata.vulnerabilities.high // 0' $(Build.ArtifactStagingDirectory)/npm-audit.json 2>/dev/null || echo "0")
          NPM_CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' $(Build.ArtifactStagingDirectory)/npm-audit.json 2>/dev/null || echo "0")
          echo "- **NPM Dependencies:** $NPM_HIGH high, $NPM_CRITICAL critical vulnerabilities" >> $(Build.ArtifactStagingDirectory)/security-summary.md

          if [ "$NPM_CRITICAL" -gt "0" ] && [ "${{ parameters.failOnCriticalSeverity }}" = "True" ]; then
            CRITICAL_FOUND=true
          fi
        fi

        echo "" >> $(Build.ArtifactStagingDirectory)/security-summary.md
        echo "## Recommendations" >> $(Build.ArtifactStagingDirectory)/security-summary.md
        echo "- Review all identified vulnerabilities" >> $(Build.ArtifactStagingDirectory)/security-summary.md
        echo "- Update dependencies to latest secure versions" >> $(Build.ArtifactStagingDirectory)/security-summary.md
        echo "- Remove any detected secrets and rotate credentials" >> $(Build.ArtifactStagingDirectory)/security-summary.md
        echo "- Address SAST findings in the code" >> $(Build.ArtifactStagingDirectory)/security-summary.md

        cat $(Build.ArtifactStagingDirectory)/security-summary.md

        # Fail build if critical issues found
        if [ "$CRITICAL_FOUND" = true ]; then
          echo "##vso[task.logissue type=error]Critical security issues detected!"
          if [ "${{ parameters.failOnCriticalSeverity }}" = "True" ]; then
            exit 1
          fi
        fi

  - task: PublishPipelineArtifact@1
    displayName: 'Publish Security Summary'
    inputs:
      targetPath: '$(Build.ArtifactStagingDirectory)/security-summary.md'
      artifactName: 'security-summary'
      publishLocation: 'pipeline'
    condition: succeededOrFailed()

# ============================================================================
# Terraform Apply Template - ApplyforUs Platform
# ============================================================================
# Reusable template for applying Terraform changes
# Usage: Import this template in your pipeline and pass required parameters

parameters:
  - name: environment
    type: string
    displayName: 'Target environment (dev/test/prod)'
    values:
      - dev
      - test
      - prod

  - name: terraformVersion
    type: string
    default: 'latest'
    displayName: 'Terraform version'

  - name: workingDirectory
    type: string
    default: 'infrastructure/terraform'
    displayName: 'Terraform working directory'

  - name: azureServiceConnection
    type: string
    displayName: 'Azure Service Connection'

  - name: backendResourceGroup
    type: string
    displayName: 'Backend storage resource group'

  - name: backendStorageAccount
    type: string
    displayName: 'Backend storage account'

  - name: backendContainerName
    type: string
    default: 'tfstate'
    displayName: 'Backend storage container'

  - name: autoApprove
    type: boolean
    default: false
    displayName: 'Auto-approve (skip manual approval)'

steps:
  - task: DownloadPipelineArtifact@2
    displayName: 'Download Terraform Plan'
    inputs:
      artifactName: 'terraform-plan-${{ parameters.environment }}'
      targetPath: '${{ parameters.workingDirectory }}'

  - task: TerraformInstaller@0
    displayName: 'Install Terraform'
    inputs:
      terraformVersion: '${{ parameters.terraformVersion }}'

  - task: TerraformTaskV4@4
    displayName: 'Terraform Init'
    inputs:
      provider: 'azurerm'
      command: 'init'
      workingDirectory: '${{ parameters.workingDirectory }}'
      backendServiceArm: '${{ parameters.azureServiceConnection }}'
      backendAzureRmResourceGroupName: '${{ parameters.backendResourceGroup }}'
      backendAzureRmStorageAccountName: '${{ parameters.backendStorageAccount }}'
      backendAzureRmContainerName: '${{ parameters.backendContainerName }}'
      backendAzureRmKey: 'applyforus-${{ parameters.environment }}.tfstate'

  - ${{ if eq(parameters.autoApprove, false) }}:
    - task: ManualValidation@0
      displayName: 'Manual Approval Required'
      inputs:
        notifyUsers: ''
        instructions: 'Review the Terraform plan and approve to proceed with infrastructure changes for ${{ parameters.environment }} environment.'
        onTimeout: 'reject'

  - task: Bash@3
    displayName: 'Backup Current State'
    inputs:
      targetType: 'inline'
      workingDirectory: '${{ parameters.workingDirectory }}'
      script: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        terraform state pull > state-backup-${{ parameters.environment }}-$TIMESTAMP.json
        echo "State backup created: state-backup-${{ parameters.environment }}-$TIMESTAMP.json"

  - task: PublishPipelineArtifact@1
    displayName: 'Publish State Backup'
    inputs:
      targetPath: '${{ parameters.workingDirectory }}/state-backup-${{ parameters.environment }}-*.json'
      artifactName: 'terraform-state-backup-${{ parameters.environment }}'
      publishLocation: 'pipeline'

  - task: TerraformTaskV4@4
    displayName: 'Terraform Apply'
    inputs:
      provider: 'azurerm'
      command: 'apply'
      workingDirectory: '${{ parameters.workingDirectory }}'
      environmentServiceNameAzureRM: '${{ parameters.azureServiceConnection }}'
      commandOptions: 'tfplan-${{ parameters.environment }}.out'

  - task: Bash@3
    displayName: 'Output Infrastructure Details'
    inputs:
      targetType: 'inline'
      workingDirectory: '${{ parameters.workingDirectory }}'
      script: |
        echo "# Infrastructure Outputs - ${{ parameters.environment }}" > outputs.md
        echo "" >> outputs.md
        terraform output -json | jq -r 'to_entries[] | "- **\(.key):** \(.value.value)"' >> outputs.md
        cat outputs.md

  - task: PublishPipelineArtifact@1
    displayName: 'Publish Infrastructure Outputs'
    inputs:
      targetPath: '${{ parameters.workingDirectory }}/outputs.md'
      artifactName: 'infrastructure-outputs-${{ parameters.environment }}'
      publishLocation: 'pipeline'

  - task: AzureCLI@2
    displayName: 'Tag Resources'
    inputs:
      azureSubscription: '${{ parameters.azureServiceConnection }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        RESOURCE_GROUP="applyforus-${{ parameters.environment }}-rg"

        echo "Tagging resources in $RESOURCE_GROUP..."

        az group update \
          --name $RESOURCE_GROUP \
          --tags \
            "LastDeployment=$(date +%Y-%m-%d)" \
            "DeployedBy=AzureDevOps" \
            "BuildId=$(Build.BuildId)" \
            "Environment=${{ parameters.environment }}" \
            "Platform=ApplyforUs"

  - task: Bash@3
    displayName: 'Verify Infrastructure Health'
    inputs:
      targetType: 'inline'
      script: |
        echo "Performing infrastructure health checks..."

        # Add custom health checks here
        echo "Health check completed successfully"
    continueOnError: true

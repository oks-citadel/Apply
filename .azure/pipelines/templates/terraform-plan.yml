# ============================================================================
# Terraform Plan Template - ApplyforUs Platform
# ============================================================================
# Reusable template for running Terraform plan
# Usage: Import this template in your pipeline and pass required parameters

parameters:
  - name: environment
    type: string
    displayName: 'Target environment (dev/test/prod)'
    values:
      - dev
      - test
      - prod

  - name: terraformVersion
    type: string
    default: 'latest'
    displayName: 'Terraform version'

  - name: workingDirectory
    type: string
    default: 'infrastructure/terraform'
    displayName: 'Terraform working directory'

  - name: azureServiceConnection
    type: string
    displayName: 'Azure Service Connection'

  - name: backendResourceGroup
    type: string
    displayName: 'Backend storage resource group'

  - name: backendStorageAccount
    type: string
    displayName: 'Backend storage account'

  - name: backendContainerName
    type: string
    default: 'tfstate'
    displayName: 'Backend storage container'

  - name: varFile
    type: string
    default: ''
    displayName: 'Terraform variables file (optional)'

steps:
  - task: TerraformInstaller@0
    displayName: 'Install Terraform'
    inputs:
      terraformVersion: '${{ parameters.terraformVersion }}'

  - task: AzureCLI@2
    displayName: 'Setup Terraform Backend'
    inputs:
      azureSubscription: '${{ parameters.azureServiceConnection }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      workingDirectory: '${{ parameters.workingDirectory }}'
      inlineScript: |
        echo "Setting up Terraform backend for environment: ${{ parameters.environment }}"

        # Export ARM credentials for Terraform
        export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
        export ARM_TENANT_ID=$(az account show --query tenantId -o tsv)
        export ARM_CLIENT_ID=$(servicePrincipalId)
        export ARM_CLIENT_SECRET=$(servicePrincipalKey)

        echo "ARM_SUBSCRIPTION_ID: $ARM_SUBSCRIPTION_ID"
        echo "ARM_TENANT_ID: $ARM_TENANT_ID"

  - task: TerraformTaskV4@4
    displayName: 'Terraform Init'
    inputs:
      provider: 'azurerm'
      command: 'init'
      workingDirectory: '${{ parameters.workingDirectory }}'
      backendServiceArm: '${{ parameters.azureServiceConnection }}'
      backendAzureRmResourceGroupName: '${{ parameters.backendResourceGroup }}'
      backendAzureRmStorageAccountName: '${{ parameters.backendStorageAccount }}'
      backendAzureRmContainerName: '${{ parameters.backendContainerName }}'
      backendAzureRmKey: 'applyforus-${{ parameters.environment }}.tfstate'

  - task: TerraformTaskV4@4
    displayName: 'Terraform Validate'
    inputs:
      provider: 'azurerm'
      command: 'validate'
      workingDirectory: '${{ parameters.workingDirectory }}'

  - task: TerraformTaskV4@4
    displayName: 'Terraform Format Check'
    inputs:
      provider: 'azurerm'
      command: 'custom'
      workingDirectory: '${{ parameters.workingDirectory }}'
      customCommand: 'fmt'
      commandOptions: '-check -recursive'
    continueOnError: true

  - task: TerraformTaskV4@4
    displayName: 'Terraform Plan'
    name: 'terraformPlan'
    inputs:
      provider: 'azurerm'
      command: 'plan'
      workingDirectory: '${{ parameters.workingDirectory }}'
      environmentServiceNameAzureRM: '${{ parameters.azureServiceConnection }}'
      commandOptions: >
        -var="environment=${{ parameters.environment }}"
        -var="project_name=applyforus"
        ${{ eq(parameters.varFile, '') && '' || format('-var-file={0}', parameters.varFile) }}
        -out=tfplan-${{ parameters.environment }}.out
        -detailed-exitcode

  - task: Bash@3
    displayName: 'Generate Terraform Plan Summary'
    inputs:
      targetType: 'inline'
      workingDirectory: '${{ parameters.workingDirectory }}'
      script: |
        echo "# Terraform Plan Summary - ${{ parameters.environment }}" > plan-summary.md
        echo "" >> plan-summary.md
        echo "**Environment:** ${{ parameters.environment }}" >> plan-summary.md
        echo "**Date:** $(date)" >> plan-summary.md
        echo "**Build ID:** $(Build.BuildId)" >> plan-summary.md
        echo "" >> plan-summary.md

        terraform show -no-color tfplan-${{ parameters.environment }}.out > plan-output.txt

        echo "## Changes" >> plan-summary.md
        echo '```' >> plan-summary.md
        grep -A 1000 "Terraform will perform" plan-output.txt | head -100 >> plan-summary.md || echo "No changes detected" >> plan-summary.md
        echo '```' >> plan-summary.md

        echo "" >> plan-summary.md
        echo "## Resources" >> plan-summary.md
        terraform show -json tfplan-${{ parameters.environment }}.out | jq -r '.resource_changes[] | "- \(.change.actions[0]) \(.type).\(.name)"' >> plan-summary.md || echo "No resource changes" >> plan-summary.md

        cat plan-summary.md

  - task: Bash@3
    displayName: 'Check for Destructive Changes'
    inputs:
      targetType: 'inline'
      workingDirectory: '${{ parameters.workingDirectory }}'
      script: |
        DESTRUCTIVE_CHANGES=$(terraform show -json tfplan-${{ parameters.environment }}.out | jq -r '.resource_changes[] | select(.change.actions[] | contains("delete")) | .address')

        if [ ! -z "$DESTRUCTIVE_CHANGES" ]; then
          echo "##vso[task.logissue type=warning]DESTRUCTIVE CHANGES DETECTED!"
          echo "The following resources will be destroyed:"
          echo "$DESTRUCTIVE_CHANGES"
          echo "##vso[task.complete result=SucceededWithIssues;]"
        fi

  - task: AzureCLI@2
    displayName: 'Estimate Infrastructure Cost'
    inputs:
      azureSubscription: '${{ parameters.azureServiceConnection }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      workingDirectory: '${{ parameters.workingDirectory }}'
      inlineScript: |
        echo "Generating cost estimate for ${{ parameters.environment }}..."

        # Install infracost if not available
        if ! command -v infracost &> /dev/null; then
          echo "Installing Infracost..."
          curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
        fi

        # Generate cost estimate
        infracost breakdown \
          --path tfplan-${{ parameters.environment }}.out \
          --format table \
          --out-file cost-estimate-${{ parameters.environment }}.txt || echo "Cost estimation not available"

        if [ -f cost-estimate-${{ parameters.environment }}.txt ]; then
          cat cost-estimate-${{ parameters.environment }}.txt
        fi
    continueOnError: true

  - task: PublishPipelineArtifact@1
    displayName: 'Publish Terraform Plan'
    inputs:
      targetPath: '${{ parameters.workingDirectory }}/tfplan-${{ parameters.environment }}.out'
      artifactName: 'terraform-plan-${{ parameters.environment }}'
      publishLocation: 'pipeline'

  - task: PublishPipelineArtifact@1
    displayName: 'Publish Plan Summary'
    inputs:
      targetPath: '${{ parameters.workingDirectory }}/plan-summary.md'
      artifactName: 'plan-summary-${{ parameters.environment }}'
      publishLocation: 'pipeline'

  - task: PublishPipelineArtifact@1
    displayName: 'Publish Cost Estimate'
    inputs:
      targetPath: '${{ parameters.workingDirectory }}/cost-estimate-${{ parameters.environment }}.txt'
      artifactName: 'cost-estimate-${{ parameters.environment }}'
      publishLocation: 'pipeline'
    condition: succeededOrFailed()

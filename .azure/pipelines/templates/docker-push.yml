# ============================================================================
# Docker Push Template - ApplyforUs Platform
# ============================================================================
# Reusable template for pushing Docker images to Azure Container Registry
# Usage: Import this template in your pipeline and pass required parameters

parameters:
  - name: serviceName
    type: string
    displayName: 'Service name'

  - name: imageTag
    type: string
    default: '$(Build.BuildId)'
    displayName: 'Docker image tag'

  - name: containerRegistry
    type: string
    displayName: 'Container Registry name'

  - name: additionalTags
    type: object
    default: []
    displayName: 'Additional tags to apply'

  - name: enableVulnerabilityScan
    type: boolean
    default: true
    displayName: 'Enable vulnerability scanning before push'

steps:
  - task: Docker@2
    displayName: 'Login to ACR'
    inputs:
      command: 'login'
      containerRegistry: '${{ parameters.containerRegistry }}'

  - ${{ if eq(parameters.enableVulnerabilityScan, true) }}:
    - task: CmdLine@2
      displayName: 'Install Trivy Scanner'
      inputs:
        script: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y

    - task: CmdLine@2
      displayName: 'Scan Image with Trivy - ${{ parameters.serviceName }}'
      inputs:
        script: |
          trivy image --severity HIGH,CRITICAL --exit-code 0 --format json --output $(Build.ArtifactStagingDirectory)/trivy-${{ parameters.serviceName }}.json ${{ parameters.serviceName }}:${{ parameters.imageTag }}
          trivy image --severity HIGH,CRITICAL --exit-code 1 ${{ parameters.serviceName }}:${{ parameters.imageTag }}
      continueOnError: true

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Trivy Scan Results'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/trivy-${{ parameters.serviceName }}.json'
        artifactName: 'trivy-scan-${{ parameters.serviceName }}'
        publishLocation: 'pipeline'

  - task: Docker@2
    displayName: 'Tag Image with BuildId - ${{ parameters.serviceName }}'
    inputs:
      command: 'tag'
      arguments: '${{ parameters.serviceName }}:${{ parameters.imageTag }} $(containerRegistryUrl)/applyforus-${{ parameters.serviceName }}:${{ parameters.imageTag }}'

  - task: Docker@2
    displayName: 'Tag Image as Latest - ${{ parameters.serviceName }}'
    inputs:
      command: 'tag'
      arguments: '${{ parameters.serviceName }}:${{ parameters.imageTag }} $(containerRegistryUrl)/applyforus-${{ parameters.serviceName }}:latest'

  - ${{ each tag in parameters.additionalTags }}:
    - task: Docker@2
      displayName: 'Tag Image with ${{ tag }} - ${{ parameters.serviceName }}'
      inputs:
        command: 'tag'
        arguments: '${{ parameters.serviceName }}:${{ parameters.imageTag }} $(containerRegistryUrl)/applyforus-${{ parameters.serviceName }}:${{ tag }}'

  - task: Docker@2
    displayName: 'Push Image with BuildId - ${{ parameters.serviceName }}'
    inputs:
      command: 'push'
      repository: 'applyforus-${{ parameters.serviceName }}'
      containerRegistry: '${{ parameters.containerRegistry }}'
      tags: '${{ parameters.imageTag }}'

  - task: Docker@2
    displayName: 'Push Image as Latest - ${{ parameters.serviceName }}'
    inputs:
      command: 'push'
      repository: 'applyforus-${{ parameters.serviceName }}'
      containerRegistry: '${{ parameters.containerRegistry }}'
      tags: 'latest'

  - ${{ each tag in parameters.additionalTags }}:
    - task: Docker@2
      displayName: 'Push Image with ${{ tag }} - ${{ parameters.serviceName }}'
      inputs:
        command: 'push'
        repository: 'applyforus-${{ parameters.serviceName }}'
        containerRegistry: '${{ parameters.containerRegistry }}'
        tags: '${{ tag }}'

  - task: AzureCLI@2
    displayName: 'Update ACR Image Metadata - ${{ parameters.serviceName }}'
    inputs:
      azureSubscription: '$(azureServiceConnection)'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az acr repository update \
          --name $(containerRegistryName) \
          --image applyforus-${{ parameters.serviceName }}:${{ parameters.imageTag }} \
          --write-enabled true \
          --delete-enabled false

# ============================================================================
# Deployment Pipeline - ApplyforUs Platform
# ============================================================================
# Multi-stage CD pipeline for deploying to AKS across environments
#
# This pipeline:
# - Deploys to dev, test, and prod environments
# - Uses Helm charts for Kubernetes deployments
# - Includes manual approval gates for production
# - Performs health checks after deployment
# - Supports rollback capabilities
# - Implements blue-green deployment strategy
#
# Trigger: Manual or triggered after successful build

trigger: none # Manual trigger only

pr: none

resources:
  pipelines:
    - pipeline: buildPipeline
      source: 'ApplyforUs-Build'
      trigger:
        branches:
          include:
            - main
            - develop

parameters:
  - name: environment
    displayName: 'Target Environment'
    type: string
    default: 'dev'
    values:
      - dev
      - test
      - prod

  - name: deploymentStrategy
    displayName: 'Deployment Strategy'
    type: string
    default: 'rolling'
    values:
      - rolling
      - bluegreen
      - canary

  - name: imageTag
    displayName: 'Image Tag (leave empty for latest build)'
    type: string
    default: ''

variables:
  - group: applyforus-common
  - group: applyforus-${{ parameters.environment }}

  # Container Registry
  containerRegistry: 'ApplyforUs-ACR'
  containerRegistryName: 'applyforusacr'
  containerRegistryUrl: '$(containerRegistryName).azurecr.io'

  # AKS Configuration
  aksServiceConnection: 'ApplyforUs-AKS-${{ parameters.environment }}'
  aksResourceGroup: 'applyforus-${{ parameters.environment }}-rg'
  aksClusterName: 'applyforus-${{ parameters.environment }}-aks'
  namespace: 'applyforus-${{ parameters.environment }}'

  # Deployment
  helmChartPath: 'infrastructure/kubernetes'
  deploymentTimeout: '10m'

  # Image Tag
  ${{ if eq(parameters.imageTag, '') }}:
    imageTag: '$(resources.pipeline.buildPipeline.runID)'
  ${{ else }}:
    imageTag: '${{ parameters.imageTag }}'

stages:
  # ============================================================================
  # Stage 1: Pre-Deployment Validation
  # ============================================================================
  - stage: PreDeployment
    displayName: 'Pre-Deployment Checks'
    jobs:
      - job: ValidateEnvironment
        displayName: 'Validate Environment'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Check AKS Cluster Health'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Checking AKS cluster health..."

                # Get cluster status
                az aks show \
                  --resource-group $(aksResourceGroup) \
                  --name $(aksClusterName) \
                  --query "powerState.code" -o tsv

                # Check node status
                echo "Checking node health..."
                az aks get-credentials \
                  --resource-group $(aksResourceGroup) \
                  --name $(aksClusterName) \
                  --overwrite-existing

                kubectl get nodes

                # Check if namespace exists
                kubectl get namespace $(namespace) || kubectl create namespace $(namespace)

          - task: HelmInstaller@1
            displayName: 'Install Helm'
            inputs:
              helmVersionToInstall: 'latest'

          - task: Bash@3
            displayName: 'Validate Helm Charts'
            inputs:
              targetType: 'inline'
              script: |
                cd $(helmChartPath)

                echo "Validating Helm charts..."
                helm lint . || echo "Helm lint warnings detected"

                echo "Dry-run Helm install..."
                helm install applyforus-test . \
                  --dry-run \
                  --debug \
                  --namespace $(namespace) \
                  --set environment=${{ parameters.environment }} \
                  --set image.tag=$(imageTag)

          - task: Bash@3
            displayName: 'Check Image Availability'
            inputs:
              targetType: 'inline'
              script: |
                echo "Verifying Docker images exist in ACR..."

                SERVICES=(
                  "web"
                  "auth-service"
                  "job-service"
                  "resume-service"
                  "user-service"
                  "ai-service"
                  "notification-service"
                  "auto-apply-service"
                  "analytics-service"
                  "orchestrator-service"
                )

                for service in "${SERVICES[@]}"; do
                  echo "Checking applyforus-$service:$(imageTag)"
                  docker pull $(containerRegistryUrl)/applyforus-$service:$(imageTag) || {
                    echo "##vso[task.logissue type=error]Image not found: applyforus-$service:$(imageTag)"
                    exit 1
                  }
                done

                echo "All images are available"

      - job: SecurityChecks
        displayName: 'Security Validation'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Check Azure Policy Compliance'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Checking Azure Policy compliance..."

                az policy state list \
                  --resource-group $(aksResourceGroup) \
                  --query "[?complianceState=='NonCompliant']" \
                  --output table || echo "Policy check completed"

          - task: Bash@3
            displayName: 'Validate Kubernetes Security Policies'
            inputs:
              targetType: 'inline'
              script: |
                echo "Validating Kubernetes security policies..."

                kubectl get psp -A || echo "No PSPs configured"
                kubectl get networkpolicies -n $(namespace) || echo "No network policies"

  # ============================================================================
  # Stage 2: Deploy to Development
  # ============================================================================
  - ${{ if eq(parameters.environment, 'dev') }}:
    - stage: DeployDev
      displayName: 'Deploy to Development'
      dependsOn: PreDeployment
      condition: succeeded()
      jobs:
        - deployment: DeployDevEnvironment
          displayName: 'Deploy to Dev'
          pool:
            vmImage: 'ubuntu-latest'
          environment: 'ApplyforUs-Dev'
          strategy:
            runOnce:
              deploy:
                steps:
                  - checkout: self

                  - template: templates/helm-deploy.yml
                    parameters:
                      serviceName: 'web'
                      environment: 'dev'
                      namespace: '$(namespace)'
                      helmChartPath: '$(helmChartPath)'
                      imageTag: '$(imageTag)'
                      aksServiceConnection: '$(aksServiceConnection)'
                      timeout: '$(deploymentTimeout)'

                  - template: templates/helm-deploy.yml
                    parameters:
                      serviceName: 'auth-service'
                      environment: 'dev'
                      namespace: '$(namespace)'
                      helmChartPath: '$(helmChartPath)'
                      imageTag: '$(imageTag)'
                      aksServiceConnection: '$(aksServiceConnection)'

                  - template: templates/helm-deploy.yml
                    parameters:
                      serviceName: 'job-service'
                      environment: 'dev'
                      namespace: '$(namespace)'
                      helmChartPath: '$(helmChartPath)'
                      imageTag: '$(imageTag)'
                      aksServiceConnection: '$(aksServiceConnection)'

                  - template: templates/helm-deploy.yml
                    parameters:
                      serviceName: 'resume-service'
                      environment: 'dev'
                      namespace: '$(namespace)'
                      helmChartPath: '$(helmChartPath)'
                      imageTag: '$(imageTag)'
                      aksServiceConnection: '$(aksServiceConnection)'

                  - template: templates/helm-deploy.yml
                    parameters:
                      serviceName: 'user-service'
                      environment: 'dev'
                      namespace: '$(namespace)'
                      helmChartPath: '$(helmChartPath)'
                      imageTag: '$(imageTag)'
                      aksServiceConnection: '$(aksServiceConnection)'

                  - template: templates/helm-deploy.yml
                    parameters:
                      serviceName: 'ai-service'
                      environment: 'dev'
                      namespace: '$(namespace)'
                      helmChartPath: '$(helmChartPath)'
                      imageTag: '$(imageTag)'
                      aksServiceConnection: '$(aksServiceConnection)'

                  - template: templates/helm-deploy.yml
                    parameters:
                      serviceName: 'notification-service'
                      environment: 'dev'
                      namespace: '$(namespace)'
                      helmChartPath: '$(helmChartPath)'
                      imageTag: '$(imageTag)'
                      aksServiceConnection: '$(aksServiceConnection)'

                  - template: templates/helm-deploy.yml
                    parameters:
                      serviceName: 'auto-apply-service'
                      environment: 'dev'
                      namespace: '$(namespace)'
                      helmChartPath: '$(helmChartPath)'
                      imageTag: '$(imageTag)'
                      aksServiceConnection: '$(aksServiceConnection)'

                  - template: templates/helm-deploy.yml
                    parameters:
                      serviceName: 'analytics-service'
                      environment: 'dev'
                      namespace: '$(namespace)'
                      helmChartPath: '$(helmChartPath)'
                      imageTag: '$(imageTag)'
                      aksServiceConnection: '$(aksServiceConnection)'

                  - template: templates/helm-deploy.yml
                    parameters:
                      serviceName: 'orchestrator-service'
                      environment: 'dev'
                      namespace: '$(namespace)'
                      helmChartPath: '$(helmChartPath)'
                      imageTag: '$(imageTag)'
                      aksServiceConnection: '$(aksServiceConnection)'

        - job: PostDeploymentTests
          displayName: 'Post-Deployment Tests'
          dependsOn: DeployDevEnvironment
          pool:
            vmImage: 'ubuntu-latest'
          steps:
            - checkout: self

            - task: Bash@3
              displayName: 'Smoke Tests'
              inputs:
                targetType: 'inline'
                script: |
                  echo "Running smoke tests..."

                  # Get service endpoints
                  INGRESS_IP=$(kubectl get svc -n $(namespace) applyforus-web -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

                  if [ -z "$INGRESS_IP" ]; then
                    echo "Warning: External IP not yet assigned"
                    exit 0
                  fi

                  echo "Testing web app at http://$INGRESS_IP"

                  # Health check
                  curl -f http://$INGRESS_IP/health || echo "Health check failed"

                  # API endpoints
                  curl -f http://$INGRESS_IP/api/health || echo "API health check failed"

  # ============================================================================
  # Stage 3: Deploy to Test
  # ============================================================================
  - ${{ if eq(parameters.environment, 'test') }}:
    - stage: DeployTest
      displayName: 'Deploy to Test'
      dependsOn: PreDeployment
      condition: succeeded()
      jobs:
        - deployment: DeployTestEnvironment
          displayName: 'Deploy to Test'
          pool:
            vmImage: 'ubuntu-latest'
          environment: 'ApplyforUs-Test'
          strategy:
            runOnce:
              deploy:
                steps:
                  - checkout: self

                  # Deploy all services (same pattern as dev)
                  - template: templates/helm-deploy.yml
                    parameters:
                      serviceName: 'web'
                      environment: 'test'
                      namespace: '$(namespace)'
                      helmChartPath: '$(helmChartPath)'
                      imageTag: '$(imageTag)'
                      aksServiceConnection: '$(aksServiceConnection)'

                  # Add remaining services...

        - job: IntegrationTests
          displayName: 'Integration Tests'
          dependsOn: DeployTestEnvironment
          pool:
            vmImage: 'ubuntu-latest'
          steps:
            - checkout: self

            - task: Bash@3
              displayName: 'Run Integration Tests'
              inputs:
                targetType: 'inline'
                script: |
                  echo "Running integration tests..."
                  npm ci
                  npm run test:integration

  # ============================================================================
  # Stage 4: Deploy to Production
  # ============================================================================
  - ${{ if eq(parameters.environment, 'prod') }}:
    - stage: DeployProd
      displayName: 'Deploy to Production'
      dependsOn: PreDeployment
      condition: succeeded()
      jobs:
        - job: ManualApproval
          displayName: 'Production Deployment Approval'
          pool: server
          steps:
            - task: ManualValidation@0
              displayName: 'Approve Production Deployment'
              inputs:
                notifyUsers: ''
                instructions: |
                  Please review the following before approving:
                  - Image Tag: $(imageTag)
                  - Environment: Production
                  - Deployment Strategy: ${{ parameters.deploymentStrategy }}

                  This will deploy to the production environment.
                onTimeout: 'reject'

        - deployment: DeployProdEnvironment
          displayName: 'Deploy to Production'
          dependsOn: ManualApproval
          pool:
            vmImage: 'ubuntu-latest'
          environment: 'ApplyforUs-Prod'
          strategy:
            ${{ if eq(parameters.deploymentStrategy, 'rolling') }}:
              rolling:
                maxParallel: 2
                deploy:
                  steps:
                    - checkout: self

                    # Deploy all services with production settings
                    - template: templates/helm-deploy.yml
                      parameters:
                        serviceName: 'web'
                        environment: 'prod'
                        namespace: '$(namespace)'
                        helmChartPath: '$(helmChartPath)'
                        imageTag: '$(imageTag)'
                        aksServiceConnection: '$(aksServiceConnection)'
                        enableRollback: true

            ${{ if eq(parameters.deploymentStrategy, 'bluegreen') }}:
              blueGreen:
                deploy:
                  steps:
                    - checkout: self

                    - task: Bash@3
                      displayName: 'Blue-Green Deployment'
                      inputs:
                        targetType: 'inline'
                        script: |
                          echo "Implementing blue-green deployment..."
                          # Custom blue-green logic here

            ${{ if eq(parameters.deploymentStrategy, 'canary') }}:
              canary:
                increments: [10, 25, 50, 100]
                deploy:
                  steps:
                    - checkout: self

                    - task: Bash@3
                      displayName: 'Canary Deployment'
                      inputs:
                        targetType: 'inline'
                        script: |
                          echo "Implementing canary deployment at $(strategy.increment)%"

  # ============================================================================
  # Stage 5: Post-Deployment Validation
  # ============================================================================
  - stage: PostDeployment
    displayName: 'Post-Deployment Validation'
    condition: succeeded()
    jobs:
      - job: HealthChecks
        displayName: 'Health Checks'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Kubernetes@1
            displayName: 'Check Deployment Status'
            inputs:
              connectionType: 'Kubernetes Service Connection'
              kubernetesServiceEndpoint: '$(aksServiceConnection)'
              namespace: '$(namespace)'
              command: 'get'
              arguments: 'deployments,pods,services -o wide'

          - task: Bash@3
            displayName: 'Application Health Check'
            inputs:
              targetType: 'inline'
              script: |
                echo "Performing comprehensive health checks..."

                # Wait for all pods to be ready
                kubectl wait --for=condition=ready pod \
                  --all \
                  -n $(namespace) \
                  --timeout=300s

                echo "All services are healthy"

      - job: CreateDeploymentReport
        displayName: 'Create Deployment Report'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Bash@3
            displayName: 'Generate Deployment Report'
            inputs:
              targetType: 'inline'
              script: |
                cat > $(Build.ArtifactStagingDirectory)/deployment-report.md << EOF
                # Deployment Report - ApplyforUs Platform

                **Environment:** ${{ parameters.environment }}
                **Date:** $(date)
                **Image Tag:** $(imageTag)
                **Deployment Strategy:** ${{ parameters.deploymentStrategy }}
                **Deployed By:** $(Build.RequestedFor)

                ## Deployment Status

                All services have been successfully deployed to ${{ parameters.environment }}.

                ## Next Steps

                - Monitor application performance in Azure Monitor
                - Review logs in Log Analytics
                - Run smoke tests against the deployed environment

                EOF

                cat $(Build.ArtifactStagingDirectory)/deployment-report.md

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Deployment Report'
            inputs:
              targetPath: '$(Build.ArtifactStagingDirectory)/deployment-report.md'
              artifactName: 'deployment-report-${{ parameters.environment }}'
              publishLocation: 'pipeline'

# ============================================================================
# Azure DevOps Terraform Pipeline for JobPilot AI Platform
# ============================================================================
# Project: https://dev.azure.com/citadelcloudmanagement/ApplyPlatform
# Purpose: Infrastructure as Code deployment using Terraform
#
# Pipeline Features:
# - Terraform init, validate, plan, apply
# - Environment-specific deployments (dev/staging/prod)
# - Manual approval gates for production
# - State management with Azure Storage
# - Cost estimation with Infracost (optional)
# ============================================================================

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - 'infrastructure/terraform/**'

pr:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - 'infrastructure/terraform/**'

# ============================================================================
# Variables
# ============================================================================
variables:
  - name: TF_VERSION
    value: '1.6.0'
  - name: TF_WORKING_DIR
    value: 'infrastructure/terraform'
  - name: ARM_USE_AZUREAD
    value: 'true'

  # Branch conditionals
  - name: isMain
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]
  - name: isDevelop
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/develop')]
  - name: isPR
    value: $[eq(variables['Build.Reason'], 'PullRequest')]

# ============================================================================
# Stages
# ============================================================================
stages:
  # ============================================================================
  # Stage 1: Validate Terraform Configuration
  # ============================================================================
  - stage: Validate
    displayName: 'Validate Terraform'
    jobs:
      - job: Validate
        displayName: 'Terraform Validate'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 0

          - bash: |
              wget -q https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip
              unzip -o terraform_$(TF_VERSION)_linux_amd64.zip
              sudo mv terraform /usr/local/bin/
              terraform version
            displayName: 'Install Terraform $(TF_VERSION)'

          - bash: |
              cd $(TF_WORKING_DIR)
              terraform fmt -check -recursive
            displayName: 'Terraform Format Check'
            continueOnError: true

          - bash: |
              cd $(TF_WORKING_DIR)
              terraform init -backend=false
              terraform validate
            displayName: 'Terraform Validate'

          - bash: |
              curl -sL https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
              cd $(TF_WORKING_DIR)
              tflint --init
              tflint
            displayName: 'TFLint Check'
            continueOnError: true

          - bash: |
              pip install checkov
              cd $(TF_WORKING_DIR)
              checkov -d . --framework terraform --output cli --soft-fail
            displayName: 'Checkov Security Scan'
            continueOnError: true

  # ============================================================================
  # Stage 2: Plan Development Environment
  # ============================================================================
  - stage: PlanDev
    displayName: 'Plan Dev Environment'
    dependsOn: Validate
    condition: and(succeeded(), or(eq(variables.isDevelop, true), eq(variables.isPR, true)))
    variables:
      - group: terraform-dev
    jobs:
      - job: PlanDev
        displayName: 'Terraform Plan (Dev)'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 0

          - bash: |
              wget -q https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip
              unzip -o terraform_$(TF_VERSION)_linux_amd64.zip
              sudo mv terraform /usr/local/bin/
              terraform version
            displayName: 'Install Terraform $(TF_VERSION)'

          - task: AzureCLI@2
            displayName: 'Terraform Init & Plan (Dev)'
            inputs:
              azureSubscription: 'azure-service-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                cd $(TF_WORKING_DIR)

                # Initialize Terraform with Azure backend
                terraform init \
                  -backend-config="resource_group_name=$(TF_STATE_RG)" \
                  -backend-config="storage_account_name=$(TF_STATE_STORAGE)" \
                  -backend-config="container_name=$(TF_STATE_CONTAINER)" \
                  -backend-config="key=dev.terraform.tfstate"

                # Create plan
                terraform plan \
                  -var-file="environments/dev.tfvars" \
                  -out=tfplan-dev \
                  -input=false

                # Show plan summary
                terraform show -no-color tfplan-dev > plan-summary-dev.txt
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)

          - publish: $(TF_WORKING_DIR)/tfplan-dev
            artifact: tfplan-dev
            displayName: 'Publish Dev Plan Artifact'

          - publish: $(TF_WORKING_DIR)/plan-summary-dev.txt
            artifact: plan-summary-dev
            displayName: 'Publish Dev Plan Summary'

  # ============================================================================
  # Stage 3: Apply Development Environment
  # ============================================================================
  - stage: ApplyDev
    displayName: 'Apply Dev Environment'
    dependsOn: PlanDev
    condition: and(succeeded(), eq(variables.isDevelop, true), ne(variables.isPR, true))
    variables:
      - group: terraform-dev
    jobs:
      - deployment: ApplyDev
        displayName: 'Terraform Apply (Dev)'
        environment: 'jobpilot-dev'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  fetchDepth: 0

                - download: current
                  artifact: tfplan-dev
                  displayName: 'Download Dev Plan'

                - bash: |
                    wget -q https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip
                    unzip -o terraform_$(TF_VERSION)_linux_amd64.zip
                    sudo mv terraform /usr/local/bin/
                    terraform version
                  displayName: 'Install Terraform $(TF_VERSION)'

                - task: AzureCLI@2
                  displayName: 'Terraform Apply (Dev)'
                  inputs:
                    azureSubscription: 'azure-service-connection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      cd $(TF_WORKING_DIR)

                      # Initialize Terraform
                      terraform init \
                        -backend-config="resource_group_name=$(TF_STATE_RG)" \
                        -backend-config="storage_account_name=$(TF_STATE_STORAGE)" \
                        -backend-config="container_name=$(TF_STATE_CONTAINER)" \
                        -backend-config="key=dev.terraform.tfstate"

                      # Copy plan from artifact
                      cp $(Pipeline.Workspace)/tfplan-dev/tfplan-dev .

                      # Apply the plan
                      terraform apply -auto-approve tfplan-dev

                      # Output important values
                      echo "##[group]Terraform Outputs"
                      terraform output -json
                      echo "##[endgroup]"
                  env:
                    ARM_CLIENT_ID: $(ARM_CLIENT_ID)
                    ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
                    ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
                    ARM_TENANT_ID: $(ARM_TENANT_ID)

  # ============================================================================
  # Stage 4: Plan Staging Environment
  # ============================================================================
  - stage: PlanStaging
    displayName: 'Plan Staging Environment'
    dependsOn: ApplyDev
    condition: and(succeeded(), eq(variables.isDevelop, true))
    variables:
      - group: terraform-staging
    jobs:
      - job: PlanStaging
        displayName: 'Terraform Plan (Staging)'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 0

          - bash: |
              wget -q https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip
              unzip -o terraform_$(TF_VERSION)_linux_amd64.zip
              sudo mv terraform /usr/local/bin/
              terraform version
            displayName: 'Install Terraform $(TF_VERSION)'

          - task: AzureCLI@2
            displayName: 'Terraform Init & Plan (Staging)'
            inputs:
              azureSubscription: 'azure-service-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                cd $(TF_WORKING_DIR)

                terraform init \
                  -backend-config="resource_group_name=$(TF_STATE_RG)" \
                  -backend-config="storage_account_name=$(TF_STATE_STORAGE)" \
                  -backend-config="container_name=$(TF_STATE_CONTAINER)" \
                  -backend-config="key=staging.terraform.tfstate"

                terraform plan \
                  -var-file="environments/staging.tfvars" \
                  -out=tfplan-staging \
                  -input=false

                terraform show -no-color tfplan-staging > plan-summary-staging.txt
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)

          - publish: $(TF_WORKING_DIR)/tfplan-staging
            artifact: tfplan-staging

          - publish: $(TF_WORKING_DIR)/plan-summary-staging.txt
            artifact: plan-summary-staging

  # ============================================================================
  # Stage 5: Apply Staging Environment
  # ============================================================================
  - stage: ApplyStaging
    displayName: 'Apply Staging Environment'
    dependsOn: PlanStaging
    condition: succeeded()
    variables:
      - group: terraform-staging
    jobs:
      - deployment: ApplyStaging
        displayName: 'Terraform Apply (Staging)'
        environment: 'jobpilot-staging'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  fetchDepth: 0

                - download: current
                  artifact: tfplan-staging

                - bash: |
                    wget -q https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip
                    unzip -o terraform_$(TF_VERSION)_linux_amd64.zip
                    sudo mv terraform /usr/local/bin/
                    terraform version
                  displayName: 'Install Terraform $(TF_VERSION)'

                - task: AzureCLI@2
                  displayName: 'Terraform Apply (Staging)'
                  inputs:
                    azureSubscription: 'azure-service-connection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      cd $(TF_WORKING_DIR)

                      terraform init \
                        -backend-config="resource_group_name=$(TF_STATE_RG)" \
                        -backend-config="storage_account_name=$(TF_STATE_STORAGE)" \
                        -backend-config="container_name=$(TF_STATE_CONTAINER)" \
                        -backend-config="key=staging.terraform.tfstate"

                      cp $(Pipeline.Workspace)/tfplan-staging/tfplan-staging .
                      terraform apply -auto-approve tfplan-staging

                      echo "##[group]Terraform Outputs"
                      terraform output -json
                      echo "##[endgroup]"
                  env:
                    ARM_CLIENT_ID: $(ARM_CLIENT_ID)
                    ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
                    ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
                    ARM_TENANT_ID: $(ARM_TENANT_ID)

  # ============================================================================
  # Stage 6: Plan Production Environment
  # ============================================================================
  - stage: PlanProd
    displayName: 'Plan Production Environment'
    dependsOn: Validate
    condition: and(succeeded(), eq(variables.isMain, true))
    variables:
      - group: terraform-prod
    jobs:
      - job: PlanProd
        displayName: 'Terraform Plan (Production)'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 0

          - bash: |
              wget -q https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip
              unzip -o terraform_$(TF_VERSION)_linux_amd64.zip
              sudo mv terraform /usr/local/bin/
              terraform version
            displayName: 'Install Terraform $(TF_VERSION)'

          - task: AzureCLI@2
            displayName: 'Terraform Init & Plan (Production)'
            inputs:
              azureSubscription: 'azure-service-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                cd $(TF_WORKING_DIR)

                terraform init \
                  -backend-config="resource_group_name=$(TF_STATE_RG)" \
                  -backend-config="storage_account_name=$(TF_STATE_STORAGE)" \
                  -backend-config="container_name=$(TF_STATE_CONTAINER)" \
                  -backend-config="key=prod.terraform.tfstate"

                terraform plan \
                  -var-file="environments/prod.tfvars" \
                  -out=tfplan-prod \
                  -input=false

                terraform show -no-color tfplan-prod > plan-summary-prod.txt
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)

          - publish: $(TF_WORKING_DIR)/tfplan-prod
            artifact: tfplan-prod

          - publish: $(TF_WORKING_DIR)/plan-summary-prod.txt
            artifact: plan-summary-prod

  # ============================================================================
  # Stage 7: Apply Production Environment (Manual Approval Required)
  # ============================================================================
  - stage: ApplyProd
    displayName: 'Apply Production Environment'
    dependsOn: PlanProd
    condition: succeeded()
    variables:
      - group: terraform-prod
    jobs:
      - deployment: ApplyProd
        displayName: 'Terraform Apply (Production)'
        environment: 'jobpilot-prod'  # Requires manual approval
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  fetchDepth: 0

                - download: current
                  artifact: tfplan-prod

                - bash: |
                    wget -q https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip
                    unzip -o terraform_$(TF_VERSION)_linux_amd64.zip
                    sudo mv terraform /usr/local/bin/
                    terraform version
                  displayName: 'Install Terraform $(TF_VERSION)'

                - task: AzureCLI@2
                  displayName: 'Terraform Apply (Production)'
                  inputs:
                    azureSubscription: 'azure-service-connection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      cd $(TF_WORKING_DIR)

                      terraform init \
                        -backend-config="resource_group_name=$(TF_STATE_RG)" \
                        -backend-config="storage_account_name=$(TF_STATE_STORAGE)" \
                        -backend-config="container_name=$(TF_STATE_CONTAINER)" \
                        -backend-config="key=prod.terraform.tfstate"

                      cp $(Pipeline.Workspace)/tfplan-prod/tfplan-prod .
                      terraform apply -auto-approve tfplan-prod

                      echo "##[group]Terraform Outputs"
                      terraform output -json
                      echo "##[endgroup]"
                  env:
                    ARM_CLIENT_ID: $(ARM_CLIENT_ID)
                    ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
                    ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
                    ARM_TENANT_ID: $(ARM_TENANT_ID)

  # ============================================================================
  # Stage 8: Destroy (Manual Trigger Only)
  # ============================================================================
  - stage: Destroy
    displayName: 'Destroy Infrastructure'
    dependsOn: []
    condition: eq(variables['DESTROY_INFRASTRUCTURE'], 'true')
    variables:
      - group: terraform-$(DESTROY_ENVIRONMENT)
    jobs:
      - deployment: Destroy
        displayName: 'Terraform Destroy'
        environment: 'jobpilot-destroy'  # Requires manual approval
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  fetchDepth: 0

                - bash: |
                    wget -q https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip
                    unzip -o terraform_$(TF_VERSION)_linux_amd64.zip
                    sudo mv terraform /usr/local/bin/
                    terraform version
                  displayName: 'Install Terraform $(TF_VERSION)'

                - task: AzureCLI@2
                  displayName: 'Terraform Destroy'
                  inputs:
                    azureSubscription: 'azure-service-connection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      cd $(TF_WORKING_DIR)

                      terraform init \
                        -backend-config="resource_group_name=$(TF_STATE_RG)" \
                        -backend-config="storage_account_name=$(TF_STATE_STORAGE)" \
                        -backend-config="container_name=$(TF_STATE_CONTAINER)" \
                        -backend-config="key=$(DESTROY_ENVIRONMENT).terraform.tfstate"

                      terraform destroy \
                        -var-file="environments/$(DESTROY_ENVIRONMENT).tfvars" \
                        -auto-approve
                  env:
                    ARM_CLIENT_ID: $(ARM_CLIENT_ID)
                    ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
                    ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
                    ARM_TENANT_ID: $(ARM_TENANT_ID)

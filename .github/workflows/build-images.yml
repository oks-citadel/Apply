name: Build Docker Images

# Required GitHub Secrets:
# - ACR_USERNAME: Azure Container Registry service principal username
# - ACR_PASSWORD: Azure Container Registry service principal password
# These secrets should be configured in the repository settings under Settings > Secrets and variables > Actions

on:
  workflow_dispatch:

env:
  ACR_LOGIN_SERVER: applyforusacr.azurecr.io
  IMAGE_PREFIX: applyai
  PNPM_VERSION: '8.15.0'

jobs:
  # Build shared packages first to ensure they're available for Docker builds
  build-dependencies:
    name: Build Shared Packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: |
          ppnpm run build --filter=@jobpilot/types
          ppnpm run build --filter=@jobpilot/security
          ppnpm run build --filter=@jobpilot/telemetry
          ppnpm run build --filter=@jobpilot/logging
          ppnpm run build --filter=@jobpilot/utils
          ppnpm run build --filter=@jobpilot/shared

      - name: Upload built packages
        uses: actions/upload-artifact@v4
        with:
          name: built-packages
          path: |
            packages/*/dist
            packages/*/build
          retention-days: 1

  build:
    name: Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: build-dependencies
    strategy:
      fail-fast: false
      matrix:
        service:
          - web
          - admin
          - employer
          - auth-service
          - user-service
          - job-service
          - resume-service
          - notification-service
          - auto-apply-service
          - analytics-service
          - ai-service
          - orchestrator-service
          - payment-service
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download built packages
        uses: actions/download-artifact@v4
        with:
          name: built-packages
          path: packages/

      - name: Generate Immutable Version Tags
        id: version
        run: |
          VERSION="1.0.$(git rev-list --count HEAD)"
          SHORT_SHA="${GITHUB_SHA:0:8}"
          # Primary tag: sha-<gitsha> (immutable, deployment reference)
          IMAGE_TAG_SHA="sha-${GITHUB_SHA}"
          # Secondary tag: vX.Y.Z-<shortsha> (semantic version alias)
          IMAGE_TAG_VERSION="${VERSION}-${SHORT_SHA}"

          echo "image_tag_sha=$IMAGE_TAG_SHA" >> $GITHUB_OUTPUT
          echo "image_tag_version=$IMAGE_TAG_VERSION" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

          echo "Generated immutable image tags:"
          echo "  - SHA tag: $IMAGE_TAG_SHA"
          echo "  - Version tag: $IMAGE_TAG_VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Determine Dockerfile path
        id: dockerfile
        run: |
          if [ "${{ matrix.service }}" = "web" ]; then
            echo "path=apps/web/Dockerfile" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.service }}" = "admin" ]; then
            echo "path=apps/admin/Dockerfile" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.service }}" = "employer" ]; then
            echo "path=apps/employer/Dockerfile" >> $GITHUB_OUTPUT
          else
            echo "path=services/${{ matrix.service }}/Dockerfile" >> $GITHUB_OUTPUT
          fi

      - name: Build and push ${{ matrix.service }} (immutable tags only)
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ steps.dockerfile.outputs.path }}
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:${{ steps.version.outputs.image_tag_sha }}
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:${{ steps.version.outputs.image_tag_version }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.version=${{ steps.version.outputs.version }}
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      - name: Image built successfully
        run: |
          echo "Successfully built and pushed with IMMUTABLE tags:"
          echo "  - ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:${{ steps.version.outputs.image_tag_sha }}"
          echo "  - ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:${{ steps.version.outputs.image_tag_version }}"
          echo ""
          echo "Image Digest: ${{ steps.build.outputs.digest }}"
          echo "Deploy using: ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}@${{ steps.build.outputs.digest }}"

      - name: Save image digest for deployment
        run: |
          mkdir -p artifacts
          echo "${{ steps.build.outputs.digest }}" > artifacts/${{ matrix.service }}-digest.txt
          echo "${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}@${{ steps.build.outputs.digest }}" > artifacts/${{ matrix.service }}-image-ref.txt

      - name: Upload image digest
        uses: actions/upload-artifact@v4
        with:
          name: image-digest-${{ matrix.service }}
          path: artifacts/
          retention-days: 90

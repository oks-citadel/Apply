name: Terraform Drift Detection

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check'
        required: true
        default: 'all'
        type: choice
        options:
          - dev
          - staging
          - prod
          - all
      auto_fix:
        description: 'Automatically create fix PR'
        required: false
        type: boolean
        default: false

env:
  TF_VERSION: '1.6.0'
  TF_WORKING_DIR: 'infrastructure/terraform'
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

jobs:
  detect-drift:
    name: Detect Drift - ${{ matrix.environment }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        environment: ${{ github.event.inputs.environment == 'all' || github.event.inputs.environment == '' && fromJSON('["dev", "staging", "prod"]') || fromJSON(format('["{0}"]', github.event.inputs.environment)) }}
    outputs:
      drift_dev: ${{ steps.check.outputs.drift_dev }}
      drift_staging: ${{ steps.check.outputs.drift_staging }}
      drift_prod: ${{ steps.check.outputs.drift_prod }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TF_STATE_CONTAINER }}" \
            -backend-config="key=applyforus-${{ matrix.environment }}.tfstate"
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Refresh State
        run: |
          terraform refresh \
            -var-file="environments/${{ matrix.environment }}.tfvars" \
            -no-color
        working-directory: ${{ env.TF_WORKING_DIR }}
        continue-on-error: true

      - name: Check for Drift
        id: check
        run: |
          set +e
          terraform plan \
            -var-file="environments/${{ matrix.environment }}.tfvars" \
            -detailed-exitcode \
            -no-color 2>&1 | tee drift-${{ matrix.environment }}.txt

          exit_code=$?
          set -e

          if [ $exit_code -eq 2 ]; then
            echo "drift_${{ matrix.environment }}=true" >> $GITHUB_OUTPUT
            echo "DRIFT_DETECTED=true" >> $GITHUB_ENV
            echo "::warning::Drift detected in ${{ matrix.environment }} environment!"

            # Extract changed resources
            grep -E "^\s+#|will be|must be" drift-${{ matrix.environment }}.txt > drift-summary-${{ matrix.environment }}.txt || true
          elif [ $exit_code -eq 0 ]; then
            echo "drift_${{ matrix.environment }}=false" >> $GITHUB_OUTPUT
            echo "No drift detected in ${{ matrix.environment }}"
          else
            echo "drift_${{ matrix.environment }}=error" >> $GITHUB_OUTPUT
            echo "::error::Error checking drift in ${{ matrix.environment }}"
          fi
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Upload Drift Report
        if: env.DRIFT_DETECTED == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-${{ matrix.environment }}-${{ github.run_number }}
          path: |
            ${{ env.TF_WORKING_DIR }}/drift-${{ matrix.environment }}.txt
            ${{ env.TF_WORKING_DIR }}/drift-summary-${{ matrix.environment }}.txt
          retention-days: 30

      - name: Generate Drift Summary
        if: env.DRIFT_DETECTED == 'true'
        run: |
          echo "## Drift Detected in ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed Resources" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -100 drift-summary-${{ matrix.environment }}.txt >> $GITHUB_STEP_SUMMARY || echo "No summary available"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Detected at: $(date)*" >> $GITHUB_STEP_SUMMARY
        working-directory: ${{ env.TF_WORKING_DIR }}

  create-issue:
    name: Create Drift Issue
    runs-on: ubuntu-latest
    needs: detect-drift
    if: contains(needs.detect-drift.outputs.*, 'true')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Drift Reports
        uses: actions/download-artifact@v4
        with:
          pattern: drift-report-*
          path: drift-reports/
          merge-multiple: true

      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Check which environments have drift
            const outputs = {
              dev: '${{ needs.detect-drift.outputs.drift_dev }}',
              staging: '${{ needs.detect-drift.outputs.drift_staging }}',
              prod: '${{ needs.detect-drift.outputs.drift_prod }}'
            };

            const driftEnvs = Object.entries(outputs)
              .filter(([env, value]) => value === 'true')
              .map(([env]) => env);

            if (driftEnvs.length === 0) return;

            // Build issue body
            let body = `## Infrastructure Drift Detected

            **Detected at:** ${new Date().toISOString()}
            **Environments affected:** ${driftEnvs.join(', ')}
            **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### Summary

            Terraform has detected configuration drift in the following environments:

            `;

            for (const env of driftEnvs) {
              body += `\n#### ${env.toUpperCase()} Environment\n\n`;
              try {
                const summaryPath = `drift-reports/drift-summary-${env}.txt`;
                if (fs.existsSync(summaryPath)) {
                  const summary = fs.readFileSync(summaryPath, 'utf8');
                  body += `\`\`\`\n${summary.substring(0, 5000)}\n\`\`\`\n`;
                } else {
                  body += `*See artifacts for details*\n`;
                }
              } catch (e) {
                body += `*Could not read drift summary*\n`;
              }
            }

            body += `
            ### Recommended Actions

            1. **Review the drift** - Download the full drift report from the workflow artifacts
            2. **Determine cause** - Check if changes were made manually in Azure
            3. **Fix the drift** - Either:
               - Run \`terraform apply\` to align infrastructure with code
               - Update Terraform code to match current infrastructure
               - Revert manual changes in Azure

            ### Commands to Fix

            \`\`\`bash
            # For each affected environment:
            cd infrastructure/terraform
            terraform init -backend-config="key=applyforus-{ENV}.tfstate"
            terraform plan -var-file="environments/{ENV}.tfvars"
            terraform apply -var-file="environments/{ENV}.tfvars"
            \`\`\`

            ---
            *This issue was automatically created by the Drift Detection workflow*
            `;

            // Check for existing open drift issues
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'infrastructure,drift'
            });

            if (existingIssues.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues[0].number,
                body: `### New Drift Detection Run\n\n${body}`
              });
              console.log(`Updated existing issue #${existingIssues[0].number}`);
            } else {
              // Create new issue
              const { data: issue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Infrastructure Drift Detected - ${driftEnvs.join(', ')}`,
                body: body,
                labels: ['infrastructure', 'drift', 'automated']
              });
              console.log(`Created issue #${issue.number}`);
            }

  auto-fix:
    name: Auto-Fix Drift
    runs-on: ubuntu-latest
    needs: detect-drift
    if: github.event.inputs.auto_fix == 'true' && contains(needs.detect-drift.outputs.*, 'true')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Fix Branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b fix/terraform-drift-${{ github.run_number }}

      - name: Fix Dev Drift
        if: needs.detect-drift.outputs.drift_dev == 'true'
        run: |
          cd ${{ env.TF_WORKING_DIR }}

          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TF_STATE_CONTAINER }}" \
            -backend-config="key=applyforus-dev.tfstate"

          # Pull current state to update tfvars if needed
          terraform show -json > current-state-dev.json

          echo "Dev drift fix prepared - manual review required"

      - name: Commit Changes
        run: |
          git add -A
          git diff --staged --quiet || git commit -m "fix: Terraform drift repair artifacts

          Environments with drift:
          - Dev: ${{ needs.detect-drift.outputs.drift_dev }}
          - Staging: ${{ needs.detect-drift.outputs.drift_staging }}
          - Prod: ${{ needs.detect-drift.outputs.drift_prod }}

          Run: #${{ github.run_number }}"

      - name: Push Branch
        run: |
          git push origin fix/terraform-drift-${{ github.run_number }}

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'fix: Terraform Drift Repair',
              head: `fix/terraform-drift-${{ github.run_number }}`,
              base: 'main',
              body: `## Terraform Drift Auto-Fix

              This PR was automatically created to address infrastructure drift.

              ### Affected Environments
              - Dev: ${{ needs.detect-drift.outputs.drift_dev == 'true' && '⚠️ Drift detected' || '✅ No drift' }}
              - Staging: ${{ needs.detect-drift.outputs.drift_staging == 'true' && '⚠️ Drift detected' || '✅ No drift' }}
              - Production: ${{ needs.detect-drift.outputs.drift_prod == 'true' && '⚠️ Drift detected' || '✅ No drift' }}

              ### Actions Required
              1. Review the changes in this PR
              2. Verify the Terraform plan output
              3. Approve and merge to apply fixes

              ---
              *Auto-generated by Drift Detection workflow*`
            });

            console.log(`Created PR #${pr.number}`);

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: detect-drift
    if: always() && contains(needs.detect-drift.outputs.*, 'true')
    steps:
      - name: Notify Slack
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "⚠️ Infrastructure Drift Detected",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Infrastructure Drift Alert"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Dev:*\n${{ needs.detect-drift.outputs.drift_dev == 'true' && '⚠️ Drift' || '✅ OK' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Staging:*\n${{ needs.detect-drift.outputs.drift_staging == 'true' && '⚠️ Drift' || '✅ OK' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Production:*\n${{ needs.detect-drift.outputs.drift_prod == 'true' && '⚠️ Drift' || '✅ OK' }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

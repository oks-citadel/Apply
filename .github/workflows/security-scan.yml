name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of scan to run'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - sast
          - sca
          - container
          - secrets

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  sast:
    name: SAST - Static Analysis
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'sast' || github.event.inputs.scan_type == ''
    permissions:
      security-events: write
      contents: read
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript, python
          queries: +security-extended

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/typescript
        continue-on-error: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false

      - name: Run ESLint Security Plugin
        run: |
          pnpm install --frozen-lockfile
          npx eslint . --ext .js,.jsx,.ts,.tsx \
            --plugin security \
            --rule 'security/detect-eval-with-expression: error' \
            --rule 'security/detect-non-literal-fs-filename: warn' \
            --rule 'security/detect-non-literal-require: warn' \
            --rule 'security/detect-possible-timing-attacks: warn' \
            --format json --output-file eslint-security-report.json || true

      - name: Upload ESLint results
        uses: actions/upload-artifact@v4
        with:
          name: eslint-security-report
          path: eslint-security-report.json
          retention-days: 30

  sca:
    name: SCA - Dependency Scanning
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'sca' || github.event.inputs.scan_type == ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run npm audit
        run: |
          npm audit --json > npm-audit-report.json || true
          npm audit --audit-level=high || echo "::warning::High severity vulnerabilities found"

      - name: Run Snyk for Node.js
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --all-projects --severity-threshold=high --json-file-output=snyk-node-report.json

      - name: Run Snyk for Python
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --file=services/ai-service/requirements.txt --severity-threshold=high

      - name: Check for outdated dependencies
        run: |
          npm outdated --json > outdated-deps.json || true
          echo "### Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
          jq -r 'to_entries[] | "- \(.key): \(.value.current) → \(.value.latest)"' outdated-deps.json >> $GITHUB_STEP_SUMMARY || true

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SCA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sca-reports
          path: |
            npm-audit-report.json
            snyk-node-report.json
            outdated-deps.json
            sbom.spdx.json
          retention-days: 30

  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'container' || github.event.inputs.scan_type == ''
    strategy:
      fail-fast: false
      matrix:
        service: [web, auth-service, job-service, ai-service]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine Dockerfile
        id: dockerfile
        run: |
          if [ "${{ matrix.service }}" = "web" ]; then
            echo "path=apps/web/Dockerfile" >> $GITHUB_OUTPUT
          else
            echo "path=services/${{ matrix.service }}/Dockerfile" >> $GITHUB_OUTPUT
          fi

      - name: Build image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ steps.dockerfile.outputs.path }}
          push: false
          load: true
          tags: scan-${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: scan-${{ matrix.service }}:latest
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH'
          vuln-type: 'os,library'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true  # Dont fail if Advanced Security not enabled
        with:
          sarif_file: trivy-${{ matrix.service }}.sarif
        continue-on-error: true

      - name: Run Grype scan
        uses: anchore/scan-action@v3
        with:
          image: scan-${{ matrix.service }}:latest
          fail-build: false
          severity-cutoff: high
          output-format: sarif

      - name: Scan Dockerfile with Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ${{ steps.dockerfile.outputs.path }}
          format: sarif
          output-file: hadolint-${{ matrix.service }}.sarif
          failure-threshold: error

      - name: Upload container scan results
        uses: actions/upload-artifact@v4
        with:
          name: container-scan-${{ matrix.service }}
          path: |
            trivy-${{ matrix.service }}.sarif
            hadolint-${{ matrix.service }}.sarif
          retention-days: 30

  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'secrets' || github.event.inputs.scan_type == ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          extra_args: --only-verified
        continue-on-error: true

      - name: Custom secrets check
        run: |
          echo "Checking for common secret patterns..."

          # Check for API keys, passwords, etc.
          PATTERNS=(
            "AKIA[0-9A-Z]{16}"  # AWS Access Key
            "sk_live_[a-zA-Z0-9]{24}"  # Stripe Live Key
            "sk_test_[a-zA-Z0-9]{24}"  # Stripe Test Key
            "ghp_[a-zA-Z0-9]{36}"  # GitHub PAT
            "npm_[a-zA-Z0-9]{36}"  # npm token
          )

          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -rE "$pattern" --include="*.ts" --include="*.js" --include="*.json" --include="*.env*" --exclude-dir=node_modules . 2>/dev/null; then
              echo "::warning::Potential secret found matching pattern: $pattern"
              FOUND=1
            fi
          done

          if [ $FOUND -eq 0 ]; then
            echo "✅ No obvious secrets found"
          fi

  infrastructure-scan:
    name: Infrastructure Security
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov on Terraform
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: infrastructure/terraform
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,checkov-terraform.sarif
          soft_fail: true

      - name: Run Checkov on Kubernetes
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: infrastructure/kubernetes
          framework: kubernetes
          output_format: cli,sarif
          output_file_path: console,checkov-k8s.sarif
          soft_fail: true

      - name: Run Checkov on Dockerfiles
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: dockerfile
          output_format: cli,sarif
          output_file_path: console,checkov-docker.sarif
          soft_fail: true

      - name: Upload infrastructure scan results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true  # Dont fail if Advanced Security not enabled
        with:
          sarif_file: checkov-terraform.sarif
        continue-on-error: true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-scan-results
          path: |
            checkov-*.sarif
          retention-days: 30

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [sast, sca, container-scan, secrets-scan, infrastructure-scan]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-reports/

      - name: Generate security report
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SAST (CodeQL/Semgrep) | ${{ needs.sast.result == 'success' && '✅ Passed' || '⚠️ Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SCA (Dependencies) | ${{ needs.sca.result == 'success' && '✅ Passed' || '⚠️ Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Security | ${{ needs.container-scan.result == 'success' && '✅ Passed' || '⚠️ Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets Detection | ${{ needs.secrets-scan.result == 'success' && '✅ Passed' || '⚠️ Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ needs.infrastructure-scan.result == 'success' && '✅ Passed' || '⚠️ Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Scan completed at: $(date)*" >> $GITHUB_STEP_SUMMARY

      - name: Notify on critical findings
        if: contains(needs.*.result, 'failure')
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "⚠️ Security Scan Found Issues",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Security Scan Results"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Security scans have identified potential issues. Please review the scan results."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Results"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

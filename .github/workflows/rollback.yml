name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - staging
          - production
      target-sha:
        description: 'Git SHA to rollback to (leave empty for previous deployment)'
        required: false
        type: string
      service:
        description: 'Specific service to rollback (leave empty for all services)'
        required: false
        type: choice
        options:
          - all
          - web
          - auth-service
          - user-service
          - job-service
          - resume-service
          - notification-service
          - auto-apply-service
          - ai-service
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

env:
  REGISTRY: jobpilotacr.azurecr.io

jobs:
  validate-rollback:
    name: Validate Rollback Request
    runs-on: ubuntu-latest
    outputs:
      validated: ${{ steps.validate.outputs.validated }}
      target-sha: ${{ steps.validate.outputs.target-sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate rollback request
        id: validate
        run: |
          echo "Validating rollback request..."
          echo "Environment: ${{ inputs.environment }}"
          echo "Target SHA: ${{ inputs.target-sha || 'previous deployment' }}"
          echo "Service: ${{ inputs.service }}"
          echo "Reason: ${{ inputs.reason }}"

          # If no target SHA provided, get the previous deployment SHA
          if [ -z "${{ inputs.target-sha }}" ]; then
            # Get the previous commit
            target_sha=$(git rev-parse HEAD~1)
            echo "No target SHA provided, using previous commit: $target_sha"
          else
            target_sha="${{ inputs.target-sha }}"

            # Validate that the SHA exists
            if ! git cat-file -e $target_sha 2>/dev/null; then
              echo "Error: Invalid git SHA: $target_sha"
              exit 1
            fi
          fi

          echo "target-sha=$target_sha" >> $GITHUB_OUTPUT
          echo "validated=true" >> $GITHUB_OUTPUT

      - name: Post rollback initiation to Slack
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "⚠️ Rollback Initiated",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Rollback Initiated*\n*Environment:* ${{ inputs.environment }}\n*Service:* ${{ inputs.service }}\n*Initiated by:* ${{ github.actor }}\n*Reason:* ${{ inputs.reason }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  rollback-staging:
    name: Rollback Staging
    runs-on: ubuntu-latest
    needs: validate-rollback
    if: inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.jobpilot.ai
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-rollback.outputs.target-sha }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS context
        uses: azure/aks-set-context@v4
        with:
          resource-group: jobpilot-staging-rg
          cluster-name: jobpilot-staging-aks

      - name: Create backup before rollback
        run: |
          echo "Creating backup before rollback..."
          mkdir -p rollback-backup
          timestamp=$(date +%Y%m%d-%H%M%S)

          services="${{ inputs.service == 'all' && 'web auth-service user-service job-service resume-service notification-service auto-apply-service ai-service' || inputs.service }}"

          for service in $services; do
            kubectl get deployment/$service -n jobpilot -o yaml > rollback-backup/$service-$timestamp.yaml || echo "Deployment $service not found"
          done

      - name: Upload rollback backup
        uses: actions/upload-artifact@v4
        with:
          name: rollback-backup-staging-${{ github.run_id }}
          path: rollback-backup/
          retention-days: 90

      - name: Perform rollback
        run: |
          echo "Rolling back to SHA: ${{ needs.validate-rollback.outputs.target-sha }}"

          services="${{ inputs.service == 'all' && 'web auth-service user-service job-service resume-service notification-service auto-apply-service ai-service' || inputs.service }}"

          for service in $services; do
            echo "Rolling back $service..."

            # Set image to the target SHA
            kubectl set image deployment/$service \
              $service=${{ env.REGISTRY }}/$service:${{ needs.validate-rollback.outputs.target-sha }} \
              -n jobpilot

            # Wait for rollback to complete
            if ! kubectl rollout status deployment/$service -n jobpilot --timeout=600s; then
              echo "Rollback failed for $service"
              exit 1
            fi

            echo "$service rolled back successfully"
            sleep 10
          done

      - name: Verify rollback
        run: |
          echo "Verifying rollback..."
          sleep 30

          # Run basic health checks
          curl -f --retry 3 --retry-delay 10 https://staging.jobpilot.ai/health || exit 1
          curl -f --retry 3 --retry-delay 10 https://staging-api.jobpilot.ai/health || exit 1

          echo "Rollback verification successful"

      - name: Post rollback success
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "✅ Staging Rollback Successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Staging Rollback Successful*\n*Environment:* staging\n*Service:* ${{ inputs.service }}\n*Rolled back to:* ${{ needs.validate-rollback.outputs.target-sha }}\n*Reason:* ${{ inputs.reason }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Post rollback failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "❌ Staging Rollback Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*CRITICAL: Staging Rollback Failed*\n*Environment:* staging\n*Service:* ${{ inputs.service }}\n*Manual intervention required*"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  rollback-production:
    name: Rollback Production
    runs-on: ubuntu-latest
    needs: validate-rollback
    if: inputs.environment == 'production'
    environment:
      name: production-rollback
      url: https://jobpilot.ai
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-rollback.outputs.target-sha }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS context
        uses: azure/aks-set-context@v4
        with:
          resource-group: jobpilot-prod-rg
          cluster-name: jobpilot-prod-aks

      - name: Create backup before rollback
        run: |
          echo "Creating backup before production rollback..."
          mkdir -p rollback-backup
          timestamp=$(date +%Y%m%d-%H%M%S)

          services="${{ inputs.service == 'all' && 'web auth-service user-service job-service resume-service notification-service auto-apply-service ai-service' || inputs.service }}"

          for service in $services; do
            kubectl get deployment/$service -n jobpilot -o yaml > rollback-backup/$service-$timestamp.yaml || echo "Deployment $service not found"

            # Also backup blue/green deployments for web
            if [ "$service" = "web" ]; then
              kubectl get deployment/web-blue -n jobpilot -o yaml > rollback-backup/web-blue-$timestamp.yaml || true
              kubectl get deployment/web-green -n jobpilot -o yaml > rollback-backup/web-green-$timestamp.yaml || true
            fi
          done

      - name: Upload rollback backup
        uses: actions/upload-artifact@v4
        with:
          name: rollback-backup-production-${{ github.run_id }}
          path: rollback-backup/
          retention-days: 365

      - name: Notify before production rollback
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "⚠️ Production Rollback Starting",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Rollback Starting*\n*Service:* ${{ inputs.service }}\n*Target SHA:* ${{ needs.validate-rollback.outputs.target-sha }}\n*Reason:* ${{ inputs.reason }}\n*Initiated by:* ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Perform production rollback
        run: |
          echo "Rolling back production to SHA: ${{ needs.validate-rollback.outputs.target-sha }}"

          services="${{ inputs.service == 'all' && 'web auth-service user-service job-service resume-service notification-service auto-apply-service ai-service' || inputs.service }}"

          for service in $services; do
            echo "Rolling back $service..."

            if [ "$service" = "web" ]; then
              # Special handling for web (Blue/Green)
              CURRENT=$(kubectl get service web -n jobpilot -o jsonpath='{.spec.selector.version}' 2>/dev/null || echo "blue")
              ROLLBACK_TARGET=$([ "$CURRENT" = "blue" ] && echo "green" || echo "blue")

              echo "Current active: $CURRENT, Rolling back to: $ROLLBACK_TARGET"

              # Update the target deployment
              kubectl set image deployment/web-$ROLLBACK_TARGET \
                web=${{ env.REGISTRY }}/web:${{ needs.validate-rollback.outputs.target-sha }} \
                -n jobpilot

              if ! kubectl rollout status deployment/web-$ROLLBACK_TARGET -n jobpilot --timeout=600s; then
                echo "Rollback failed for web"
                exit 1
              fi

              # Switch traffic
              kubectl patch service web -n jobpilot -p "{\"spec\":{\"selector\":{\"version\":\"$ROLLBACK_TARGET\"}}}"
            else
              # Standard rollback for services
              kubectl set image deployment/$service \
                $service=${{ env.REGISTRY }}/$service:${{ needs.validate-rollback.outputs.target-sha }} \
                -n jobpilot

              if ! kubectl rollout status deployment/$service -n jobpilot --timeout=600s; then
                echo "Rollback failed for $service"
                exit 1
              fi
            fi

            echo "$service rolled back successfully"
            sleep 15
          done

      - name: Verify production rollback
        run: |
          echo "Verifying production rollback..."
          sleep 60

          # Comprehensive health checks
          for i in {1..5}; do
            if curl -f --max-time 30 https://jobpilot.ai/health; then
              echo "Web health check passed"
              break
            fi
            if [ $i -eq 5 ]; then
              echo "Web health check failed after 5 attempts"
              exit 1
            fi
            sleep 10
          done

          curl -f --max-time 30 https://api.jobpilot.ai/health || exit 1
          curl -f --max-time 30 https://api.jobpilot.ai/auth/health || exit 1

          echo "Production rollback verification successful"

      - name: Monitor post-rollback metrics
        run: |
          echo "Monitoring post-rollback metrics..."
          sleep 120

          # Check pod status
          kubectl get pods -n jobpilot

          # Check for any failing pods
          failed_pods=$(kubectl get pods -n jobpilot --field-selector=status.phase!=Running --no-headers | wc -l)
          if [ $failed_pods -gt 0 ]; then
            echo "Warning: $failed_pods pods are not running"
            kubectl get pods -n jobpilot --field-selector=status.phase!=Running
          else
            echo "All pods running successfully"
          fi

      - name: Create rollback incident record
        run: |
          echo "Creating rollback incident record..."
          kubectl annotate deployment/web -n jobpilot \
            incident.kubernetes.io/rollback-date="$(date)" \
            incident.kubernetes.io/rollback-reason="${{ inputs.reason }}" \
            incident.kubernetes.io/rollback-by="${{ github.actor }}" \
            incident.kubernetes.io/rollback-from-sha="${{ github.sha }}" \
            incident.kubernetes.io/rollback-to-sha="${{ needs.validate-rollback.outputs.target-sha }}" \
            --overwrite

      - name: Post rollback success
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "✅ Production Rollback Successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Rollback Successful*\n*Environment:* production\n*Service:* ${{ inputs.service }}\n*Rolled back to:* ${{ needs.validate-rollback.outputs.target-sha }}\n*Reason:* ${{ inputs.reason }}\n*Completed by:* ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Post rollback failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "❌ CRITICAL: Production Rollback Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*CRITICAL: Production Rollback Failed*\n*Environment:* production\n*Service:* ${{ inputs.service }}\n*IMMEDIATE MANUAL INTERVENTION REQUIRED*\n*Contact:* DevOps Team"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  post-rollback-tests:
    name: Post-Rollback Tests
    runs-on: ubuntu-latest
    needs: [rollback-staging, rollback-production]
    if: always() && (needs.rollback-staging.result == 'success' || needs.rollback-production.result == 'success')
    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ inputs.environment }}" = "staging" ]; then
            echo "base-url=https://staging.jobpilot.ai" >> $GITHUB_OUTPUT
            echo "api-url=https://staging-api.jobpilot.ai" >> $GITHUB_OUTPUT
          else
            echo "base-url=https://jobpilot.ai" >> $GITHUB_OUTPUT
            echo "api-url=https://api.jobpilot.ai" >> $GITHUB_OUTPUT
          fi

      - name: Run smoke tests
        uses: ./.github/workflows/smoke-tests.yml
        with:
          environment: ${{ inputs.environment }}
          base-url: ${{ steps.env.outputs.base-url }}
          api-url: ${{ steps.env.outputs.api-url }}

# ============================================================================
# DOCKER BUILD WORKFLOW
# ============================================================================
# Builds and pushes Docker images to Azure Container Registry
# Can be triggered manually or reused by other workflows
# ============================================================================

name: Build Docker Images

on:
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to build (comma-separated or "all")'
        required: true
        default: 'all'
        type: string
      tag:
        description: 'Image tag'
        required: false
        default: ''
        type: string
      push:
        description: 'Push to registry'
        required: true
        default: true
        type: boolean
  workflow_call:
    inputs:
      services:
        description: 'Services to build'
        required: false
        default: 'all'
        type: string
      tag:
        description: 'Image tag'
        required: false
        default: ''
        type: string
      push:
        description: 'Push to registry'
        required: false
        default: true
        type: boolean
    outputs:
      image_tag:
        description: 'The image tag that was built'
        value: ${{ jobs.setup.outputs.image_tag }}

env:
  ACR_NAME: applyforusacr
  ACR_LOGIN_SERVER: applyforusacr.azurecr.io
  IMAGE_PREFIX: applyai

permissions:
  id-token: write
  contents: read
  packages: write

jobs:
  setup:
    name: Setup Build
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.tag.outputs.value }}
      matrix: ${{ steps.matrix.outputs.value }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate image tag
        id: tag
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          else
            SHORT_SHA=$(git rev-parse --short HEAD)
            DATE=$(date +%Y%m%d%H%M%S)
            TAG="${DATE}-${SHORT_SHA}"
          fi
          echo "value=${TAG}" >> $GITHUB_OUTPUT
          echo "Image tag: ${TAG}"

      - name: Generate build matrix
        id: matrix
        run: |
          ALL_SERVICES='[
            {"name":"web","path":"apps/web","port":"3000"},
            {"name":"auth-service","path":"services/auth-service","port":"8001"},
            {"name":"user-service","path":"services/user-service","port":"8002"},
            {"name":"job-service","path":"services/job-service","port":"8003"},
            {"name":"resume-service","path":"services/resume-service","port":"8004"},
            {"name":"notification-service","path":"services/notification-service","port":"8005"},
            {"name":"auto-apply-service","path":"services/auto-apply-service","port":"8006"},
            {"name":"analytics-service","path":"services/analytics-service","port":"8007"},
            {"name":"ai-service","path":"services/ai-service","port":"8000"},
            {"name":"orchestrator-service","path":"services/orchestrator-service","port":"8010"},
            {"name":"payment-service","path":"services/payment-service","port":"8009"}
          ]'

          SERVICES_INPUT="${{ inputs.services }}"

          if [ "$SERVICES_INPUT" == "all" ] || [ -z "$SERVICES_INPUT" ]; then
            echo "value=${ALL_SERVICES}" >> $GITHUB_OUTPUT
          else
            # Filter to only requested services
            FILTERED=$(echo "$ALL_SERVICES" | jq --arg services "$SERVICES_INPUT" '[.[] | select(.name as $n | ($services | split(",") | map(gsub("^\\s+|\\s+$";"")) | contains([$n])))]')
            echo "value=${FILTERED}" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build ${{ matrix.service.name }}
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.setup.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check Dockerfile
        id: dockerfile
        run: |
          if [ -f "${{ matrix.service.path }}/Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Dockerfile found at ${{ matrix.service.path }}/Dockerfile"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No Dockerfile at ${{ matrix.service.path }}/Dockerfile"
          fi

      - name: Azure Login (OIDC)
        if: steps.dockerfile.outputs.exists == 'true' && inputs.push
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        if: steps.dockerfile.outputs.exists == 'true' && inputs.push
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Extract metadata
        id: meta
        if: steps.dockerfile.outputs.exists == 'true'
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service.name }}
          tags: |
            type=raw,value=${{ needs.setup.outputs.image_tag }}
            type=raw,value=latest
            type=sha,prefix=

      - name: Build and push
        if: steps.dockerfile.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.service.path }}/Dockerfile
          push: ${{ inputs.push }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service.name }}
          build-args: |
            NODE_ENV=production
            BUILD_DATE=${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
            SERVICE_NAME=${{ matrix.service.name }}
            SERVICE_PORT=${{ matrix.service.port }}

      - name: Image Summary
        if: steps.dockerfile.outputs.exists == 'true'
        run: |
          echo "## ${{ matrix.service.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ needs.setup.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Pushed:** ${{ inputs.push }}" >> $GITHUB_STEP_SUMMARY

  scan:
    name: Scan Images
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: inputs.push
    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run vulnerability scan
        run: |
          echo "## Container Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get list of images from this build
          IMAGES=$(az acr repository list --name ${{ env.ACR_NAME }} -o tsv | grep "^${{ env.IMAGE_PREFIX }}")

          for IMAGE in $IMAGES; do
            echo "### ${IMAGE}" >> $GITHUB_STEP_SUMMARY

            # Check if the image with our tag exists
            TAG_EXISTS=$(az acr repository show-tags --name ${{ env.ACR_NAME }} --repository "$IMAGE" --query "contains(@, '${{ needs.setup.outputs.image_tag }}')" -o tsv 2>/dev/null || echo "false")

            if [ "$TAG_EXISTS" == "true" ]; then
              echo "- Tag: \`${{ needs.setup.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "- Tag not found in this build" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          done

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [setup, build, scan]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${{ needs.setup.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** \`${{ env.ACR_LOGIN_SERVER }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Push:** ${{ inputs.push }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Scan | ${{ needs.scan.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY

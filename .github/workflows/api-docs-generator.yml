name: API Documentation Generator

on:
  push:
    branches: [main, develop]
    paths:
      - 'services/**/src/**'
      - 'services/**/package.json'
      - 'apps/web/src/app/api/**'
  workflow_dispatch:
    inputs:
      generate_postman:
        description: 'Generate Postman collection'
        required: false
        type: boolean
        default: true
      generate_tests:
        description: 'Generate API tests'
        required: false
        type: boolean
        default: true

env:
  NODE_VERSION: '20'

jobs:
  extract-endpoints:
    name: Extract API Endpoints
    runs-on: ubuntu-latest
    outputs:
      endpoints_file: ${{ steps.extract.outputs.endpoints_file }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Extract endpoints from services
        id: extract
        run: |
          mkdir -p api-docs

          # Create endpoint extraction script
          cat > extract-endpoints.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const glob = require('glob');

          const endpoints = {
            version: '1.0.0',
            generated: new Date().toISOString(),
            services: {}
          };

          // Service configurations
          const services = {
            'auth-service': { port: 8001, basePath: '/auth' },
            'user-service': { port: 8002, basePath: '/users' },
            'resume-service': { port: 8003, basePath: '/resumes' },
            'job-service': { port: 8004, basePath: '/jobs' },
            'auto-apply-service': { port: 8005, basePath: '/applications' },
            'analytics-service': { port: 8006, basePath: '/analytics' },
            'notification-service': { port: 8007, basePath: '/notifications' },
            'orchestrator-service': { port: 8008, basePath: '/orchestrator' },
            'payment-service': { port: 8009, basePath: '/payments' }
          };

          // Common endpoints for all services
          const commonEndpoints = [
            { method: 'GET', path: '/health', description: 'Health check endpoint' }
          ];

          // Service-specific endpoints
          const serviceEndpoints = {
            'auth-service': [
              { method: 'POST', path: '/login', description: 'User login' },
              { method: 'POST', path: '/register', description: 'User registration' },
              { method: 'POST', path: '/refresh', description: 'Refresh access token' },
              { method: 'POST', path: '/logout', description: 'User logout' },
              { method: 'GET', path: '/me', description: 'Get current user' },
              { method: 'POST', path: '/forgot-password', description: 'Request password reset' },
              { method: 'POST', path: '/reset-password', description: 'Reset password' },
              { method: 'POST', path: '/verify-email', description: 'Verify email address' },
              { method: 'POST', path: '/2fa/setup', description: 'Setup 2FA' },
              { method: 'POST', path: '/2fa/verify', description: 'Verify 2FA code' },
              { method: 'GET', path: '/oauth/google', description: 'Google OAuth' },
              { method: 'GET', path: '/oauth/linkedin', description: 'LinkedIn OAuth' },
              { method: 'GET', path: '/oauth/github', description: 'GitHub OAuth' }
            ],
            'user-service': [
              { method: 'GET', path: '/:id', description: 'Get user by ID' },
              { method: 'PUT', path: '/:id', description: 'Update user profile' },
              { method: 'DELETE', path: '/:id', description: 'Delete user' },
              { method: 'GET', path: '/:id/preferences', description: 'Get user preferences' },
              { method: 'PUT', path: '/:id/preferences', description: 'Update user preferences' },
              { method: 'GET', path: '/:id/subscription', description: 'Get user subscription' }
            ],
            'job-service': [
              { method: 'GET', path: '/', description: 'List jobs' },
              { method: 'GET', path: '/:id', description: 'Get job by ID' },
              { method: 'POST', path: '/search', description: 'Search jobs' },
              { method: 'GET', path: '/match', description: 'Get job matches' },
              { method: 'POST', path: '/save/:id', description: 'Save job' },
              { method: 'DELETE', path: '/save/:id', description: 'Unsave job' },
              { method: 'GET', path: '/saved', description: 'Get saved jobs' },
              { method: 'GET', path: '/recommended', description: 'Get recommended jobs' }
            ],
            'resume-service': [
              { method: 'GET', path: '/', description: 'List resumes' },
              { method: 'POST', path: '/', description: 'Create resume' },
              { method: 'GET', path: '/:id', description: 'Get resume by ID' },
              { method: 'PUT', path: '/:id', description: 'Update resume' },
              { method: 'DELETE', path: '/:id', description: 'Delete resume' },
              { method: 'POST', path: '/parse', description: 'Parse resume file' },
              { method: 'POST', path: '/:id/optimize', description: 'Optimize resume with AI' },
              { method: 'GET', path: '/:id/download', description: 'Download resume' },
              { method: 'GET', path: '/templates', description: 'List resume templates' }
            ],
            'auto-apply-service': [
              { method: 'GET', path: '/', description: 'List applications' },
              { method: 'POST', path: '/', description: 'Submit application' },
              { method: 'GET', path: '/:id', description: 'Get application by ID' },
              { method: 'PUT', path: '/:id', description: 'Update application' },
              { method: 'DELETE', path: '/:id', description: 'Withdraw application' },
              { method: 'GET', path: '/stats', description: 'Get application stats' },
              { method: 'POST', path: '/auto-apply', description: 'Start auto-apply job' }
            ],
            'analytics-service': [
              { method: 'GET', path: '/dashboard', description: 'Get dashboard data' },
              { method: 'GET', path: '/applications', description: 'Get application analytics' },
              { method: 'GET', path: '/success-rate', description: 'Get success rate' },
              { method: 'GET', path: '/trends', description: 'Get trends' },
              { method: 'POST', path: '/events', description: 'Track event' }
            ],
            'notification-service': [
              { method: 'GET', path: '/', description: 'List notifications' },
              { method: 'POST', path: '/email', description: 'Send email' },
              { method: 'POST', path: '/push', description: 'Send push notification' },
              { method: 'PUT', path: '/:id/read', description: 'Mark as read' },
              { method: 'PUT', path: '/read-all', description: 'Mark all as read' },
              { method: 'GET', path: '/preferences', description: 'Get notification preferences' },
              { method: 'PUT', path: '/preferences', description: 'Update notification preferences' }
            ],
            'payment-service': [
              { method: 'GET', path: '/subscriptions', description: 'List subscriptions' },
              { method: 'POST', path: '/subscriptions', description: 'Create subscription' },
              { method: 'GET', path: '/subscriptions/:id', description: 'Get subscription' },
              { method: 'PUT', path: '/subscriptions/:id', description: 'Update subscription' },
              { method: 'DELETE', path: '/subscriptions/:id', description: 'Cancel subscription' },
              { method: 'GET', path: '/invoices', description: 'List invoices' },
              { method: 'GET', path: '/invoices/:id', description: 'Get invoice' },
              { method: 'POST', path: '/checkout', description: 'Create checkout session' },
              { method: 'POST', path: '/webhooks/stripe', description: 'Stripe webhook' }
            ]
          };

          // Build endpoints object
          Object.entries(services).forEach(([name, config]) => {
            endpoints.services[name] = {
              ...config,
              endpoints: [
                ...commonEndpoints,
                ...(serviceEndpoints[name] || [])
              ].map(ep => ({
                ...ep,
                fullPath: `${config.basePath}${ep.path}`
              }))
            };
          });

          // Write endpoints file
          fs.writeFileSync('api-docs/endpoints.json', JSON.stringify(endpoints, null, 2));
          console.log('Endpoints extracted successfully');
          EOF

          node extract-endpoints.js
          echo "endpoints_file=api-docs/endpoints.json" >> $GITHUB_OUTPUT

      - name: Upload endpoints artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-endpoints
          path: api-docs/endpoints.json
          retention-days: 30

  generate-openapi:
    name: Generate OpenAPI Spec
    runs-on: ubuntu-latest
    needs: extract-endpoints
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download endpoints
        uses: actions/download-artifact@v4
        with:
          name: api-endpoints
          path: api-docs/

      - name: Generate OpenAPI spec
        run: |
          cat > generate-openapi.js << 'EOF'
          const fs = require('fs');

          const endpoints = JSON.parse(fs.readFileSync('api-docs/endpoints.json', 'utf8'));

          const openapi = {
            openapi: '3.0.3',
            info: {
              title: 'ApplyForUs API',
              description: 'API documentation for the ApplyForUs job application platform',
              version: endpoints.version,
              contact: {
                name: 'ApplyForUs Support',
                email: 'support@applyforus.com'
              }
            },
            servers: [
              { url: 'https://api.applyforus.com', description: 'Production' },
              { url: 'https://staging-api.applyforus.com', description: 'Staging' },
              { url: 'http://localhost:8000', description: 'Local development' }
            ],
            tags: Object.keys(endpoints.services).map(name => ({
              name: name.replace('-service', ''),
              description: `${name} endpoints`
            })),
            paths: {},
            components: {
              securitySchemes: {
                bearerAuth: {
                  type: 'http',
                  scheme: 'bearer',
                  bearerFormat: 'JWT'
                }
              },
              schemas: {
                Error: {
                  type: 'object',
                  properties: {
                    statusCode: { type: 'integer' },
                    message: { type: 'string' },
                    error: { type: 'string' }
                  }
                },
                HealthCheck: {
                  type: 'object',
                  properties: {
                    status: { type: 'string', enum: ['ok', 'error'] },
                    timestamp: { type: 'string', format: 'date-time' },
                    service: { type: 'string' }
                  }
                }
              }
            },
            security: [{ bearerAuth: [] }]
          };

          // Generate paths
          Object.entries(endpoints.services).forEach(([serviceName, service]) => {
            service.endpoints.forEach(endpoint => {
              const path = endpoint.fullPath.replace(/:(\w+)/g, '{$1}');

              if (!openapi.paths[path]) {
                openapi.paths[path] = {};
              }

              openapi.paths[path][endpoint.method.toLowerCase()] = {
                tags: [serviceName.replace('-service', '')],
                summary: endpoint.description,
                operationId: `${serviceName}_${endpoint.method}_${endpoint.path.replace(/[/:]/g, '_')}`,
                responses: {
                  '200': {
                    description: 'Successful response'
                  },
                  '400': {
                    description: 'Bad request',
                    content: {
                      'application/json': {
                        schema: { $ref: '#/components/schemas/Error' }
                      }
                    }
                  },
                  '401': {
                    description: 'Unauthorized'
                  },
                  '404': {
                    description: 'Not found'
                  },
                  '500': {
                    description: 'Internal server error'
                  }
                }
              };

              // Add path parameters
              const params = endpoint.path.match(/:(\w+)/g);
              if (params) {
                openapi.paths[path][endpoint.method.toLowerCase()].parameters = params.map(p => ({
                  name: p.substring(1),
                  in: 'path',
                  required: true,
                  schema: { type: 'string' }
                }));
              }

              // Health endpoints don't require auth
              if (endpoint.path === '/health') {
                openapi.paths[path][endpoint.method.toLowerCase()].security = [];
              }
            });
          });

          fs.writeFileSync('api-docs/openapi.yaml', require('yaml').stringify(openapi));
          fs.writeFileSync('api-docs/openapi.json', JSON.stringify(openapi, null, 2));
          console.log('OpenAPI spec generated');
          EOF

          npm install yaml
          node generate-openapi.js

      - name: Upload OpenAPI spec
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: |
            api-docs/openapi.yaml
            api-docs/openapi.json
          retention-days: 30

  generate-postman:
    name: Generate Postman Collection
    runs-on: ubuntu-latest
    needs: [extract-endpoints, generate-openapi]
    if: github.event.inputs.generate_postman != 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: api-docs/

      - name: Generate Postman collection
        run: |
          mkdir -p postman

          cat > generate-postman.js << 'EOF'
          const fs = require('fs');

          const endpoints = JSON.parse(fs.readFileSync('api-docs/api-endpoints/endpoints.json', 'utf8'));

          const collection = {
            info: {
              name: 'ApplyForUs API',
              description: 'Complete API collection for ApplyForUs platform',
              schema: 'https://schema.getpostman.com/json/collection/v2.1.0/collection.json',
              version: endpoints.version
            },
            auth: {
              type: 'bearer',
              bearer: [{ key: 'token', value: '{{access_token}}', type: 'string' }]
            },
            variable: [
              { key: 'base_url', value: 'https://api.applyforus.com', type: 'string' },
              { key: 'access_token', value: '', type: 'string' }
            ],
            item: []
          };

          // Create folders for each service
          Object.entries(endpoints.services).forEach(([serviceName, service]) => {
            const folder = {
              name: serviceName.replace('-service', '').toUpperCase(),
              description: `${serviceName} endpoints`,
              item: service.endpoints.map(endpoint => ({
                name: endpoint.description,
                request: {
                  method: endpoint.method,
                  header: [
                    { key: 'Content-Type', value: 'application/json' }
                  ],
                  url: {
                    raw: `{{base_url}}${endpoint.fullPath}`,
                    host: ['{{base_url}}'],
                    path: endpoint.fullPath.split('/').filter(Boolean)
                  },
                  description: endpoint.description
                },
                response: []
              }))
            };

            // Add request bodies for POST/PUT methods
            folder.item.forEach(item => {
              if (['POST', 'PUT', 'PATCH'].includes(item.request.method)) {
                item.request.body = {
                  mode: 'raw',
                  raw: JSON.stringify({}, null, 2),
                  options: { raw: { language: 'json' } }
                };
              }
            });

            collection.item.push(folder);
          });

          // Add authentication folder
          collection.item.unshift({
            name: 'Authentication',
            description: 'Authentication flows',
            item: [
              {
                name: 'Login',
                event: [{
                  listen: 'test',
                  script: {
                    exec: [
                      'var jsonData = pm.response.json();',
                      'if (jsonData.accessToken) {',
                      '    pm.collectionVariables.set("access_token", jsonData.accessToken);',
                      '}'
                    ],
                    type: 'text/javascript'
                  }
                }],
                request: {
                  method: 'POST',
                  url: { raw: '{{base_url}}/auth/login' },
                  body: {
                    mode: 'raw',
                    raw: JSON.stringify({ email: '', password: '' }, null, 2),
                    options: { raw: { language: 'json' } }
                  }
                }
              }
            ]
          });

          fs.writeFileSync('postman/ApplyForUs-API.postman_collection.json', JSON.stringify(collection, null, 2));

          // Create environment files
          const environments = ['development', 'staging', 'production'];
          const envUrls = {
            development: 'http://localhost:8000',
            staging: 'https://staging-api.applyforus.com',
            production: 'https://api.applyforus.com'
          };

          environments.forEach(env => {
            const envFile = {
              name: `ApplyForUs - ${env}`,
              values: [
                { key: 'base_url', value: envUrls[env], enabled: true },
                { key: 'access_token', value: '', enabled: true }
              ]
            };
            fs.writeFileSync(`postman/${env}.postman_environment.json`, JSON.stringify(envFile, null, 2));
          });

          console.log('Postman collection generated');
          EOF

          node generate-postman.js

      - name: Upload Postman collection
        uses: actions/upload-artifact@v4
        with:
          name: postman-collection
          path: postman/
          retention-days: 30

      - name: Commit Postman collection
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          cp postman/* ./postman/ 2>/dev/null || true
          git add postman/
          git diff --staged --quiet || git commit -m "docs: Update Postman collection [skip ci]"
          git push || true
        continue-on-error: true

  generate-api-tests:
    name: Generate API Tests
    runs-on: ubuntu-latest
    needs: extract-endpoints
    if: github.event.inputs.generate_tests != 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download endpoints
        uses: actions/download-artifact@v4
        with:
          name: api-endpoints
          path: api-docs/

      - name: Generate Jest E2E tests
        run: |
          mkdir -p tests/api

          cat > generate-tests.js << 'EOF'
          const fs = require('fs');

          const endpoints = JSON.parse(fs.readFileSync('api-docs/endpoints.json', 'utf8'));

          Object.entries(endpoints.services).forEach(([serviceName, service]) => {
            const testFile = `
          import request from 'supertest';

          const BASE_URL = process.env.API_URL || 'http://localhost:8000';

          describe('${serviceName}', () => {
            let authToken: string;

            beforeAll(async () => {
              // Get auth token for authenticated requests
              const response = await request(BASE_URL)
                .post('/auth/login')
                .send({ email: process.env.TEST_EMAIL, password: process.env.TEST_PASSWORD });
              authToken = response.body.accessToken;
            });

          ${service.endpoints.map(endpoint => `
            describe('${endpoint.method} ${endpoint.fullPath}', () => {
              it('should ${endpoint.description.toLowerCase()}', async () => {
                const response = await request(BASE_URL)
                  .${endpoint.method.toLowerCase()}('${endpoint.fullPath.replace(/:(\w+)/g, 'test-$1')}')
                  ${endpoint.path !== '/health' ? ".set('Authorization', \\`Bearer \\${authToken}\\`)" : ''}
                  .expect('Content-Type', /json/);

                ${endpoint.path === '/health'
                  ? "expect(response.body).toHaveProperty('status');"
                  : "expect(response.status).toBeLessThan(500);"}
              });
            });
          `).join('\n')}
          });
          `;

            fs.writeFileSync(`tests/api/${serviceName}.test.ts`, testFile);
          });

          console.log('API tests generated');
          EOF

          node generate-tests.js

      - name: Upload generated tests
        uses: actions/upload-artifact@v4
        with:
          name: api-tests
          path: tests/api/
          retention-days: 30

  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [extract-endpoints, generate-openapi, generate-postman, generate-api-tests]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## API Documentation Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoints Extraction | ${{ needs.extract-endpoints.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OpenAPI Spec | ${{ needs.generate-openapi.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Postman Collection | ${{ needs.generate-postman.result == 'success' && '✅' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Tests | ${{ needs.generate-api-tests.result == 'success' && '✅' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Generated at: $(date)*" >> $GITHUB_STEP_SUMMARY

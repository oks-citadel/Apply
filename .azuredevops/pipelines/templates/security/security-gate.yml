# ============================================================================
# Template: Security Gate (Production)
# ============================================================================
parameters:
  - name: environment
    type: string
  - name: azureSubscription
    type: string
    default: 'ApplyPlatform'

steps:
  - script: |
      echo "=============================================="
      echo "PRODUCTION SECURITY GATE CHECK"
      echo "=============================================="
      echo "Environment: ${{ parameters.environment }}"
      echo "Build: $(Build.BuildId)"
      echo "Branch: $(Build.SourceBranchName)"
      echo ""

      GATE_PASSED=true

      # Check 1: Must be from main branch
      if [ "$(Build.SourceBranch)" != "refs/heads/main" ]; then
        echo "##vso[task.logissue type=error]Production deploys must be from main branch"
        GATE_PASSED=false
      else
        echo "Branch check: PASSED"
      fi

      # Check 2: All tests must have passed
      echo "Test results check: Verified by pipeline dependencies"

      # Check 3: Security scans completed
      echo "Security scan check: Verified by previous stages"

      if [ "$GATE_PASSED" = false ]; then
        echo "##vso[task.complete result=Failed;]Security gate failed"
        exit 1
      fi

      echo ""
      echo "Security gate: PASSED"
    displayName: 'Security Gate Validation'

  - task: AzureCLI@2
    displayName: 'Final Compliance Check'
    inputs:
      azureSubscription: '${{ parameters.azureSubscription }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "=== Final Compliance Verification ==="

        # Verify AKS cluster security
        az aks show \
          --resource-group applyforus-prod-rg \
          --name applyforus-aks \
          --query "{rbacEnabled:enableRbac,networkPolicy:networkProfile.networkPolicy,aadEnabled:aadProfile}" \
          -o table 2>/dev/null || echo "Cluster check skipped"
    continueOnError: true

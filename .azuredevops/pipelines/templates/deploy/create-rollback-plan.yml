# ============================================================================
# Template: Create Rollback Plan
# ============================================================================
parameters:
  - name: namespace
    type: string
  - name: azureSubscription
    type: string
    default: 'ApplyPlatform'

steps:
  - task: AzureCLI@2
    displayName: 'Create Rollback Plan'
    inputs:
      azureSubscription: '${{ parameters.azureSubscription }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "=============================================="
        echo "CREATING ROLLBACK PLAN"
        echo "=============================================="

        # Get AKS credentials
        az aks get-credentials \
          --resource-group applyforus-prod-rg \
          --name applyforus-aks \
          --overwrite-existing

        mkdir -p $(Build.ArtifactStagingDirectory)/rollback

        # Capture current deployment state
        echo "=== Capturing Current Deployment State ==="

        SERVICES="web auth-service user-service job-service resume-service notification-service analytics-service ai-service auto-apply-service orchestrator-service"

        for service in $SERVICES; do
          echo "Capturing: $service"

          # Get current image
          CURRENT_IMAGE=$(kubectl get deployment $service -n ${{ parameters.namespace }} -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null || echo "not-deployed")

          # Get current replica count
          REPLICAS=$(kubectl get deployment $service -n ${{ parameters.namespace }} -o jsonpath='{.spec.replicas}' 2>/dev/null || echo "1")

          # Get current revision
          REVISION=$(kubectl rollout history deployment/$service -n ${{ parameters.namespace }} 2>/dev/null | tail -2 | head -1 | awk '{print $1}' || echo "0")

          echo "$service|$CURRENT_IMAGE|$REPLICAS|$REVISION" >> $(Build.ArtifactStagingDirectory)/rollback/deployment-state.txt
        done

        # Create rollback script
        cat > $(Build.ArtifactStagingDirectory)/rollback/rollback.sh << 'ROLLBACK_EOF'
        #!/bin/bash
        # Rollback Script - Generated by Pipeline
        # Build: $(Build.BuildId)
        # Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)

        NAMESPACE="${1:-${{ parameters.namespace }}}"

        echo "Rolling back deployments in $NAMESPACE..."

        while IFS='|' read -r service image replicas revision; do
          echo "Rolling back $service to revision $revision"
          kubectl rollout undo deployment/$service -n $NAMESPACE --to-revision=$revision 2>/dev/null || echo "Rollback failed for $service"
        done < deployment-state.txt

        echo "Rollback complete"
        ROLLBACK_EOF

        chmod +x $(Build.ArtifactStagingDirectory)/rollback/rollback.sh

        echo ""
        echo "=== Rollback Plan Created ==="
        cat $(Build.ArtifactStagingDirectory)/rollback/deployment-state.txt
    continueOnError: true

  - task: PublishPipelineArtifact@1
    displayName: 'Publish Rollback Plan'
    inputs:
      targetPath: '$(Build.ArtifactStagingDirectory)/rollback'
      artifact: 'rollback-plan-$(Build.BuildId)'
      publishLocation: 'pipeline'

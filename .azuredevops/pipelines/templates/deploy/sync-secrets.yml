# ============================================================================
# Template: Sync Secrets from Key Vault
# ============================================================================
parameters:
  - name: environment
    type: string
  - name: keyVaultName
    type: string
  - name: namespace
    type: string
  - name: azureSubscription
    type: string
    default: 'ApplyPlatform'

steps:
  - task: AzureCLI@2
    displayName: 'Sync Secrets from Key Vault'
    inputs:
      azureSubscription: '${{ parameters.azureSubscription }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "=== Syncing Secrets for ${{ parameters.environment }} ==="

        # Get AKS credentials
        az aks get-credentials \
          --resource-group applyforus-prod-rg \
          --name applyforus-aks \
          --overwrite-existing

        # Create Kubernetes secret from Key Vault (if Key Vault exists)
        KV_EXISTS=$(az keyvault show --name ${{ parameters.keyVaultName }}-${{ parameters.environment }} 2>/dev/null && echo "yes" || echo "no")

        if [ "$KV_EXISTS" = "yes" ]; then
          echo "Fetching secrets from Key Vault..."

          # Fetch common secrets
          DB_CONNECTION=$(az keyvault secret show --vault-name ${{ parameters.keyVaultName }}-${{ parameters.environment }} --name database-connection-string --query value -o tsv 2>/dev/null || echo "")
          REDIS_CONNECTION=$(az keyvault secret show --vault-name ${{ parameters.keyVaultName }}-${{ parameters.environment }} --name redis-connection-string --query value -o tsv 2>/dev/null || echo "")
          JWT_SECRET=$(az keyvault secret show --vault-name ${{ parameters.keyVaultName }}-${{ parameters.environment }} --name jwt-secret --query value -o tsv 2>/dev/null || echo "default-jwt-secret")

          # Create/update Kubernetes secret
          kubectl create secret generic app-secrets \
            --from-literal=DATABASE_URL="${DB_CONNECTION:-postgresql://localhost:5432/applyforus}" \
            --from-literal=REDIS_URL="${REDIS_CONNECTION:-redis://localhost:6379}" \
            --from-literal=JWT_SECRET="${JWT_SECRET}" \
            --namespace=${{ parameters.namespace }} \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "Secrets synced successfully"
        else
          echo "Key Vault not found, using default secrets"

          # Create default secrets for development
          kubectl create secret generic app-secrets \
            --from-literal=DATABASE_URL="postgresql://localhost:5432/applyforus" \
            --from-literal=REDIS_URL="redis://localhost:6379" \
            --from-literal=JWT_SECRET="dev-jwt-secret-$(Build.BuildId)" \
            --namespace=${{ parameters.namespace }} \
            --dry-run=client -o yaml | kubectl apply -f -
        fi

        echo "Secret sync complete"
    continueOnError: true

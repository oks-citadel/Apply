version: 0.2

# AWS CodeBuild buildspec for deploying to EKS
# Simplified for initial deployment

env:
  variables:
    CLUSTER_NAME: "applyforus-dev"
    NAMESPACE: "applyforus"

phases:
  install:
    commands:
      - echo "Installing kubectl..."
      - curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
      - chmod +x kubectl
      - mv kubectl /usr/local/bin/

      - echo "Installing kustomize..."
      - curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
      - mv kustomize /usr/local/bin/

  pre_build:
    commands:
      - echo "Configuring kubectl for EKS..."
      - aws eks update-kubeconfig --region $AWS_DEFAULT_REGION --name $CLUSTER_NAME

      - echo "Verifying cluster access..."
      - kubectl cluster-info
      - kubectl get nodes

      - export IMAGE_TAG=${CODEBUILD_RESOLVED_SOURCE_VERSION:0:8}
      - export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
      - export ECR_REGISTRY=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
      - echo "Deploying with IMAGE_TAG=$IMAGE_TAG to ECR_REGISTRY=$ECR_REGISTRY"

  build:
    commands:
      - echo "Creating namespace if not exists..."
      - kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

      - echo "Deploying web app to Kubernetes..."
      - |
        cat <<EOF | kubectl apply -f -
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: web-app
          namespace: $NAMESPACE
          labels:
            app: web
        spec:
          replicas: 2
          selector:
            matchLabels:
              app: web
          template:
            metadata:
              labels:
                app: web
            spec:
              containers:
              - name: web
                image: $ECR_REGISTRY/applyai-web:$IMAGE_TAG
                ports:
                - containerPort: 3000
                env:
                - name: NODE_ENV
                  value: "production"
                - name: NEXT_PUBLIC_API_URL
                  value: "https://api.applyforus.com"
                resources:
                  requests:
                    memory: "256Mi"
                    cpu: "100m"
                  limits:
                    memory: "512Mi"
                    cpu: "500m"
                readinessProbe:
                  httpGet:
                    path: /
                    port: 3000
                  initialDelaySeconds: 10
                  periodSeconds: 5
                livenessProbe:
                  httpGet:
                    path: /
                    port: 3000
                  initialDelaySeconds: 30
                  periodSeconds: 10
        EOF

      - echo "Creating service..."
      - |
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: Service
        metadata:
          name: web-app
          namespace: $NAMESPACE
          annotations:
            service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
            service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
        spec:
          type: LoadBalancer
          selector:
            app: web
          ports:
          - port: 80
            targetPort: 3000
            protocol: TCP
        EOF

      - echo "Waiting for deployment rollout..."
      - kubectl rollout status deployment/web-app -n $NAMESPACE --timeout=300s

  post_build:
    commands:
      - echo "Deployment completed!"
      - kubectl get pods -n $NAMESPACE
      - kubectl get services -n $NAMESPACE

      - echo "Getting Load Balancer URL..."
      - |
        for i in {1..30}; do
          LB_URL=$(kubectl get svc web-app -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null)
          if [ -n "$LB_URL" ]; then
            echo "Load Balancer URL: $LB_URL"
            echo "$LB_URL" > deployment-url.txt
            break
          fi
          echo "Waiting for Load Balancer... ($i/30)"
          sleep 10
        done

      - echo "Deployment to $NAMESPACE completed at $(date)"
      - echo "IMAGE_TAG=$IMAGE_TAG" > deployment-status.txt
      - echo "NAMESPACE=$NAMESPACE" >> deployment-status.txt

artifacts:
  files:
    - deployment-status.txt
    - deployment-url.txt
  discard-paths: yes

# Kustomization file for JobPilot Monitoring Stack
# This file defines all monitoring resources including Prometheus, Grafana, and AlertManager
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: jobpilot-monitoring
  annotations:
    description: "Complete monitoring stack for JobPilot AI Platform"

# Namespace for all monitoring resources
namespace: jobpilot

# Common labels applied to all resources
commonLabels:
  app.kubernetes.io/part-of: jobpilot-monitoring
  app.kubernetes.io/managed-by: kustomize
  environment: production

# Common annotations applied to all resources
commonAnnotations:
  maintained-by: "platform-team@jobpilot.com"
  documentation: "https://docs.jobpilot.com/monitoring"

# Resources included in this kustomization
resources:
  # Prometheus components
  - prometheus.yaml
  - prometheus-rules.yaml

  # AlertManager components
  - alertmanager.yaml
  - alertmanager-config.yaml
  - alertmanager-deployment.yaml

  # Grafana components
  - grafana.yaml
  - dashboards-configmap.yaml

  # Loki components (log aggregation)
  - loki.yaml

# ConfigMap generator for additional configurations
configMapGenerator:
  # AlertManager notification templates
  - name: alertmanager-templates
    files:
      - templates/slack.tmpl
      - templates/email.tmpl
      - templates/pagerduty.tmpl
    options:
      labels:
        app: alertmanager
        component: templates
      annotations:
        description: "Notification templates for AlertManager"

# Secret generator for sensitive configuration
# Note: In production, use sealed-secrets or external secret management
secretGenerator:
  # Monitoring credentials
  - name: monitoring-secrets
    envs:
      - secrets.env
    options:
      labels:
        app: monitoring
      annotations:
        description: "Monitoring system credentials"

# Images to use (allows easy version management)
images:
  - name: prom/prometheus
    newTag: v2.48.0
  - name: prom/alertmanager
    newTag: v0.26.0
  - name: grafana/grafana
    newTag: 10.2.2
  - name: grafana/loki
    newTag: 2.9.3
  - name: grafana/promtail
    newTag: 2.9.3

# Patches to apply to resources
patches:
  # Patch Prometheus to use new rules ConfigMap
  - patch: |-
      - op: add
        path: /spec/template/spec/volumes/-
        value:
          name: prometheus-rules
          configMap:
            name: prometheus-rules
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          name: prometheus-rules
          mountPath: /etc/prometheus/rules
          readOnly: true
    target:
      kind: Deployment
      name: prometheus

# Replacements for cross-resource field references
replacements:
  # Use AlertManager service name in Prometheus config
  - source:
      kind: Service
      name: alertmanager
      fieldPath: metadata.name
    targets:
      - select:
          kind: ConfigMap
          name: prometheus-config
        fieldPaths:
          - data.[prometheus.yml]
        options:
          delimiter: ':'
          index: 0

# Strategic merge patches for environment-specific overrides
patchesStrategicMerge:
  # Production-specific patches can be added here
  # - patches/production.yaml

# JSON patches for more complex modifications
patchesJson6902: []

# Configurations
configurations:
  # Reference to kustomize configuration files
  - kustomizeconfig.yaml

# Vars for template substitution (deprecated but shown for reference)
# Use replacements instead in newer Kustomize versions
vars: []

# Generators
generators: []

# Transformers
transformers: []

# Build options
buildMetadata:
  - managedByLabel
  - originAnnotations

# Labels to add to all resources
labels:
  - pairs:
      platform: kubernetes
      stack: monitoring
    includeSelectors: true
    includeTemplates: true

# Replicas override (can be patched per environment)
replicas:
  - name: prometheus
    count: 1
  - name: alertmanager
    count: 3
  - name: grafana
    count: 2

apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
  labels:
    app: alertmanager
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
      smtp_smarthost: 'smtp.sendgrid.net:587'
      smtp_from: 'alerts@applyforus.com'
      smtp_auth_username: 'apikey'
      # smtp_auth_password is set via secret

    # Route configuration
    route:
      group_by: ['alertname', 'service', 'severity']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      receiver: 'default-receiver'
      routes:
        # Critical alerts go to PagerDuty
        - match:
            severity: critical
          receiver: 'pagerduty-critical'
          continue: true

        # Warning alerts go to Slack
        - match:
            severity: warning
          receiver: 'slack-warnings'

        # Business metrics go to product team
        - match:
            team: product
          receiver: 'slack-product'

        # Platform alerts go to platform team
        - match:
            team: platform
          receiver: 'slack-platform'

    # Inhibition rules
    inhibit_rules:
      # If a critical alert fires, suppress warnings for the same alertname and service
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'service']

    # Receivers configuration
    receivers:
      - name: 'default-receiver'
        email_configs:
          - to: 'ops@applyforus.com'
            send_resolved: true
        webhook_configs:
          - url: 'http://alertmanager-webhook:9000/alert'
            send_resolved: true

      - name: 'pagerduty-critical'
        pagerduty_configs:
          - routing_key: '${PAGERDUTY_ROUTING_KEY}'
            severity: critical
            description: '{{ .CommonAnnotations.summary }}'
            details:
              firing: '{{ template "pagerduty.default.instances" .Alerts.Firing }}'
              resolved: '{{ template "pagerduty.default.instances" .Alerts.Resolved }}'
              num_firing: '{{ .Alerts.Firing | len }}'
              num_resolved: '{{ .Alerts.Resolved | len }}'

      - name: 'slack-warnings'
        slack_configs:
          - api_url: '${SLACK_WEBHOOK_URL}'
            channel: '#alerts-warnings'
            send_resolved: true
            icon_emoji: ':warning:'
            title: '[{{ .Status | toUpper }}] {{ .CommonLabels.alertname }}'
            text: |
              *Alert:* {{ .CommonLabels.alertname }}
              *Severity:* {{ .CommonLabels.severity }}
              *Service:* {{ .CommonLabels.service }}
              *Summary:* {{ .CommonAnnotations.summary }}
              *Description:* {{ .CommonAnnotations.description }}
              *Runbook:* {{ .CommonAnnotations.runbook_url }}

      - name: 'slack-platform'
        slack_configs:
          - api_url: '${SLACK_WEBHOOK_URL}'
            channel: '#platform-alerts'
            send_resolved: true
            icon_emoji: ':robot_face:'
            title: '[{{ .Status | toUpper }}] {{ .CommonLabels.alertname }}'
            text: |
              *Alert:* {{ .CommonLabels.alertname }}
              *Severity:* {{ .CommonLabels.severity }}
              *Service:* {{ .CommonLabels.service }}
              *Summary:* {{ .CommonAnnotations.summary }}
              *Description:* {{ .CommonAnnotations.description }}

      - name: 'slack-product'
        slack_configs:
          - api_url: '${SLACK_WEBHOOK_URL}'
            channel: '#product-alerts'
            send_resolved: true
            icon_emoji: ':chart_with_upwards_trend:'
            title: '[{{ .Status | toUpper }}] {{ .CommonLabels.alertname }}'
            text: |
              *Alert:* {{ .CommonLabels.alertname }}
              *Summary:* {{ .CommonAnnotations.summary }}
              *Description:* {{ .CommonAnnotations.description }}

    # Templates
    templates:
      - '/etc/alertmanager/templates/*.tmpl'
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager
  namespace: monitoring
  labels:
    app: alertmanager
spec:
  replicas: 1
  selector:
    matchLabels:
      app: alertmanager
  template:
    metadata:
      labels:
        app: alertmanager
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        fsGroup: 65534
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: alertmanager
          image: prom/alertmanager:v0.26.0
          imagePullPolicy: IfNotPresent
          args:
            - "--config.file=/etc/alertmanager/alertmanager.yml"
            - "--storage.path=/alertmanager"
            - "--cluster.listen-address="
            - "--web.external-url=https://alertmanager.applyforus.com"
          ports:
            - containerPort: 9093
              name: http
              protocol: TCP
          env:
            - name: PAGERDUTY_ROUTING_KEY
              valueFrom:
                secretKeyRef:
                  name: alertmanager-secrets
                  key: pagerduty-routing-key
                  optional: true
            - name: SLACK_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: alertmanager-secrets
                  key: slack-webhook-url
                  optional: true
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
          volumeMounts:
            - name: config
              mountPath: /etc/alertmanager/alertmanager.yml
              subPath: alertmanager.yml
            - name: storage
              mountPath: /alertmanager
          livenessProbe:
            httpGet:
              path: /-/healthy
              port: 9093
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /-/ready
              port: 9093
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 65534
            capabilities:
              drop:
                - ALL
      volumes:
        - name: config
          configMap:
            name: alertmanager-config
        - name: storage
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: alertmanager
  namespace: monitoring
  labels:
    app: alertmanager
spec:
  type: ClusterIP
  selector:
    app: alertmanager
  ports:
    - port: 9093
      targetPort: 9093
      protocol: TCP
      name: http
---
# ============================================================================
# Alertmanager Secrets - MANAGED VIA AZURE KEY VAULT OR SEALED SECRETS
# ============================================================================
# DO NOT store actual secrets in this file.
#
# In production, create the secret manually or via sealed-secrets:
# kubectl create secret generic alertmanager-secrets \
#   --namespace=monitoring \
#   --from-literal=pagerduty-routing-key='YOUR_PAGERDUTY_KEY' \
#   --from-literal=slack-webhook-url='YOUR_SLACK_WEBHOOK_URL'
#
# Or use Azure Key Vault with SecretProviderClass for the monitoring namespace.
# ============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-secrets
  namespace: monitoring
  labels:
    app: alertmanager
  annotations:
    # Mark this as a placeholder - actual secrets should be managed externally
    applyforus.com/secret-management: "azure-keyvault"
    applyforus.com/placeholder: "true"
type: Opaque
# NOTE: Remove stringData section in production. Secrets should be injected
# via Azure Key Vault CSI Driver or created manually with kubectl.
# This placeholder exists only for initial cluster setup/testing.
stringData:
  # PLACEHOLDER VALUES - REPLACE IN PRODUCTION
  pagerduty-routing-key: "PLACEHOLDER_CHANGE_IN_PRODUCTION"
  slack-webhook-url: "PLACEHOLDER_CHANGE_IN_PRODUCTION"

# AlertManager Configuration for JobPilot AI Platform
# This configuration defines routing, grouping, and notification channels for alerts
# Supports multiple notification channels: Email, Slack, PagerDuty
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: jobpilot
  labels:
    app: alertmanager
    component: configuration
data:
  alertmanager.yml: |
    # ============================================================================
    # Global Configuration
    # Default settings for all notification channels
    # ============================================================================
    global:
      # Time to wait before sending a notification about a new group of alerts
      resolve_timeout: 5m

      # SMTP configuration for email notifications (SendGrid)
      smtp_from: 'alerts@jobpilot.com'
      smtp_smarthost: 'smtp.sendgrid.net:587'
      smtp_auth_username: 'apikey'
      smtp_auth_password: '${SENDGRID_API_KEY}'
      smtp_require_tls: true
      smtp_hello: 'jobpilot.com'

      # HTTP client configuration
      http_config:
        follow_redirects: true

      # Slack API URL (set via environment variable for security)
      slack_api_url: '${SLACK_API_URL}'

      # PagerDuty API URL
      pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

    # ============================================================================
    # Templates
    # Custom notification templates for better alert formatting
    # ============================================================================
    templates:
    - '/etc/alertmanager/templates/*.tmpl'

    # ============================================================================
    # Routing Configuration
    # Define how alerts are routed to different notification channels
    # ============================================================================
    route:
      # Default receiver for all alerts
      receiver: 'default-receiver'

      # Group alerts by these labels to reduce notification spam
      group_by: ['alertname', 'cluster', 'service', 'severity']

      # How long to wait before sending the first notification for a new group
      group_wait: 10s

      # How long to wait before sending notifications about new alerts added to a group
      group_interval: 5m

      # How long to wait before re-sending a notification
      repeat_interval: 4h

      # Child routes for specific alert types
      routes:
      # ========================================================================
      # Critical Alerts Route
      # Goes to PagerDuty, Slack, and Email immediately
      # ========================================================================
      - match:
          severity: critical
        receiver: 'critical-alerts'
        group_wait: 10s
        group_interval: 5m
        repeat_interval: 1h
        continue: false  # Stop processing after this route

      # ========================================================================
      # Warning Alerts Route
      # Goes to Slack and Email with longer grouping intervals
      # ========================================================================
      - match:
          severity: warning
        receiver: 'warning-alerts'
        group_wait: 30s
        group_interval: 10m
        repeat_interval: 4h
        continue: false

      # ========================================================================
      # Database Alerts Route
      # Database issues get special handling
      # ========================================================================
      - match_re:
          category: 'database|cache'
        receiver: 'database-alerts'
        group_by: ['alertname', 'instance']
        group_wait: 10s
        repeat_interval: 2h
        continue: true  # Continue to check other routes

      # ========================================================================
      # Business Metrics Route
      # Product and business teams need to be notified
      # ========================================================================
      - match:
          category: business
        receiver: 'business-alerts'
        group_wait: 1m
        group_interval: 15m
        repeat_interval: 6h
        continue: true

      # ========================================================================
      # Infrastructure Alerts Route
      # Platform team handles infrastructure issues
      # ========================================================================
      - match:
          category: infrastructure
        receiver: 'infrastructure-alerts'
        group_wait: 10s
        repeat_interval: 2h
        continue: true

    # ============================================================================
    # Inhibition Rules
    # Prevent notification spam by suppressing redundant alerts
    # ============================================================================
    inhibit_rules:
    # Critical alerts suppress warning alerts for the same service
    - source_match:
        severity: 'critical'
      target_match:
        severity: 'warning'
      equal: ['alertname', 'cluster', 'service', 'namespace']

    # ServiceDown suppresses all other alerts for the same service
    - source_match:
        alertname: 'ServiceDown'
      target_match_re:
        alertname: '.*'
      equal: ['service', 'namespace']

    # NodeNotReady suppresses pod-related alerts on that node
    - source_match:
        alertname: 'NodeNotReady'
      target_match_re:
        alertname: 'Pod.*'
      equal: ['node']

    # PostgresDown suppresses connection and lag alerts
    - source_match:
        alertname: 'PostgresDown'
      target_match_re:
        alertname: 'Postgres.*'
      equal: ['instance']

    # RabbitMQDown suppresses queue-related alerts
    - source_match:
        alertname: 'RabbitMQDown'
      target_match_re:
        alertname: 'RabbitMQ.*'
      equal: ['instance']

    # ============================================================================
    # Receivers
    # Define notification channels and their configurations
    # ============================================================================
    receivers:
    # ==========================================================================
    # Default Receiver
    # Fallback for alerts that don't match any specific route
    # ==========================================================================
    - name: 'default-receiver'
      email_configs:
      - to: 'ops-team@jobpilot.com'
        headers:
          Subject: '[JobPilot Alert] {{ .GroupLabels.alertname }}'
        html: |
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
              .alert-header { background-color: #f4f4f4; padding: 20px; border-left: 4px solid #ffa500; }
              .alert-details { padding: 20px; }
              .alert-list { list-style: none; padding: 0; }
              .alert-item { background: #fff; margin: 10px 0; padding: 15px; border: 1px solid #ddd; }
              .label { display: inline-block; margin: 5px; padding: 5px 10px; background: #e0e0e0; border-radius: 3px; }
              .critical { border-left-color: #d32f2f; }
              .warning { border-left-color: #ffa500; }
            </style>
          </head>
          <body>
            <div class="alert-header">
              <h2>{{ .GroupLabels.alertname }}</h2>
              <p><strong>Severity:</strong> {{ .CommonLabels.severity | toUpper }}</p>
              <p><strong>Category:</strong> {{ .CommonLabels.category }}</p>
              <p><strong>Time:</strong> {{ .CommonAnnotations.summary }}</p>
            </div>
            <div class="alert-details">
              <h3>Affected Services:</h3>
              <ul class="alert-list">
              {{ range .Alerts }}
                <li class="alert-item {{ .Labels.severity }}">
                  <strong>{{ .Labels.service | default .Labels.pod }}</strong>
                  <p>{{ .Annotations.description }}</p>
                  <p>
                    {{ range .Labels.SortedPairs }}
                      <span class="label">{{ .Name }}: {{ .Value }}</span>
                    {{ end }}
                  </p>
                  {{ if .Annotations.runbook_url }}
                  <p><a href="{{ .Annotations.runbook_url }}">View Runbook</a></p>
                  {{ end }}
                </li>
              {{ end }}
              </ul>
            </div>
          </body>
          </html>
        send_resolved: true

    # ==========================================================================
    # Critical Alerts Receiver
    # High-priority issues requiring immediate attention
    # ==========================================================================
    - name: 'critical-alerts'
      # PagerDuty integration for on-call escalation
      pagerduty_configs:
      - routing_key: '${PAGERDUTY_INTEGRATION_KEY}'
        description: '[CRITICAL] {{ .GroupLabels.alertname }}: {{ .CommonAnnotations.summary }}'
        severity: 'critical'
        client: 'JobPilot AlertManager'
        client_url: 'https://alertmanager.jobpilot.com'
        details:
          firing: '{{ .Alerts.Firing | len }}'
          resolved: '{{ .Alerts.Resolved | len }}'
          alertname: '{{ .GroupLabels.alertname }}'
          service: '{{ .CommonLabels.service }}'
          namespace: '{{ .CommonLabels.namespace }}'
          summary: '{{ .CommonAnnotations.summary }}'
          description: '{{ .CommonAnnotations.description }}'
          runbook_url: '{{ .CommonAnnotations.runbook_url }}'
        send_resolved: true

      # Slack notification for critical alerts
      slack_configs:
      - channel: '#critical-alerts'
        username: 'JobPilot AlertManager'
        icon_emoji: ':rotating_light:'
        title: ':fire: [CRITICAL] {{ .GroupLabels.alertname }}'
        title_link: '{{ .CommonAnnotations.dashboard_url }}'
        text: |
          *Summary:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}
          *Service:* {{ .CommonLabels.service | default "N/A" }}
          *Namespace:* {{ .CommonLabels.namespace }}
          *Firing Alerts:* {{ .Alerts.Firing | len }}
        color: 'danger'
        fields:
        - title: 'Severity'
          value: '{{ .CommonLabels.severity | toUpper }}'
          short: true
        - title: 'Category'
          value: '{{ .CommonLabels.category }}'
          short: true
        - title: 'Team'
          value: '{{ .CommonLabels.team }}'
          short: true
        - title: 'Runbook'
          value: '{{ .CommonAnnotations.runbook_url }}'
          short: false
        actions:
        - type: button
          text: 'View Dashboard'
          url: '{{ .CommonAnnotations.dashboard_url }}'
        - type: button
          text: 'Silence Alert'
          url: 'https://alertmanager.jobpilot.com/#/silences/new'
        send_resolved: true

      # Email notification for critical alerts
      email_configs:
      - to: 'oncall@jobpilot.com'
        headers:
          Subject: ':rotating_light: [CRITICAL] JobPilot: {{ .GroupLabels.alertname }}'
          Priority: 'urgent'
        html: |
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
              .critical-header { background-color: #d32f2f; color: white; padding: 20px; }
              .alert-details { padding: 20px; background: #fff; }
              .alert-item { background: #ffebee; margin: 10px 0; padding: 15px; border-left: 4px solid #d32f2f; }
              .button { display: inline-block; padding: 10px 20px; background: #1976d2; color: white; text-decoration: none; border-radius: 4px; margin: 5px; }
            </style>
          </head>
          <body>
            <div class="critical-header">
              <h1>ðŸš¨ CRITICAL ALERT</h1>
              <h2>{{ .GroupLabels.alertname }}</h2>
            </div>
            <div class="alert-details">
              <p><strong>Summary:</strong> {{ .CommonAnnotations.summary }}</p>
              <p><strong>Description:</strong> {{ .CommonAnnotations.description }}</p>
              <p><strong>Service:</strong> {{ .CommonLabels.service | default "N/A" }}</p>
              <p><strong>Namespace:</strong> {{ .CommonLabels.namespace }}</p>
              <p><strong>Team:</strong> {{ .CommonLabels.team }}</p>
              <p><strong>Firing Alerts:</strong> {{ .Alerts.Firing | len }}</p>
              <h3>Affected Instances:</h3>
              {{ range .Alerts }}
              <div class="alert-item">
                <p><strong>{{ .Labels.instance | default .Labels.pod }}</strong></p>
                <p>{{ .Annotations.description }}</p>
              </div>
              {{ end }}
              <p>
                <a href="{{ .CommonAnnotations.dashboard_url }}" class="button">View Dashboard</a>
                <a href="{{ .CommonAnnotations.runbook_url }}" class="button">View Runbook</a>
              </p>
            </div>
          </body>
          </html>
        send_resolved: true

    # ==========================================================================
    # Warning Alerts Receiver
    # Non-critical issues that require attention but not immediate action
    # ==========================================================================
    - name: 'warning-alerts'
      slack_configs:
      - channel: '#alerts'
        username: 'JobPilot AlertManager'
        icon_emoji: ':warning:'
        title: ':warning: [WARNING] {{ .GroupLabels.alertname }}'
        title_link: '{{ .CommonAnnotations.dashboard_url }}'
        text: |
          *Summary:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}
          *Service:* {{ .CommonLabels.service | default "N/A" }}
        color: 'warning'
        fields:
        - title: 'Category'
          value: '{{ .CommonLabels.category }}'
          short: true
        - title: 'Team'
          value: '{{ .CommonLabels.team }}'
          short: true
        send_resolved: true

      email_configs:
      - to: 'ops-team@jobpilot.com'
        headers:
          Subject: '[WARNING] JobPilot: {{ .GroupLabels.alertname }}'
        send_resolved: true

    # ==========================================================================
    # Database Alerts Receiver
    # Specialized handling for database and cache issues
    # ==========================================================================
    - name: 'database-alerts'
      slack_configs:
      - channel: '#database-alerts'
        username: 'JobPilot Database Monitor'
        icon_emoji: ':database:'
        title: ':database: [{{ .CommonLabels.severity | toUpper }}] {{ .GroupLabels.alertname }}'
        text: |
          *Instance:* {{ .CommonLabels.instance }}
          *Description:* {{ .CommonAnnotations.description }}
        color: '{{ if eq .CommonLabels.severity "critical" }}danger{{ else }}warning{{ end }}'
        send_resolved: true

      email_configs:
      - to: 'database-team@jobpilot.com'
        headers:
          Subject: '[DATABASE] {{ .GroupLabels.alertname }}'
        send_resolved: true

    # ==========================================================================
    # Business Alerts Receiver
    # Product and business metric alerts
    # ==========================================================================
    - name: 'business-alerts'
      slack_configs:
      - channel: '#product-metrics'
        username: 'JobPilot Business Metrics'
        icon_emoji: ':chart_with_upwards_trend:'
        title: ':chart_with_downwards_trend: [{{ .CommonLabels.severity | toUpper }}] {{ .GroupLabels.alertname }}'
        text: |
          *Metric:* {{ .GroupLabels.alertname }}
          *Description:* {{ .CommonAnnotations.description }}
          *Impact:* Business KPI degradation
        color: '{{ if eq .CommonLabels.severity "critical" }}danger{{ else }}warning{{ end }}'
        send_resolved: true

      email_configs:
      - to: 'product-team@jobpilot.com,business-analytics@jobpilot.com'
        headers:
          Subject: '[BUSINESS METRIC] {{ .GroupLabels.alertname }}'
        send_resolved: true

    # ==========================================================================
    # Infrastructure Alerts Receiver
    # Platform and infrastructure team notifications
    # ==========================================================================
    - name: 'infrastructure-alerts'
      slack_configs:
      - channel: '#infrastructure'
        username: 'JobPilot Infrastructure'
        icon_emoji: ':kubernetes:'
        title: ':construction: [{{ .CommonLabels.severity | toUpper }}] {{ .GroupLabels.alertname }}'
        text: |
          *Component:* {{ .CommonLabels.node | default .CommonLabels.pod }}
          *Description:* {{ .CommonAnnotations.description }}
        color: '{{ if eq .CommonLabels.severity "critical" }}danger{{ else }}warning{{ end }}'
        send_resolved: true

      email_configs:
      - to: 'platform-team@jobpilot.com'
        headers:
          Subject: '[INFRASTRUCTURE] {{ .GroupLabels.alertname }}'
        send_resolved: true

---
# Secrets for AlertManager
# These should be managed via sealed-secrets or external secret management in production
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-secrets
  namespace: jobpilot
  labels:
    app: alertmanager
type: Opaque
stringData:
  # SendGrid API Key for email notifications
  # Replace with actual value or use external secret management
  SENDGRID_API_KEY: "SG.REPLACE_WITH_ACTUAL_KEY"

  # Slack Webhook URL for notifications
  # Create webhook at https://api.slack.com/messaging/webhooks
  SLACK_API_URL: "https://hooks.slack.com/services/REPLACE/WITH/ACTUAL_WEBHOOK_URL"

  # PagerDuty Integration Key
  # Get from PagerDuty service integration
  PAGERDUTY_INTEGRATION_KEY: "REPLACE_WITH_ACTUAL_INTEGRATION_KEY"

# ============================================================================
# Monitoring Namespace - Azure Key Vault Secret Provider Class
# ============================================================================
# This file configures the Azure Key Vault CSI Driver to sync secrets from
# Azure Key Vault into Kubernetes secrets for the monitoring namespace.
#
# Prerequisites:
# 1. Azure Key Vault CSI Driver installed on AKS cluster
# 2. Workload Identity enabled on AKS cluster
# 3. Managed Identity with Key Vault access policies configured
#
# Required secrets in Azure Key Vault:
# - grafana-admin-user -> GF_SECURITY_ADMIN_USER
# - grafana-admin-password -> GF_SECURITY_ADMIN_PASSWORD
# - alertmanager-pagerduty-key -> PAGERDUTY_ROUTING_KEY
# - alertmanager-slack-webhook -> SLACK_WEBHOOK_URL
# - smtp-password -> SMTP_AUTH_PASSWORD (for alertmanager email alerts)
# ============================================================================

---
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: monitoring-azure-keyvault
  namespace: monitoring
  labels:
    app.kubernetes.io/name: monitoring-secrets
    app.kubernetes.io/part-of: applyforus-monitoring
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"
    # Update this with the actual Managed Identity Client ID from Terraform output
    userAssignedIdentityID: "${WORKLOAD_IDENTITY_CLIENT_ID}"
    # Update with your actual Key Vault name (from Terraform)
    keyvaultName: "${KEY_VAULT_NAME}"
    cloudName: "AzurePublicCloud"
    # Azure Tenant ID (from Terraform)
    tenantId: "${AZURE_TENANT_ID}"
    objects: |
      array:
        # =======================================================================
        # Grafana Secrets
        # =======================================================================
        - |
          objectName: grafana-admin-user
          objectType: secret
          objectAlias: GF_SECURITY_ADMIN_USER
        - |
          objectName: grafana-admin-password
          objectType: secret
          objectAlias: GF_SECURITY_ADMIN_PASSWORD
        # =======================================================================
        # Alertmanager Secrets
        # =======================================================================
        - |
          objectName: alertmanager-pagerduty-key
          objectType: secret
          objectAlias: PAGERDUTY_ROUTING_KEY
        - |
          objectName: alertmanager-slack-webhook
          objectType: secret
          objectAlias: SLACK_WEBHOOK_URL
        - |
          objectName: smtp-password
          objectType: secret
          objectAlias: SMTP_AUTH_PASSWORD

  # Automatically create Kubernetes secrets from Key Vault secrets
  secretObjects:
    # Grafana admin credentials
    - secretName: grafana-secrets
      type: Opaque
      data:
        - objectName: GF_SECURITY_ADMIN_USER
          key: admin-user
        - objectName: GF_SECURITY_ADMIN_PASSWORD
          key: admin-password
    # Alertmanager notification secrets
    - secretName: alertmanager-secrets
      type: Opaque
      data:
        - objectName: PAGERDUTY_ROUTING_KEY
          key: pagerduty-routing-key
        - objectName: SLACK_WEBHOOK_URL
          key: slack-webhook-url
        - objectName: SMTP_AUTH_PASSWORD
          key: smtp-auth-password

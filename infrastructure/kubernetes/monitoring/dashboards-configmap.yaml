# ConfigMap for Grafana Dashboards
# This configures Grafana to load dashboard JSON files from ConfigMaps
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-provider
  namespace: jobpilot
  labels:
    app: grafana
    grafana_dashboard: "1"
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
    - name: 'JobPilot Dashboards'
      orgId: 1
      folder: 'JobPilot'
      type: file
      disableDeletion: false
      updateIntervalSeconds: 10
      allowUiUpdates: true
      options:
        path: /var/lib/grafana/dashboards/jobpilot
---
# We'll use a separate deployment approach for dashboard JSON files
# Dashboard JSON files should be loaded via ConfigMaps or mounted volumes
# For now, we'll create a script to load dashboards via Grafana API

apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-loader
  namespace: jobpilot
  labels:
    app: grafana
data:
  load-dashboards.sh: |
    #!/bin/bash
    set -e

    GRAFANA_URL="${GRAFANA_URL:-http://grafana:3000}"
    GRAFANA_USER="${GRAFANA_USER:-admin}"
    GRAFANA_PASSWORD="${GRAFANA_PASSWORD:-admin}"
    DASHBOARD_DIR="${DASHBOARD_DIR:-/dashboards}"

    echo "Loading dashboards from $DASHBOARD_DIR to $GRAFANA_URL"

    # Wait for Grafana to be ready
    until curl -s -f -o /dev/null "$GRAFANA_URL/api/health"; do
      echo "Waiting for Grafana to be ready..."
      sleep 5
    done

    echo "Grafana is ready!"

    # Load each dashboard
    for dashboard_file in "$DASHBOARD_DIR"/*.json; do
      if [ -f "$dashboard_file" ]; then
        echo "Loading dashboard: $(basename "$dashboard_file")"

        # Wrap dashboard JSON in the required format
        dashboard_json=$(cat "$dashboard_file")
        payload=$(jq -n \
          --argjson dashboard "$dashboard_json" \
          '{
            dashboard: $dashboard,
            overwrite: true,
            message: "Updated by dashboard loader"
          }')

        # Upload to Grafana
        curl -s -X POST \
          -H "Content-Type: application/json" \
          -u "$GRAFANA_USER:$GRAFANA_PASSWORD" \
          -d "$payload" \
          "$GRAFANA_URL/api/dashboards/db"

        echo " - Done"
      fi
    done

    echo "All dashboards loaded successfully!"
---
# Job to load dashboards on startup
apiVersion: batch/v1
kind: Job
metadata:
  name: grafana-dashboard-loader
  namespace: jobpilot
  labels:
    app: grafana
    component: dashboard-loader
spec:
  template:
    metadata:
      labels:
        app: grafana
        component: dashboard-loader
    spec:
      restartPolicy: OnFailure
      containers:
      - name: loader
        image: alpine:3.18
        command: ["/bin/sh", "/scripts/load-dashboards.sh"]
        env:
        - name: GRAFANA_URL
          value: "http://grafana:3000"
        - name: GRAFANA_USER
          valueFrom:
            secretKeyRef:
              name: grafana-credentials
              key: admin-user
        - name: GRAFANA_PASSWORD
          valueFrom:
            secretKeyRef:
              name: grafana-credentials
              key: admin-password
        volumeMounts:
        - name: scripts
          mountPath: /scripts
        - name: dashboards
          mountPath: /dashboards
      initContainers:
      - name: install-tools
        image: alpine:3.18
        command:
        - sh
        - -c
        - |
          apk add --no-cache curl jq
          cp /usr/bin/curl /shared/
          cp /usr/bin/jq /shared/
        volumeMounts:
        - name: shared-tools
          mountPath: /shared
      volumes:
      - name: scripts
        configMap:
          name: grafana-dashboard-loader
          defaultMode: 0755
      - name: dashboards
        projected:
          sources:
          - configMap:
              name: dashboard-service-health
          - configMap:
              name: dashboard-database-metrics
          - configMap:
              name: dashboard-queue-metrics
      - name: shared-tools
        emptyDir: {}

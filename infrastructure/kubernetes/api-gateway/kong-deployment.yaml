apiVersion: apps/v1
kind: Deployment
metadata:
  name: kong
  namespace: kong
  labels:
    app: kong
    component: api-gateway
spec:
  # High availability with 2 replicas
  replicas: 2
  selector:
    matchLabels:
      app: kong
  template:
    metadata:
      labels:
        app: kong
        component: api-gateway
      annotations:
        # Force pod restart when config changes
        checksum/config: "{{ include (print $.Template.BasePath \"/kong-config.yaml\") . | sha256sum }}"
    spec:
      # Anti-affinity to spread pods across nodes
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - kong
                topologyKey: kubernetes.io/hostname

      containers:
        - name: kong
          # Kong 3.4 - Latest stable version
          image: kong:3.4
          imagePullPolicy: IfNotPresent

          env:
            # Database-less (declarative) mode for simplicity and performance
            - name: KONG_DATABASE
              value: "off"

            # Declarative configuration file path
            - name: KONG_DECLARATIVE_CONFIG
              value: /etc/kong/kong.yml

            # Proxy listen configuration
            - name: KONG_PROXY_LISTEN
              value: "0.0.0.0:8000, 0.0.0.0:8443 ssl"

            # Admin API listen configuration (internal only)
            - name: KONG_ADMIN_LISTEN
              value: "0.0.0.0:8001"

            # Admin API access log
            - name: KONG_ADMIN_ACCESS_LOG
              value: /dev/stdout

            # Admin API error log
            - name: KONG_ADMIN_ERROR_LOG
              value: /dev/stderr

            # Proxy access log
            - name: KONG_PROXY_ACCESS_LOG
              value: /dev/stdout

            # Proxy error log
            - name: KONG_PROXY_ERROR_LOG
              value: /dev/stderr

            # Log level
            - name: KONG_LOG_LEVEL
              value: info

            # Disable anonymous reports
            - name: KONG_ANONYMOUS_REPORTS
              value: "off"

            # Enable Prometheus plugin
            - name: KONG_PLUGINS
              value: bundled

            # Trusted IPs for real IP detection (behind load balancer)
            - name: KONG_REAL_IP_HEADER
              value: X-Forwarded-For

            - name: KONG_REAL_IP_RECURSIVE
              value: "on"

          ports:
            # Proxy port (HTTP)
            - name: proxy
              containerPort: 8000
              protocol: TCP

            # Proxy port (HTTPS)
            - name: proxy-ssl
              containerPort: 8443
              protocol: TCP

            # Admin API port (internal only)
            - name: admin
              containerPort: 8001
              protocol: TCP

          # Liveness probe - checks if Kong is running
          livenessProbe:
            httpGet:
              path: /status
              port: 8001
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3

          # Readiness probe - checks if Kong is ready to serve traffic
          readinessProbe:
            httpGet:
              path: /status
              port: 8001
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3

          # Resource limits and requests
          resources:
            requests:
              # Minimum CPU allocated
              cpu: 500m
              # Minimum memory allocated
              memory: 512Mi
            limits:
              # Maximum CPU allowed
              cpu: 1000m
              # Maximum memory allowed
              memory: 1Gi

          # Volume mounts
          volumeMounts:
            # Mount declarative configuration
            - name: kong-config
              mountPath: /etc/kong
              readOnly: true

      # Volumes
      volumes:
        # ConfigMap containing Kong declarative configuration
        - name: kong-config
          configMap:
            name: kong-config
            items:
              - key: kong.yml
                path: kong.yml

      # Security context
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000

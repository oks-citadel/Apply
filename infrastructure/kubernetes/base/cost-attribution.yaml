# ============================================================================
# Kubernetes Cost Attribution and Resource Quotas
# ============================================================================
# This configuration implements:
# - Environment-specific namespaces with cost labels
# - Resource quotas per namespace
# - Cost allocation tags
# - LimitRanges for cost control

---
# ============================================================================
# Development Namespace
# ============================================================================
apiVersion: v1
kind: Namespace
metadata:
  name: applyforus-dev
  labels:
    name: applyforus-dev
    environment: dev
    app: applyforus-platform
    # Cost allocation labels
    cost-center: "engineering"
    business-unit: "product"
    cost-owner: "platform-team"
    budget-code: "PLATFORM-DEV"
    tier: "non-production"
    criticality: "low"
  annotations:
    budget.azure.com/monthly-limit: "500"
    cost.azure.com/environment: "development"
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: applyforus-dev-quota
  namespace: applyforus-dev
  labels:
    app: applyforus-platform
    environment: dev
    cost-control: "enabled"
spec:
  hard:
    # Compute Resources - Conservative for dev
    requests.cpu: "10"
    requests.memory: 20Gi
    limits.cpu: "20"
    limits.memory: 40Gi

    # Storage - Limited for dev
    requests.storage: 100Gi
    persistentvolumeclaims: "10"

    # Objects - Limited for dev
    pods: "30"
    services: "20"
    secrets: "30"
    configmaps: "30"
    deployments.apps: "15"
    statefulsets.apps: "5"
  scopeSelector:
    matchExpressions:
    - operator: In
      scopeName: PriorityClass
      values: ["high-priority", "medium-priority", "low-priority"]
---
apiVersion: v1
kind: LimitRange
metadata:
  name: applyforus-dev-limitrange
  namespace: applyforus-dev
  labels:
    app: applyforus-platform
    environment: dev
spec:
  limits:
  # Container limits - Small for dev
  - type: Container
    default:
      cpu: 500m
      memory: 512Mi
    defaultRequest:
      cpu: 100m
      memory: 128Mi
    max:
      cpu: 2000m
      memory: 4Gi
    min:
      cpu: 50m
      memory: 64Mi
  # Pod limits
  - type: Pod
    max:
      cpu: 4000m
      memory: 8Gi
  # PVC limits
  - type: PersistentVolumeClaim
    max:
      storage: 50Gi
    min:
      storage: 1Gi

---
# ============================================================================
# Staging Namespace
# ============================================================================
apiVersion: v1
kind: Namespace
metadata:
  name: applyforus-staging
  labels:
    name: applyforus-staging
    environment: staging
    app: applyforus-platform
    # Cost allocation labels
    cost-center: "engineering"
    business-unit: "product"
    cost-owner: "platform-team"
    budget-code: "PLATFORM-STAGING"
    tier: "non-production"
    criticality: "medium"
  annotations:
    budget.azure.com/monthly-limit: "1000"
    cost.azure.com/environment: "staging"
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: applyforus-staging-quota
  namespace: applyforus-staging
  labels:
    app: applyforus-platform
    environment: staging
    cost-control: "enabled"
spec:
  hard:
    # Compute Resources - Moderate for staging
    requests.cpu: "25"
    requests.memory: 50Gi
    limits.cpu: "50"
    limits.memory: 100Gi

    # Storage
    requests.storage: 250Gi
    persistentvolumeclaims: "15"

    # Objects
    pods: "50"
    services: "30"
    secrets: "40"
    configmaps: "40"
    deployments.apps: "20"
    statefulsets.apps: "8"
---
apiVersion: v1
kind: LimitRange
metadata:
  name: applyforus-staging-limitrange
  namespace: applyforus-staging
  labels:
    app: applyforus-platform
    environment: staging
spec:
  limits:
  # Container limits - Medium for staging
  - type: Container
    default:
      cpu: 750m
      memory: 768Mi
    defaultRequest:
      cpu: 200m
      memory: 256Mi
    max:
      cpu: 3000m
      memory: 6Gi
    min:
      cpu: 100m
      memory: 128Mi
  # Pod limits
  - type: Pod
    max:
      cpu: 6000m
      memory: 12Gi
  # PVC limits
  - type: PersistentVolumeClaim
    max:
      storage: 75Gi
    min:
      storage: 1Gi

---
# ============================================================================
# Production Namespace (Enhanced)
# ============================================================================
apiVersion: v1
kind: Namespace
metadata:
  name: applyforus
  labels:
    name: applyforus
    environment: production
    app: applyforus-platform
    # Cost allocation labels
    cost-center: "engineering"
    business-unit: "product"
    cost-owner: "platform-team"
    budget-code: "PLATFORM-PROD"
    tier: "production"
    criticality: "high"
  annotations:
    budget.azure.com/monthly-limit: "5000"
    cost.azure.com/environment: "production"
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: applyforus-prod-quota
  namespace: applyforus
  labels:
    app: applyforus-platform
    environment: production
    cost-control: "enabled"
spec:
  hard:
    # Compute Resources - Production scale with limits
    requests.cpu: "50"
    requests.memory: 100Gi
    limits.cpu: "100"
    limits.memory: 200Gi

    # Storage
    requests.storage: 500Gi
    persistentvolumeclaims: "20"

    # Objects
    pods: "100"
    services: "50"
    secrets: "50"
    configmaps: "50"
    deployments.apps: "30"
    statefulsets.apps: "10"

    # LoadBalancers are expensive - limit them
    services.loadbalancers: "5"
---
apiVersion: v1
kind: LimitRange
metadata:
  name: applyforus-prod-limitrange
  namespace: applyforus
  labels:
    app: applyforus-platform
    environment: production
spec:
  limits:
  # Container limits - Production-grade
  - type: Container
    default:
      cpu: 1000m
      memory: 1Gi
    defaultRequest:
      cpu: 250m
      memory: 256Mi
    max:
      cpu: 4000m
      memory: 8Gi
    min:
      cpu: 100m
      memory: 128Mi
  # Pod limits
  - type: Pod
    max:
      cpu: 8000m
      memory: 16Gi
    min:
      cpu: 100m
      memory: 128Mi
  # PVC limits
  - type: PersistentVolumeClaim
    max:
      storage: 100Gi
    min:
      storage: 1Gi

---
# ============================================================================
# Network Policies for Cost Control
# ============================================================================
# Prevent unnecessary cross-namespace traffic that could increase costs
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-cross-namespace
  namespace: applyforus-dev
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: applyforus-dev
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: applyforus-dev
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
  - ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-cross-namespace
  namespace: applyforus-staging
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: applyforus-staging
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: applyforus-staging
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
  - ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53

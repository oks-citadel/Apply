# ============================================================================
# Azure Key Vault Secret Provider Class
# ============================================================================
# This file configures the Azure Key Vault CSI Driver to sync secrets from
# Azure Key Vault into Kubernetes secrets. Secrets are NOT hardcoded here.
#
# Prerequisites:
# 1. Azure Key Vault CSI Driver installed on AKS cluster
# 2. Workload Identity enabled on AKS cluster
# 3. Managed Identity with Key Vault access policies configured
#
# Usage:
# - Mount this SecretProviderClass as a volume in pod specs
# - Secrets will be automatically synced and available as env vars
# ============================================================================

---
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: applyforus-azure-keyvault
  namespace: applyforus
  labels:
    app: applyforus-platform
    managed-by: terraform
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"
    # Update this with the actual Managed Identity Client ID from Terraform output
    userAssignedIdentityID: "${WORKLOAD_IDENTITY_CLIENT_ID}"
    # Update with your actual Key Vault name (from Terraform)
    keyvaultName: "${KEY_VAULT_NAME}"
    cloudName: "AzurePublicCloud"
    # Azure Tenant ID (from Terraform)
    tenantId: "${AZURE_TENANT_ID}"
    objects: |
      array:
        # =======================================================================
        # Database Secrets
        # =======================================================================
        - |
          objectName: postgres-user
          objectType: secret
          objectAlias: POSTGRES_USER
        - |
          objectName: postgres-password
          objectType: secret
          objectAlias: POSTGRES_PASSWORD
        - |
          objectName: postgres-connection-string
          objectType: secret
          objectAlias: DATABASE_URL
        # =======================================================================
        # Cache and Messaging Secrets
        # =======================================================================
        - |
          objectName: redis-password
          objectType: secret
          objectAlias: REDIS_PASSWORD
        - |
          objectName: redis-connection-string
          objectType: secret
          objectAlias: REDIS_URL
        - |
          objectName: servicebus-connection-string
          objectType: secret
          objectAlias: AZURE_SERVICE_BUS_CONNECTION_STRING
        # =======================================================================
        # Authentication and Security Secrets
        # =======================================================================
        - |
          objectName: jwt-secret
          objectType: secret
          objectAlias: JWT_SECRET
        - |
          objectName: jwt-refresh-secret
          objectType: secret
          objectAlias: JWT_REFRESH_SECRET
        - |
          objectName: session-secret
          objectType: secret
          objectAlias: SESSION_SECRET
        - |
          objectName: encryption-key
          objectType: secret
          objectAlias: ENCRYPTION_KEY
        # =======================================================================
        # OAuth Provider Secrets
        # =======================================================================
        - |
          objectName: google-client-id
          objectType: secret
          objectAlias: GOOGLE_CLIENT_ID
        - |
          objectName: google-client-secret
          objectType: secret
          objectAlias: GOOGLE_CLIENT_SECRET
        - |
          objectName: linkedin-client-id
          objectType: secret
          objectAlias: LINKEDIN_CLIENT_ID
        - |
          objectName: linkedin-client-secret
          objectType: secret
          objectAlias: LINKEDIN_CLIENT_SECRET
        - |
          objectName: github-client-id
          objectType: secret
          objectAlias: GITHUB_CLIENT_ID
        - |
          objectName: github-client-secret
          objectType: secret
          objectAlias: GITHUB_CLIENT_SECRET
        # =======================================================================
        # Cloud Storage Secrets
        # =======================================================================
        - |
          objectName: azure-storage-connection-string
          objectType: secret
          objectAlias: AZURE_STORAGE_CONNECTION_STRING
        - |
          objectName: azure-storage-account-key
          objectType: secret
          objectAlias: AZURE_STORAGE_ACCOUNT_KEY
        - |
          objectName: aws-access-key-id
          objectType: secret
          objectAlias: AWS_ACCESS_KEY_ID
        - |
          objectName: aws-secret-access-key
          objectType: secret
          objectAlias: AWS_SECRET_ACCESS_KEY
        # =======================================================================
        # AI Service API Keys
        # =======================================================================
        - |
          objectName: openai-api-key
          objectType: secret
          objectAlias: OPENAI_API_KEY
        - |
          objectName: anthropic-api-key
          objectType: secret
          objectAlias: ANTHROPIC_API_KEY
        - |
          objectName: azure-openai-api-key
          objectType: secret
          objectAlias: AZURE_OPENAI_API_KEY
        - |
          objectName: pinecone-api-key
          objectType: secret
          objectAlias: PINECONE_API_KEY
        # =======================================================================
        # Email and Notification Secrets
        # =======================================================================
        - |
          objectName: sendgrid-api-key
          objectType: secret
          objectAlias: SENDGRID_API_KEY
        - |
          objectName: smtp-username
          objectType: secret
          objectAlias: SMTP_USERNAME
        - |
          objectName: smtp-password
          objectType: secret
          objectAlias: SMTP_PASSWORD
        - |
          objectName: firebase-private-key
          objectType: secret
          objectAlias: FIREBASE_PRIVATE_KEY
        # =======================================================================
        # Payment Provider Secrets
        # =======================================================================
        - |
          objectName: stripe-secret-key
          objectType: secret
          objectAlias: STRIPE_SECRET_KEY
        - |
          objectName: stripe-publishable-key
          objectType: secret
          objectAlias: STRIPE_PUBLISHABLE_KEY
        - |
          objectName: stripe-webhook-secret
          objectType: secret
          objectAlias: STRIPE_WEBHOOK_SECRET
        - |
          objectName: paystack-secret-key
          objectType: secret
          objectAlias: PAYSTACK_SECRET_KEY
        - |
          objectName: paystack-public-key
          objectType: secret
          objectAlias: PAYSTACK_PUBLIC_KEY
        - |
          objectName: flutterwave-secret-key
          objectType: secret
          objectAlias: FLUTTERWAVE_SECRET_KEY
        - |
          objectName: flutterwave-public-key
          objectType: secret
          objectAlias: FLUTTERWAVE_PUBLIC_KEY
        - |
          objectName: flutterwave-encryption-key
          objectType: secret
          objectAlias: FLUTTERWAVE_ENCRYPTION_KEY
        - |
          objectName: flutterwave-webhook-secret
          objectType: secret
          objectAlias: FLUTTERWAVE_WEBHOOK_SECRET
        # =======================================================================
        # Job Board API Keys
        # =======================================================================
        - |
          objectName: indeed-api-key
          objectType: secret
          objectAlias: INDEED_API_KEY
        - |
          objectName: linkedin-api-key
          objectType: secret
          objectAlias: LINKEDIN_API_KEY
        - |
          objectName: glassdoor-api-key
          objectType: secret
          objectAlias: GLASSDOOR_API_KEY
        - |
          objectName: ziprecruiter-api-key
          objectType: secret
          objectAlias: ZIPRECRUITER_API_KEY
        - |
          objectName: dice-api-key
          objectType: secret
          objectAlias: DICE_API_KEY
        - |
          objectName: adzuna-app-id
          objectType: secret
          objectAlias: ADZUNA_APP_ID
        - |
          objectName: adzuna-api-key
          objectType: secret
          objectAlias: ADZUNA_API_KEY
        - |
          objectName: rapidapi-key
          objectType: secret
          objectAlias: RAPIDAPI_KEY
        # =======================================================================
        # Monitoring Secrets
        # =======================================================================
        - |
          objectName: appinsights-instrumentation-key
          objectType: secret
          objectAlias: APPLICATIONINSIGHTS_INSTRUMENTATION_KEY
        - |
          objectName: appinsights-connection-string
          objectType: secret
          objectAlias: APPLICATIONINSIGHTS_CONNECTION_STRING
        - |
          objectName: sentry-dsn
          objectType: secret
          objectAlias: SENTRY_DSN
        # =======================================================================
        # Search Service Secrets
        # =======================================================================
        - |
          objectName: elasticsearch-username
          objectType: secret
          objectAlias: ELASTICSEARCH_USERNAME
        - |
          objectName: elasticsearch-password
          objectType: secret
          objectAlias: ELASTICSEARCH_PASSWORD

  # Automatically create Kubernetes secret from Key Vault secrets
  secretObjects:
  - secretName: applyforus-secrets
    type: Opaque
    data:
      # Database
      - objectName: POSTGRES_USER
        key: POSTGRES_USER
      - objectName: POSTGRES_PASSWORD
        key: POSTGRES_PASSWORD
      - objectName: DATABASE_URL
        key: DATABASE_URL
      # Cache and Messaging
      - objectName: REDIS_PASSWORD
        key: REDIS_PASSWORD
      - objectName: REDIS_URL
        key: REDIS_URL
      - objectName: AZURE_SERVICE_BUS_CONNECTION_STRING
        key: AZURE_SERVICE_BUS_CONNECTION_STRING
      # Authentication
      - objectName: JWT_SECRET
        key: JWT_SECRET
      - objectName: JWT_REFRESH_SECRET
        key: JWT_REFRESH_SECRET
      - objectName: SESSION_SECRET
        key: SESSION_SECRET
      - objectName: ENCRYPTION_KEY
        key: ENCRYPTION_KEY
      # OAuth
      - objectName: GOOGLE_CLIENT_ID
        key: GOOGLE_CLIENT_ID
      - objectName: GOOGLE_CLIENT_SECRET
        key: GOOGLE_CLIENT_SECRET
      - objectName: LINKEDIN_CLIENT_ID
        key: LINKEDIN_CLIENT_ID
      - objectName: LINKEDIN_CLIENT_SECRET
        key: LINKEDIN_CLIENT_SECRET
      - objectName: GITHUB_CLIENT_ID
        key: GITHUB_CLIENT_ID
      - objectName: GITHUB_CLIENT_SECRET
        key: GITHUB_CLIENT_SECRET
      # Storage
      - objectName: AZURE_STORAGE_CONNECTION_STRING
        key: AZURE_STORAGE_CONNECTION_STRING
      - objectName: AZURE_STORAGE_ACCOUNT_KEY
        key: AZURE_STORAGE_ACCOUNT_KEY
      - objectName: AWS_ACCESS_KEY_ID
        key: AWS_ACCESS_KEY_ID
      - objectName: AWS_SECRET_ACCESS_KEY
        key: AWS_SECRET_ACCESS_KEY
      # AI Services
      - objectName: OPENAI_API_KEY
        key: OPENAI_API_KEY
      - objectName: ANTHROPIC_API_KEY
        key: ANTHROPIC_API_KEY
      - objectName: AZURE_OPENAI_API_KEY
        key: AZURE_OPENAI_API_KEY
      - objectName: PINECONE_API_KEY
        key: PINECONE_API_KEY
      # Email
      - objectName: SENDGRID_API_KEY
        key: SENDGRID_API_KEY
      - objectName: SMTP_USERNAME
        key: SMTP_USERNAME
      - objectName: SMTP_PASSWORD
        key: SMTP_PASSWORD
      - objectName: FIREBASE_PRIVATE_KEY
        key: FIREBASE_PRIVATE_KEY
      # Payment - Stripe
      - objectName: STRIPE_SECRET_KEY
        key: STRIPE_SECRET_KEY
      - objectName: STRIPE_PUBLISHABLE_KEY
        key: STRIPE_PUBLISHABLE_KEY
      - objectName: STRIPE_WEBHOOK_SECRET
        key: STRIPE_WEBHOOK_SECRET
      # Payment - Paystack (African markets)
      - objectName: PAYSTACK_SECRET_KEY
        key: PAYSTACK_SECRET_KEY
      - objectName: PAYSTACK_PUBLIC_KEY
        key: PAYSTACK_PUBLIC_KEY
      # Payment - Flutterwave (African markets)
      - objectName: FLUTTERWAVE_SECRET_KEY
        key: FLUTTERWAVE_SECRET_KEY
      - objectName: FLUTTERWAVE_PUBLIC_KEY
        key: FLUTTERWAVE_PUBLIC_KEY
      - objectName: FLUTTERWAVE_ENCRYPTION_KEY
        key: FLUTTERWAVE_ENCRYPTION_KEY
      - objectName: FLUTTERWAVE_WEBHOOK_SECRET
        key: FLUTTERWAVE_WEBHOOK_SECRET
      # Job Boards
      - objectName: INDEED_API_KEY
        key: INDEED_API_KEY
      - objectName: LINKEDIN_API_KEY
        key: LINKEDIN_API_KEY
      - objectName: GLASSDOOR_API_KEY
        key: GLASSDOOR_API_KEY
      - objectName: ZIPRECRUITER_API_KEY
        key: ZIPRECRUITER_API_KEY
      - objectName: DICE_API_KEY
        key: DICE_API_KEY
      - objectName: ADZUNA_APP_ID
        key: ADZUNA_APP_ID
      - objectName: ADZUNA_API_KEY
        key: ADZUNA_API_KEY
      - objectName: RAPIDAPI_KEY
        key: RAPIDAPI_KEY
      # Monitoring
      - objectName: APPLICATIONINSIGHTS_INSTRUMENTATION_KEY
        key: APPLICATIONINSIGHTS_INSTRUMENTATION_KEY
      - objectName: APPLICATIONINSIGHTS_CONNECTION_STRING
        key: APPLICATIONINSIGHTS_CONNECTION_STRING
      - objectName: SENTRY_DSN
        key: SENTRY_DSN
      # Search
      - objectName: ELASTICSEARCH_USERNAME
        key: ELASTICSEARCH_USERNAME
      - objectName: ELASTICSEARCH_PASSWORD
        key: ELASTICSEARCH_PASSWORD

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: applyforus-staging

namePrefix: staging-

bases:
- ../../base
- ../../services

commonLabels:
  environment: staging
  app.kubernetes.io/environment: staging

commonAnnotations:
  environment: staging

# Replica overrides for staging environment
replicas:
- name: auth-service
  count: 2
- name: user-service
  count: 2
- name: job-service
  count: 2
- name: ai-service
  count: 1
- name: resume-service
  count: 1
- name: analytics-service
  count: 1
- name: notification-service
  count: 1
- name: auto-apply-service
  count: 1
- name: orchestrator-service
  count: 1
- name: web-app
  count: 2
- name: admin-app
  count: 1

# Image tag overrides
images:
- name: ${ACR_LOGIN_SERVER}/auth-service
  newName: applyforusacr.azurecr.io/auth-service
  newTag: staging
- name: ${ACR_LOGIN_SERVER}/user-service
  newName: applyforusacr.azurecr.io/user-service
  newTag: staging
- name: ${ACR_LOGIN_SERVER}/job-service
  newName: applyforusacr.azurecr.io/job-service
  newTag: staging
- name: ${ACR_LOGIN_SERVER}/ai-service
  newName: applyforusacr.azurecr.io/ai-service
  newTag: staging
- name: ${ACR_LOGIN_SERVER}/resume-service
  newName: applyforusacr.azurecr.io/resume-service
  newTag: staging
- name: ${ACR_LOGIN_SERVER}/analytics-service
  newName: applyforusacr.azurecr.io/analytics-service
  newTag: staging
- name: ${ACR_LOGIN_SERVER}/notification-service
  newName: applyforusacr.azurecr.io/notification-service
  newTag: staging
- name: ${ACR_LOGIN_SERVER}/auto-apply-service
  newName: applyforusacr.azurecr.io/auto-apply-service
  newTag: staging
- name: ${ACR_LOGIN_SERVER}/orchestrator-service
  newName: applyforusacr.azurecr.io/orchestrator-service
  newTag: staging
- name: ${ACR_LOGIN_SERVER}/payment-service
  newName: applyforusacr.azurecr.io/payment-service
  newTag: staging
- name: ${ACR_LOGIN_SERVER}/web-app
  newName: applyforusacr.azurecr.io/web-app
  newTag: staging
- name: ${ACR_LOGIN_SERVER}/applyai-admin
  newName: applyforusacr.azurecr.io/applyai-admin
  newTag: staging

# ConfigMap overrides for staging environment
configMapGenerator:
- name: applyforus-config
  behavior: merge
  literals:
  - NODE_ENV=staging
  - LOG_LEVEL=info
  - CORS_ORIGIN=https://staging.applyforus.com
  - POSTGRES_HOST=jobpilot-postgres-staging.postgres.database.azure.com
  - REDIS_HOST=jobpilot-redis-staging.redis.cache.windows.net

# Resource adjustments for staging
patches:
- target:
    kind: Deployment
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 1000m
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 1Gi

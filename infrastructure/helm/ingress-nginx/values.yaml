# ============================================================================
# NGINX INGRESS CONTROLLER HELM VALUES
# Chart: ingress-nginx/ingress-nginx
# ============================================================================
# Production-ready NGINX Ingress Controller for AKS
# Integrated with Azure Load Balancer and cert-manager
# ============================================================================

controller:
  name: controller

  # Replica count for HA
  replicaCount: 3

  # Use Azure Load Balancer
  service:
    enabled: true
    type: LoadBalancer
    annotations:
      service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path: /healthz
      service.beta.kubernetes.io/azure-load-balancer-internal: "false"
      # For internal-only ingress, set to "true"
      # service.beta.kubernetes.io/azure-dns-label-name: "applyforus-ingress"
    externalTrafficPolicy: Local

  # Resource allocation
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Pod Security Context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 101
    fsGroup: 101

  containerSecurityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
      add:
        - NET_BIND_SERVICE
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 101
    seccompProfile:
      type: RuntimeDefault

  # Autoscaling
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

  # Pod Anti-Affinity for HA
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: ingress-nginx
                app.kubernetes.io/component: controller
            topologyKey: kubernetes.io/hostname

  # Topology spread constraints
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          app.kubernetes.io/name: ingress-nginx

  # Node selector
  nodeSelector:
    nodepool-type: workload

  # Tolerations
  tolerations: []

  # NGINX configuration
  config:
    # Security headers
    add-headers: "applyforus/nginx-custom-headers"
    hide-server-tokens: "true"
    server-tokens: "false"

    # SSL/TLS configuration
    ssl-protocols: "TLSv1.2 TLSv1.3"
    ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
    ssl-prefer-server-ciphers: "true"
    ssl-session-cache: "true"
    ssl-session-cache-size: "10m"
    ssl-session-timeout: "1d"
    ssl-session-tickets: "false"

    # HTTP Strict Transport Security
    hsts: "true"
    hsts-include-subdomains: "true"
    hsts-max-age: "31536000"
    hsts-preload: "true"

    # Proxy settings
    proxy-body-size: "50m"
    proxy-buffer-size: "8k"
    proxy-buffers-number: "4"
    proxy-connect-timeout: "60"
    proxy-read-timeout: "60"
    proxy-send-timeout: "60"

    # Compression
    use-gzip: "true"
    gzip-level: "6"
    gzip-types: "application/json application/javascript text/css text/html text/plain"

    # Rate limiting
    limit-req-status-code: "429"
    limit-conn-status-code: "429"

    # Real IP handling (Azure Load Balancer)
    use-forwarded-headers: "true"
    compute-full-forwarded-for: "true"
    forwarded-for-header: "X-Forwarded-For"

    # Logging
    log-format-upstream: '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" $request_length $request_time [$proxy_upstream_name] [$proxy_alternative_upstream_name] $upstream_addr $upstream_response_length $upstream_response_time $upstream_status $req_id'
    enable-access-log-for-default-backend: "true"

    # WebSocket support
    proxy-read-timeout: "3600"
    proxy-send-timeout: "3600"

    # Client settings
    client-header-buffer-size: "16k"
    client-body-buffer-size: "128k"
    large-client-header-buffers: "4 16k"

  # Extra args
  extraArgs:
    default-ssl-certificate: "applyforus/applyforus-tls"
    enable-ssl-passthrough: "false"

  # Metrics
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      namespace: "monitoring"
      interval: 30s
      scrapeTimeout: 10s
      additionalLabels:
        release: prometheus

  # Admission webhooks
  admissionWebhooks:
    enabled: true
    failurePolicy: Fail

# Default backend
defaultBackend:
  enabled: true

  resources:
    requests:
      cpu: 10m
      memory: 32Mi
    limits:
      cpu: 50m
      memory: 64Mi

  replicaCount: 2

  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 65534

  containerSecurityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: true
    seccompProfile:
      type: RuntimeDefault

# RBAC
rbac:
  create: true

# Service Account
serviceAccount:
  create: true
  name: ingress-nginx-controller

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 2

# TCP/UDP services
tcp: {}
udp: {}

# Common labels
commonLabels:
  app.kubernetes.io/part-of: applyforus

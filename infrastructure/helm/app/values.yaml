# ============================================================================
# APPLYFORUS HELM VALUES
# Main application deployment configuration
# ============================================================================

# ============================================================================
# Global Configuration
# ============================================================================
global:
  environment: production
  imageRegistry: applyforusacr.azurecr.io
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []  # Not needed when ACR is attached to AKS

  # Common labels
  labels:
    app.kubernetes.io/part-of: applyforus
    app.kubernetes.io/managed-by: helm

  # Pod security context (applies to all services)
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    seccompProfile:
      type: RuntimeDefault

  # Container security context (applies to all services)
  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 1000
    capabilities:
      drop:
        - ALL

# ============================================================================
# Dependency Charts (Bitnami)
# ============================================================================
postgresql:
  enabled: false  # Use Azure Database for PostgreSQL in production

redis:
  enabled: false  # Use Azure Cache for Redis in production

# ============================================================================
# Service Configurations
# ============================================================================

# ----------------------------------------------------------------------------
# Web Application (Next.js Frontend)
# ----------------------------------------------------------------------------
web:
  enabled: true
  replicaCount: 3

  image:
    repository: applyai-web
    tag: "latest"

  service:
    type: ClusterIP
    port: 80
    targetPort: 3000

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  livenessProbe:
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3

  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 20
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

  env:
    - name: NODE_ENV
      value: "production"
    - name: NEXT_PUBLIC_API_URL
      value: "https://api.applyforus.com"

  nodeSelector:
    nodepool-type: workload

# ----------------------------------------------------------------------------
# Auth Service (NestJS)
# ----------------------------------------------------------------------------
authService:
  enabled: true
  replicaCount: 3

  image:
    repository: applyai-auth-service
    tag: "latest"

  service:
    type: ClusterIP
    port: 8001
    targetPort: 8001

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  livenessProbe:
    httpGet:
      path: /health
      port: 8001
    initialDelaySeconds: 30
    periodSeconds: 10

  readinessProbe:
    httpGet:
      path: /health
      port: 8001
    initialDelaySeconds: 5
    periodSeconds: 5

  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70

  env:
    - name: NODE_ENV
      value: "production"
    - name: PORT
      value: "8001"

  envFrom:
    - secretRef:
        name: auth-service-secrets
    - configMapRef:
        name: applyforus-config

  nodeSelector:
    nodepool-type: workload

# ----------------------------------------------------------------------------
# User Service (NestJS)
# ----------------------------------------------------------------------------
userService:
  enabled: true
  replicaCount: 2

  image:
    repository: applyai-user-service
    tag: "latest"

  service:
    type: ClusterIP
    port: 8002
    targetPort: 8002

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  livenessProbe:
    httpGet:
      path: /health
      port: 8002
    initialDelaySeconds: 30
    periodSeconds: 10

  readinessProbe:
    httpGet:
      path: /health
      port: 8002
    initialDelaySeconds: 5
    periodSeconds: 5

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 8
    targetCPUUtilizationPercentage: 70

  nodeSelector:
    nodepool-type: workload

# ----------------------------------------------------------------------------
# Job Service (NestJS)
# ----------------------------------------------------------------------------
jobService:
  enabled: true
  replicaCount: 3

  image:
    repository: applyai-job-service
    tag: "latest"

  service:
    type: ClusterIP
    port: 8004
    targetPort: 8004

  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  livenessProbe:
    httpGet:
      path: /health
      port: 8004
    initialDelaySeconds: 30
    periodSeconds: 10

  readinessProbe:
    httpGet:
      path: /health
      port: 8004
    initialDelaySeconds: 5
    periodSeconds: 5

  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 15
    targetCPUUtilizationPercentage: 70

  nodeSelector:
    nodepool-type: workload

# ----------------------------------------------------------------------------
# Resume Service (NestJS)
# ----------------------------------------------------------------------------
resumeService:
  enabled: true
  replicaCount: 2

  image:
    repository: applyai-resume-service
    tag: "latest"

  service:
    type: ClusterIP
    port: 8003
    targetPort: 8003

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  livenessProbe:
    httpGet:
      path: /health
      port: 8003
    initialDelaySeconds: 30
    periodSeconds: 10

  readinessProbe:
    httpGet:
      path: /health
      port: 8003
    initialDelaySeconds: 5
    periodSeconds: 5

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 8
    targetCPUUtilizationPercentage: 70

  nodeSelector:
    nodepool-type: workload

# ----------------------------------------------------------------------------
# AI Service (Python/FastAPI)
# ----------------------------------------------------------------------------
aiService:
  enabled: true
  replicaCount: 2

  image:
    repository: applyai-ai-service
    tag: "latest"

  service:
    type: ClusterIP
    port: 8000
    targetPort: 8000

  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 4Gi

  livenessProbe:
    httpGet:
      path: /health
      port: 8000
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 10

  readinessProbe:
    httpGet:
      path: /health
      port: 8000
    initialDelaySeconds: 30
    periodSeconds: 5
    timeoutSeconds: 5

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70

  nodeSelector:
    nodepool-type: workload

# ----------------------------------------------------------------------------
# Analytics Service (NestJS)
# ----------------------------------------------------------------------------
analyticsService:
  enabled: true
  replicaCount: 2

  image:
    repository: applyai-analytics-service
    tag: "latest"

  service:
    type: ClusterIP
    port: 8006
    targetPort: 8006

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  livenessProbe:
    httpGet:
      path: /health
      port: 8006
    initialDelaySeconds: 30
    periodSeconds: 10

  readinessProbe:
    httpGet:
      path: /health
      port: 8006
    initialDelaySeconds: 5
    periodSeconds: 5

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 6
    targetCPUUtilizationPercentage: 70

  nodeSelector:
    nodepool-type: workload

# ----------------------------------------------------------------------------
# Notification Service (NestJS)
# ----------------------------------------------------------------------------
notificationService:
  enabled: true
  replicaCount: 2

  image:
    repository: applyai-notification-service
    tag: "latest"

  service:
    type: ClusterIP
    port: 8007
    targetPort: 8007

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  livenessProbe:
    httpGet:
      path: /health
      port: 8007
    initialDelaySeconds: 30
    periodSeconds: 10

  readinessProbe:
    httpGet:
      path: /health
      port: 8007
    initialDelaySeconds: 5
    periodSeconds: 5

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 6
    targetCPUUtilizationPercentage: 70

  nodeSelector:
    nodepool-type: workload

# ----------------------------------------------------------------------------
# Auto-Apply Service (NestJS + Playwright)
# ----------------------------------------------------------------------------
autoApplyService:
  enabled: true
  replicaCount: 2

  image:
    repository: applyai-auto-apply-service
    tag: "latest"

  service:
    type: ClusterIP
    port: 8005
    targetPort: 8005

  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 4Gi

  livenessProbe:
    httpGet:
      path: /health
      port: 8005
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 10

  readinessProbe:
    httpGet:
      path: /health
      port: 8005
    initialDelaySeconds: 30
    periodSeconds: 5
    timeoutSeconds: 5

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70

  # Chromium requires writable directories
  volumeMounts:
    - name: tmp
      mountPath: /tmp
    - name: cache
      mountPath: /app/.cache
    - name: screenshots
      mountPath: /app/screenshots

  volumes:
    - name: tmp
      emptyDir: {}
    - name: cache
      emptyDir: {}
    - name: screenshots
      emptyDir: {}

  nodeSelector:
    nodepool-type: workload

# ----------------------------------------------------------------------------
# Orchestrator Service (NestJS)
# ----------------------------------------------------------------------------
orchestratorService:
  enabled: true
  replicaCount: 2

  image:
    repository: applyai-orchestrator-service
    tag: "latest"

  service:
    type: ClusterIP
    port: 8008
    targetPort: 8008

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  livenessProbe:
    httpGet:
      path: /health
      port: 8008
    initialDelaySeconds: 30
    periodSeconds: 10

  readinessProbe:
    httpGet:
      path: /health
      port: 8008
    initialDelaySeconds: 5
    periodSeconds: 5

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 6
    targetCPUUtilizationPercentage: 70

  nodeSelector:
    nodepool-type: workload

# ----------------------------------------------------------------------------
# Payment Service (NestJS)
# ----------------------------------------------------------------------------
paymentService:
  enabled: true
  replicaCount: 2

  image:
    repository: applyai-payment-service
    tag: "latest"

  service:
    type: ClusterIP
    port: 8009
    targetPort: 8009

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  livenessProbe:
    httpGet:
      path: /health
      port: 8009
    initialDelaySeconds: 30
    periodSeconds: 10

  readinessProbe:
    httpGet:
      path: /health
      port: 8009
    initialDelaySeconds: 5
    periodSeconds: 5

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 6
    targetCPUUtilizationPercentage: 70

  nodeSelector:
    nodepool-type: workload

# ============================================================================
# Ingress Configuration
# ============================================================================
ingress:
  enabled: true
  className: "nginx"

  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://applyforus.com,https://www.applyforus.com"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"

  hosts:
    - host: applyforus.com
      paths:
        - path: /
          pathType: Prefix
          service: web
          port: 80

    - host: www.applyforus.com
      paths:
        - path: /
          pathType: Prefix
          service: web
          port: 80

    - host: api.applyforus.com
      paths:
        - path: /auth
          pathType: Prefix
          service: auth-service
          port: 8001
        - path: /users
          pathType: Prefix
          service: user-service
          port: 8002
        - path: /jobs
          pathType: Prefix
          service: job-service
          port: 8004
        - path: /resumes
          pathType: Prefix
          service: resume-service
          port: 8003
        - path: /ai
          pathType: Prefix
          service: ai-service
          port: 8000
        - path: /analytics
          pathType: Prefix
          service: analytics-service
          port: 8006
        - path: /notifications
          pathType: Prefix
          service: notification-service
          port: 8007
        - path: /auto-apply
          pathType: Prefix
          service: auto-apply-service
          port: 8005
        - path: /orchestrator
          pathType: Prefix
          service: orchestrator-service
          port: 8008
        - path: /payments
          pathType: Prefix
          service: payment-service
          port: 8009

  tls:
    - secretName: applyforus-tls
      hosts:
        - applyforus.com
        - www.applyforus.com
        - api.applyforus.com

# ============================================================================
# ConfigMap Data
# ============================================================================
configMap:
  data:
    NODE_ENV: "production"
    LOG_LEVEL: "info"
    # Database hosts (Azure PaaS)
    POSTGRES_HOST: "applyforus-postgres.postgres.database.azure.com"
    POSTGRES_PORT: "5432"
    POSTGRES_SSL: "true"
    # Redis hosts (Azure PaaS)
    REDIS_HOST: "applyforus-redis.redis.cache.windows.net"
    REDIS_PORT: "6380"
    REDIS_TLS: "true"
    # Service URLs (K8s internal)
    AI_SERVICE_URL: "http://ai-service.applyforus.svc.cluster.local:8000"
    AUTH_SERVICE_URL: "http://auth-service.applyforus.svc.cluster.local:8001"
    USER_SERVICE_URL: "http://user-service.applyforus.svc.cluster.local:8002"
    RESUME_SERVICE_URL: "http://resume-service.applyforus.svc.cluster.local:8003"
    JOB_SERVICE_URL: "http://job-service.applyforus.svc.cluster.local:8004"
    AUTO_APPLY_SERVICE_URL: "http://auto-apply-service.applyforus.svc.cluster.local:8005"
    ANALYTICS_SERVICE_URL: "http://analytics-service.applyforus.svc.cluster.local:8006"
    NOTIFICATION_SERVICE_URL: "http://notification-service.applyforus.svc.cluster.local:8007"
    ORCHESTRATOR_SERVICE_URL: "http://orchestrator-service.applyforus.svc.cluster.local:8008"
    PAYMENT_SERVICE_URL: "http://payment-service.applyforus.svc.cluster.local:8009"

# ============================================================================
# Pod Disruption Budget
# ============================================================================
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# ============================================================================
# Service Account
# ============================================================================
serviceAccount:
  create: true
  name: "applyforus-sa"
  annotations:
    azure.workload.identity/client-id: ""  # Set to managed identity client ID
  automountServiceAccountToken: false

# ============================================================================
# Network Policies
# ============================================================================
networkPolicy:
  enabled: true

# ============================================================================
# Node Selector (Global)
# ============================================================================
nodeSelector:
  nodepool-type: workload

# ============================================================================
# Tolerations (Global)
# ============================================================================
tolerations: []

# ============================================================================
# Affinity (Global)
# ============================================================================
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/part-of
                operator: In
                values:
                  - applyforus
          topologyKey: kubernetes.io/hostname

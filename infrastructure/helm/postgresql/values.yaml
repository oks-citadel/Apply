# ============================================================================
# BITNAMI POSTGRESQL HELM VALUES
# Chart: bitnami/postgresql
# Version: 15.x (PostgreSQL 16)
# ============================================================================
# For AKS deployment as alternative to Azure Database for PostgreSQL
# Use this for: local development, cost optimization, or multi-cloud portability
# ============================================================================

global:
  postgresql:
    auth:
      postgresPassword: ""  # Set via --set or external secret
      username: "applyforusadmin"
      password: ""          # Set via --set or external secret
      database: "applyforus"
      existingSecret: "postgresql-secrets"
      secretKeys:
        adminPasswordKey: "postgres-password"
        userPasswordKey: "password"
        replicationPasswordKey: "replication-password"

# ============================================================================
# Architecture Configuration
# ============================================================================
architecture: replication

# ============================================================================
# Primary Configuration
# ============================================================================
primary:
  name: primary

  # Persistence - Azure Managed Disks
  persistence:
    enabled: true
    storageClass: "managed-premium"
    size: 32Gi
    accessModes:
      - ReadWriteOnce

  # Resource allocation
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 4Gi

  # Pod Security Context - Non-root execution
  podSecurityContext:
    enabled: true
    fsGroup: 1001

  containerSecurityContext:
    enabled: true
    runAsUser: 1001
    runAsNonRoot: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    seccompProfile:
      type: RuntimeDefault
    readOnlyRootFilesystem: true

  # PostgreSQL configuration tuning
  extendedConfiguration: |
    # Connection settings
    max_connections = 200
    superuser_reserved_connections = 3

    # Memory settings - optimized for 4GB RAM
    shared_buffers = 1GB
    effective_cache_size = 3GB
    work_mem = 32MB
    maintenance_work_mem = 256MB

    # WAL settings
    wal_buffers = 32MB
    min_wal_size = 1GB
    max_wal_size = 4GB
    checkpoint_completion_target = 0.9

    # Query tuning
    random_page_cost = 1.1
    effective_io_concurrency = 200
    default_statistics_target = 100

    # Logging
    log_statement = 'ddl'
    log_min_duration_statement = 1000
    log_checkpoints = on
    log_connections = on
    log_disconnections = on
    log_lock_waits = on

    # SSL/TLS
    ssl = on
    ssl_min_protocol_version = 'TLSv1.3'

    # Autovacuum
    autovacuum = on
    autovacuum_max_workers = 3
    autovacuum_naptime = 60s
    autovacuum_vacuum_threshold = 50
    autovacuum_analyze_threshold = 50

  # pg_hba.conf for authentication
  pgHbaConfiguration: |
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    local   all             all                                     scram-sha-256
    host    all             all             127.0.0.1/32            scram-sha-256
    host    all             all             ::1/128                 scram-sha-256
    host    all             all             10.0.0.0/8              scram-sha-256
    host    replication     all             10.0.0.0/8              scram-sha-256

  # Node affinity for workload nodes
  nodeSelector:
    nodepool-type: workload

  # Tolerations
  tolerations: []

  # Pod anti-affinity for HA
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: postgresql
                app.kubernetes.io/component: primary
            topologyKey: kubernetes.io/hostname

  # Init containers for permissions
  initContainers: []

  # Sidecar containers
  sidecars: []

# ============================================================================
# Read Replicas Configuration
# ============================================================================
readReplicas:
  name: read
  replicaCount: 2

  persistence:
    enabled: true
    storageClass: "managed-premium"
    size: 32Gi

  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 2Gi

  podSecurityContext:
    enabled: true
    fsGroup: 1001

  containerSecurityContext:
    enabled: true
    runAsUser: 1001
    runAsNonRoot: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    seccompProfile:
      type: RuntimeDefault

  nodeSelector:
    nodepool-type: workload

  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: postgresql
                app.kubernetes.io/component: read
            topologyKey: kubernetes.io/hostname

# ============================================================================
# TLS Configuration
# ============================================================================
tls:
  enabled: true
  autoGenerated: true
  # For production, use cert-manager certificates:
  # certificatesSecret: postgresql-tls
  # certFilename: tls.crt
  # certKeyFilename: tls.key
  # certCAFilename: ca.crt

# ============================================================================
# Metrics (Prometheus)
# ============================================================================
metrics:
  enabled: true

  image:
    registry: docker.io
    repository: bitnami/postgres-exporter
    tag: 0.15.0-debian-11-r0
    pullPolicy: IfNotPresent

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 100m
      memory: 128Mi

  serviceMonitor:
    enabled: true
    namespace: "monitoring"
    interval: 30s
    scrapeTimeout: 10s
    labels:
      release: prometheus

  prometheusRule:
    enabled: true
    namespace: "monitoring"
    rules:
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL instance is down"
          description: "PostgreSQL instance {{ $labels.instance }} is down"

      - alert: PostgreSQLHighConnections
        expr: pg_stat_activity_count > 180
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL high connection count"
          description: "PostgreSQL instance {{ $labels.instance }} has {{ $value }} connections"

      - alert: PostgreSQLReplicationLag
        expr: pg_replication_lag > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL replication lag detected"
          description: "PostgreSQL replication lag is {{ $value }} seconds"

# ============================================================================
# Network Policy
# ============================================================================
networkPolicy:
  enabled: true
  allowExternal: false

  ingressRules:
    primaryAccessOnlyFrom:
      enabled: true
      namespaceSelector:
        matchLabels:
          name: applyforus
      podSelector:
        matchLabels:
          app.kubernetes.io/part-of: applyforus

    readReplicasAccessOnlyFrom:
      enabled: true
      namespaceSelector:
        matchLabels:
          name: applyforus
      podSelector:
        matchLabels:
          app.kubernetes.io/part-of: applyforus

  egressRules:
    denyAllExcept:
      enabled: true
      rules:
        - ports:
            - port: 53
              protocol: UDP
            - port: 53
              protocol: TCP

# ============================================================================
# Pod Disruption Budget
# ============================================================================
pdb:
  create: true
  minAvailable: 1

# ============================================================================
# Service Account
# ============================================================================
serviceAccount:
  create: true
  name: "postgresql-sa"
  automountServiceAccountToken: false
  annotations:
    azure.workload.identity/client-id: ""  # Set for workload identity

# ============================================================================
# Backup Configuration (using WAL-G or custom CronJob)
# ============================================================================
backup:
  enabled: false
  # Implement using Velero or custom backup solution
  # See infrastructure/kubernetes/jobs/ for backup CronJobs

# ============================================================================
# Common Labels
# ============================================================================
commonLabels:
  app.kubernetes.io/part-of: applyforus
  app.kubernetes.io/managed-by: helm

# ============================================================================
# Common Annotations
# ============================================================================
commonAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "9187"

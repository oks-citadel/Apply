version: '3.9'

services:
  # Test PostgreSQL Database
  postgres-test:
    image: postgres:15-alpine
    container_name: applyforus-postgres-test
    restart: unless-stopped
    ports:
      - '5433:5432'
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: applyforus_test
      POSTGRES_INITDB_ARGS: '-A md5'
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./infrastructure/docker/postgres/init-test.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - test-network

  # Test Redis Cache
  redis-test:
    image: redis:7-alpine
    container_name: applyforus-redis-test
    restart: unless-stopped
    ports:
      - '6380:6379'
    command: redis-server --appendonly yes --requirepass ""
    volumes:
      - redis_test_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - test-network

  # Test Elasticsearch
  elasticsearch-test:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: applyforus-elasticsearch-test
    restart: unless-stopped
    ports:
      - '9201:9200'
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - 'ES_JAVA_OPTS=-Xms256m -Xmx256m'
    volumes:
      - elasticsearch_test_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:9200/_cluster/health || exit 1']
      interval: 10s
      timeout: 10s
      retries: 5
    networks:
      - test-network

  # Auth Service (Test)
  auth-service-test:
    build:
      context: .
      dockerfile: services/auth-service/Dockerfile
    container_name: applyforus-auth-service-test
    restart: unless-stopped
    ports:
      - '8081:8081'
    environment:
      NODE_ENV: test
      PORT: 8081
      DB_HOST: postgres-test
      DB_PORT: 5432
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      DB_DATABASE: auth_service_test
      REDIS_HOST: redis-test
      REDIS_PORT: 6379
      JWT_SECRET: test-jwt-secret-key
      JWT_EXPIRES_IN: 1h
      JWT_REFRESH_EXPIRES_IN: 7d
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    networks:
      - test-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8081/api/v1/health']
      interval: 10s
      timeout: 5s
      retries: 3

  # User Service (Test)
  user-service-test:
    build:
      context: .
      dockerfile: services/user-service/Dockerfile
    container_name: applyforus-user-service-test
    restart: unless-stopped
    ports:
      - '8082:8082'
    environment:
      NODE_ENV: test
      PORT: 8082
      DB_HOST: postgres-test
      DB_PORT: 5432
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      DB_DATABASE: user_service_test
      AUTH_SERVICE_URL: http://auth-service-test:8081
    depends_on:
      postgres-test:
        condition: service_healthy
      auth-service-test:
        condition: service_healthy
    networks:
      - test-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8082/api/v1/health']
      interval: 10s
      timeout: 5s
      retries: 3

  # Job Service (Test)
  job-service-test:
    build:
      context: .
      dockerfile: services/job-service/Dockerfile
    container_name: applyforus-job-service-test
    restart: unless-stopped
    ports:
      - '8084:8084'
    environment:
      NODE_ENV: test
      PORT: 8084
      DB_HOST: postgres-test
      DB_PORT: 5432
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      DB_DATABASE: job_service_test
      ELASTICSEARCH_NODE: http://elasticsearch-test:9200
      REDIS_HOST: redis-test
      REDIS_PORT: 6379
    depends_on:
      postgres-test:
        condition: service_healthy
      elasticsearch-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    networks:
      - test-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8084/api/v1/health']
      interval: 10s
      timeout: 5s
      retries: 3

  # Resume Service (Test)
  resume-service-test:
    build:
      context: .
      dockerfile: services/resume-service/Dockerfile
    container_name: applyforus-resume-service-test
    restart: unless-stopped
    ports:
      - '8083:8083'
    environment:
      NODE_ENV: test
      PORT: 8083
      DB_HOST: postgres-test
      DB_PORT: 5432
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      DB_DATABASE: resume_service_test
    depends_on:
      postgres-test:
        condition: service_healthy
    networks:
      - test-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8083/api/v1/health']
      interval: 10s
      timeout: 5s
      retries: 3

  # AI Service (Test)
  ai-service-test:
    build:
      context: .
      dockerfile: services/ai-service/Dockerfile
    container_name: applyforus-ai-service-test
    restart: unless-stopped
    ports:
      - '8089:8089'
    environment:
      ENVIRONMENT: test
      PORT: 8089
      OPENAI_API_KEY: ${OPENAI_API_KEY:-test-key}
      REDIS_HOST: redis-test
      REDIS_PORT: 6379
    depends_on:
      redis-test:
        condition: service_healthy
    networks:
      - test-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8089/health']
      interval: 10s
      timeout: 5s
      retries: 3

  # Notification Service (Test)
  notification-service-test:
    build:
      context: .
      dockerfile: services/notification-service/Dockerfile
    container_name: applyforus-notification-service-test
    restart: unless-stopped
    ports:
      - '8087:8087'
    environment:
      NODE_ENV: test
      PORT: 8087
      DB_HOST: postgres-test
      DB_PORT: 5432
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      DB_DATABASE: notification_service_test
      REDIS_HOST: redis-test
      REDIS_PORT: 6379
      SMTP_HOST: mailhog-test
      SMTP_PORT: 1025
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    networks:
      - test-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8087/api/v1/health']
      interval: 10s
      timeout: 5s
      retries: 3

  # Auto-Apply Service (Test)
  auto-apply-service-test:
    build:
      context: .
      dockerfile: services/auto-apply-service/Dockerfile
    container_name: applyforus-auto-apply-service-test
    restart: unless-stopped
    ports:
      - '8085:8085'
    environment:
      NODE_ENV: test
      PORT: 8085
      DB_HOST: postgres-test
      DB_PORT: 5432
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      DB_DATABASE: auto_apply_service_test
      REDIS_HOST: redis-test
      REDIS_PORT: 6379
      JOB_SERVICE_URL: http://job-service-test:8084
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
      job-service-test:
        condition: service_healthy
    networks:
      - test-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8085/api/v1/health']
      interval: 10s
      timeout: 5s
      retries: 3

  # Mailhog for testing email notifications
  mailhog-test:
    image: mailhog/mailhog:latest
    container_name: applyforus-mailhog-test
    restart: unless-stopped
    ports:
      - '1026:1025' # SMTP
      - '8026:8025' # Web UI
    networks:
      - test-network

volumes:
  postgres_test_data:
    driver: local
  redis_test_data:
    driver: local
  elasticsearch_test_data:
    driver: local

networks:
  test-network:
    driver: bridge
